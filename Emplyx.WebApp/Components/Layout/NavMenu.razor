@implements IDisposable

<div class="nav-root d-flex flex-column @(SidebarCollapsed ? "collapsed" : "expanded")">
  <div class="top-row navbar navbar-dark px-2">
    <a class="nav-link nav-link-icon" role="button" title="Menú" aria-label="Menú"
       data-bs-toggle="collapse" data-bs-target=".sidebar-collapse"
       aria-expanded="@(SidebarCollapsed ? "false" : "true")"
       @onclick="OnToggleSidebarCallback">
      <span class="menu-icon bi bi-list" aria-hidden="true"></span>
      <span class="menu-label sidebar-collapse collapse collapse-horizontal @(SidebarCollapsed ? string.Empty : "show")">Menú</span>
    </a>
  </div>

  @if (!isPlataforma)
  {
    <div class="px-2">
      <div class="dropdown company-dropdown @(companyDropdownVisible ? "show" : string.Empty)">
        <button class="w-100 d-flex align-items-center dropdown-toggle sidebar-link" type="button"
                @onclick="ToggleCompanyDropdown" title="@selectedCompany">
          <span class="menu-icon bi bi-house" aria-hidden="true"></span>
          <span class="menu-label sidebar-collapse collapse collapse-horizontal @(SidebarCollapsed ? string.Empty : "show")">@selectedCompany</span>
        </button>
        <ul class="dropdown-menu @(companyDropdownVisible ? "show" : string.Empty)">
          <li><a class="dropdown-item" @onclick='@(() => SelectCompany("Empresa 1"))'><span class="bi bi-house me-2" aria-hidden="true"></span> Empresa 1</a></li>
          <li><a class="dropdown-item" @onclick='@(() => SelectCompany("Empresa 2"))'><span class="bi bi-house me-2" aria-hidden="true"></span> Empresa 2</a></li>
          <li><a class="dropdown-item" @onclick='@(() => SelectCompany("Empresa 3"))'><span class="bi bi-building me-2" aria-hidden="true"></span> Empresa 3</a></li>
        </ul>
      </div>
    </div>
  }

  <hr class="my-2 sidebar-collapse collapse collapse-horizontal @(SidebarCollapsed ? string.Empty : "show")" />

  @if (!isPlataforma && !isConfiguracion)
  {
      <ul class="nav nav-pills flex-column mb-auto px-2">
        <li class="nav-item">
          <NavLink class="nav-link d-flex align-items-center gap-2" ActiveClass="active bg-primary text-white" href="" Match="NavLinkMatch.All" title="Home" data-bs-toggle="tooltip" data-bs-placement="right">
            <span class="menu-icon bi bi-house-door" aria-hidden="true"></span>
            <span class="menu-label sidebar-collapse collapse collapse-horizontal @(SidebarCollapsed ? string.Empty : "show")">Home</span>
          </NavLink>
        </li>
        <li>
          <NavLink class="nav-link d-flex align-items-center gap-2" ActiveClass="active bg-primary text-white" href="counter" title="Counter" data-bs-toggle="tooltip" data-bs-placement="right">
            <span class="menu-icon bi bi-plus-square" aria-hidden="true"></span>
            <span class="menu-label sidebar-collapse collapse collapse-horizontal @(SidebarCollapsed ? string.Empty : "show")">Counter</span>
          </NavLink>
        </li>
        <li>
          <NavLink class="nav-link d-flex align-items-center gap-2" ActiveClass="active bg-primary text-white" href="weather" title="Weather" data-bs-toggle="tooltip" data-bs-placement="right">
            <span class="menu-icon bi bi-list-nested" aria-hidden="true"></span>
            <span class="menu-label sidebar-collapse collapse collapse-horizontal @(SidebarCollapsed ? string.Empty : "show")">Weather</span>
          </NavLink>
        </li>
      </ul>
  }
  else if (isPlataforma)
  {
      <!-- Menu Plataforma (vacio de momento) -->
      <ul class="nav nav-pills flex-column mb-auto px-2">
      </ul>
  }

  else if (isConfiguracion)
  {
      <!-- Menu Configuracion (vacio de momento) -->
      <ul class="nav nav-pills flex-column mb-auto px-2">
      </ul>
  }

  @if (!isPlataforma && !isConfiguracion)
  {
  <div class="mt-auto px-2">
    <ul class="nav nav-pills flex-column">
      <li>
        <NavLink class="nav-link d-flex align-items-center gap-2" ActiveClass="active bg-primary text-white" href="plataforma" title="Plataforma" data-bs-toggle="tooltip" data-bs-placement="right">
          <span class="menu-icon bi bi-columns-gap" aria-hidden="true"></span>
          <span class="menu-label sidebar-collapse collapse collapse-horizontal @(SidebarCollapsed ? string.Empty : "show")">Plataforma</span>
        </NavLink>
      </li>
      <li>
        <NavLink class="nav-link d-flex align-items-center gap-2" ActiveClass="active bg-primary text-white" href="configuracion" title="Configuracion" data-bs-toggle="tooltip" data-bs-placement="right">
          <span class="menu-icon bi bi-gear" aria-hidden="true"></span>
          <span class="menu-label sidebar-collapse collapse collapse-horizontal @(SidebarCollapsed ? string.Empty : "show")">Configuracion</span>
        </NavLink>
      </li>
    </ul>
  </div>
  }

  @if (isPlataforma || isConfiguracion)
  {
  <div class="mt-auto px-2">
    <ul class="nav nav-pills flex-column">
      <li>
        <NavLink class="nav-link d-flex align-items-center gap-2" ActiveClass="" href="/" title="Salir" data-bs-toggle="tooltip" data-bs-placement="right">
          <span class="menu-icon bi bi-box-arrow-left" aria-hidden="true"></span>
          <span class="menu-label sidebar-collapse collapse collapse-horizontal @(SidebarCollapsed ? string.Empty : "show")">Salir</span>
        </NavLink>
      </li>
    </ul>
  </div>
  }
</div>

@code {
    [Inject] private NavigationManager NavigationManager { get; set; } = default!;
    [Parameter] public EventCallback OnToggleSidebar { get; set; }
    [Parameter] public bool SidebarCollapsed { get; set; }

    private bool companyDropdownVisible = false;
    private string selectedCompany = "Empresa 2";
    private bool isPlataforma = false;
    private bool isConfiguracion = false;

    private Task OnToggleSidebarCallback() => OnToggleSidebar.HasDelegate ? OnToggleSidebar.InvokeAsync() : Task.CompletedTask;

    private void ToggleCompanyDropdown()
    {
        companyDropdownVisible = !companyDropdownVisible;
    }

    private void SelectCompany(string company)
    {
        selectedCompany = company;
        companyDropdownVisible = false;
    }

    protected override void OnInitialized()
    {
        UpdateRouteState();
        NavigationManager.LocationChanged += HandleLocationChanged;
    }

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateRouteState();
        InvokeAsync(StateHasChanged);
    }

    private void UpdateRouteState()
    {
        var relative = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        isPlataforma = relative.StartsWith("plataforma", StringComparison.OrdinalIgnoreCase);
        isConfiguracion = relative.StartsWith("configuracion", StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= HandleLocationChanged;
    }
}



