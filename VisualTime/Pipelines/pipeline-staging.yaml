# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

name: Cegid VTI-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
- none

pool:
  name: Private VS2022

# pool:
#   vmImage: windows-latest

parameters:

- name: templates
  displayName: Copy - templates ?
  type: boolean
  default: true
- name: updates
  displayName: Copy - updates ?
  type: boolean
  default: true
- name: reports
  displayName: Copy - reports ?
  type: boolean
  default: true
- name: VTLive
  displayName: Build/Deploy - VTLive ?
  type: boolean
  default: true
- name: VTLiveApi
  displayName: Build/Deploy - VTLiveApi ?
  type: boolean
  default: true
- name: VTPortal
  displayName: Build/Deploy - VTPortal ?
  type: boolean
  default: true
- name: VTTerminals
  displayName: Build/Deploy - VTTerminals ?
  type: boolean
  default: true
- name: VTVisits
  displayName: Build/Deploy - VTVisits ?
  type: boolean
  default: true
- name: fnAnalyticsFunction
  displayName: Build/Deploy - fnAnalyticsFunction ?
  type: boolean
  default: true
- name: fnBackgroundFunction
  displayName: Build/Deploy - fnBackgroundFunction ?
  type: boolean
  default: true
- name: fnBroadcasterFunction
  displayName: Build/Deploy - fnBroadcasterFunction ?
  type: boolean
  default: true
- name: fnDatalinkFunction
  displayName: Build/Deploy - fnDatalinkFunction ?
  type: boolean
  default: true
- name: fnMailFunction
  displayName: Build/Deploy - fnMailFunction ?
  type: boolean
  default: true
- name: fnReportFunction
  displayName: Build/Deploy - fnReportFunction ?
  type: boolean
  default: true
- name: fnScheduleFunction
  displayName: Build/Deploy - fnScheduleFunction ?
  type: boolean
  default: true
- name: fnPushNotificationsFunction
  displayName: Build/Deploy - fnPushNotificationsFunction ?
  type: boolean
  default: true
- name: fnNotificationsFunction
  displayName: Build/Deploy - fnNotificationsFunction ?
  type: boolean
  default: true
- name: fnEngineFunction
  displayName: Build/Deploy - fnEngineFunction ?
  type: boolean
  default: true
- name: fnPunchConnectorFunction
  displayName: Build/Deploy - fnPunchConnectorFunction ?
  type: boolean
  default: true
- name: fnPNlinkFunction
  displayName: Build/Deploy - fnPNlinkFunction ?
  type: boolean
  default: true
- name: fnFTPStorageSyncFunction
  displayName: Build/Deploy - fnFTPStorageSyncFunction ?
  type: boolean
  default: true

variables:
  - name: solution
    value: './Src/VisualTime Full MT.sln'
  - name: testProjects
    value: './Tests/**/*.csproj'
  - name: buildConfiguration
    value: 'Multitennant'
  - name: attachArtifactsToPipeline
    value: true
  - name: forceGenerateLang
    value: false


stages:

  #### Testing
  - template: Templates/Testing.yml

  #### Build
  - template: Templates/Build.yml
    parameters:
      appservices: 
        - project: './Src/VTLive40/VTLive40.vbproj'
          folder: 'VTLive'
          enabled: ${{parameters.VTLive}} 
        - project: './Src/VTLiveApi/VTLiveApi.vbproj'
          folder: 'VTLiveApi'
          enabled: ${{parameters.VTLiveApi}} 
        - project: './Src/VTPortalWeb/VTPortalWeb.vbproj'
          folder: 'VTPortal'
          enabled: ${{parameters.VTPortal}} 
        - project: './Src/VTTerminalsPushServer/TerminalsPushServer.vbproj'
          folder: 'VTTerminals'
          enabled: ${{parameters.VTTerminals}} 
        - project: './Src/LiveVisits/Visits.vbproj'
          folder: 'VTVisits'
          enabled: ${{parameters.VTVisits}} 
      functions: 
        - project: './Src/Functions/roAnalyticsFunctions/roAnalyticsFunctions.csproj'
          folder: 'fnAnalyticsFunction'
          enabled: ${{parameters.fnAnalyticsFunction}} 
        - project: './Src/Functions/roBackgroundFunctions/roBackgroundFunctions.csproj'
          folder: 'fnBackgroundFunction'
          enabled: ${{parameters.fnBackgroundFunction}} 
        - project: './Src/Functions/roBroadcasterFunction/roBroadcasterFunction.csproj'
          folder: 'fnBroadcasterFunction'
          enabled: ${{parameters.fnBroadcasterFunction}} 
        - project: './Src/Functions/roDatalinkFunctions/roDatalinkFunctions.csproj'
          folder: 'fnDatalinkFunction'
          enabled: ${{parameters.fnDatalinkFunction}} 
        - project: './Src/Functions/roMailFunction/roMailFunction.csproj'
          folder: 'fnMailFunction'
          enabled: ${{parameters.fnMailFunction}} 
        - project: './Src/Functions/roReportFunctions/roReportFunctions.csproj'
          folder: 'fnReportFunction'
          enabled: ${{parameters.fnReportFunction}} 
        - project: './Src/Functions/roScheduleFunctions/roScheduleFunctions.csproj'
          folder: 'fnScheduleFunction'
          enabled: ${{parameters.fnScheduleFunction}} 
        - project: './Src/Functions/roNotificationsFunction/roNotificationsFunction.csproj'
          folder: 'fnNotificationsFunction'
          enabled: ${{parameters.fnNotificationsFunction}} 
        - project: './Src/Functions/roPushNotificationsFunction/roPushNotificationsFunction.csproj'
          folder: 'fnPushNotificationsFunction'
          enabled: ${{parameters.fnPushNotificationsFunction}} 
        - project: './Src/Functions/roEngineFunctions/roEngineFunctions.csproj'
          folder: 'fnEngineFunction'
          enabled: ${{parameters.fnEngineFunction}} 
        - project: './Src/Functions/roPunchConnectorFunctions/roPunchConnectorFunctions.csproj'
          folder: 'fnPunchConnectorFunction'
          enabled: ${{parameters.fnPunchConnectorFunction}} 
        - project: './Src/Functions/roSCFunction/roSCFunction.csproj'
          folder: 'fnpnlinkfunction'
          enabled: ${{parameters.fnPNlinkFunction}}
        - project: './Src/Functions/roFTPStorageSynchronizationFunction/roFTPStorageSynchronizationFunction.csproj'
          folder: 'fnFTPStorageSyncFunction'
          enabled: ${{parameters.fnFTPStorageSyncFunction}}
      generateLang: false
      uploadArtifact: ${{ variables.attachArtifactsToPipeline }}
      copyTemplates: ${{parameters.templates}} 
      copyUpdates: ${{parameters.updates}} 
      copyReports: ${{parameters.reports}} 
      sonarcloudAnalysis: false 

  #### Push to Artifactory
  - template: Templates/PublishToArtifactory.yml
    parameters:
      artifactoryService: ArtifactoryCloudV2-VisualTime
      artifactoryTargetName: vti-software-staging
      artifactoryBuildName: $(Build.DefinitionName)
      artifacts: 
        - name: 'VTLive'
          artifactoryFolderName: 'VT_Live'
          zip: 'VTLive.zip'
          enabled: ${{parameters.VTLive}} 
        - name: 'VTLiveApi'
          artifactoryFolderName: 'VT_LiveApi'
          zip: 'VTLiveApi.zip'
          enabled: ${{parameters.VTLiveApi}} 
        - name: 'VTPortal'
          artifactoryFolderName: 'VT_Portal'
          zip: 'VTPortal.zip'
          enabled: ${{parameters.VTPortal}} 
        - name: 'VTTerminals'
          artifactoryFolderName: 'VT_Terminals'
          zip: 'VTTerminals.zip'
          enabled: ${{parameters.VTTerminals}} 
        - name: 'VTVisits'
          artifactoryFolderName: 'VT_Visits'
          zip: 'VTVisits.zip'
          enabled: ${{parameters.VTVisits}} 
        - name: 'fnAnalyticsFunction'
          artifactoryFolderName: 'FN_AnalyticsFunction'
          zip: 'fnAnalyticsFunction.zip'
          enabled: ${{parameters.fnAnalyticsFunction}} 
        - name: 'fnBackgroundFunction'
          artifactoryFolderName: 'FN_BackgroundFunction'
          zip: 'fnBackgroundFunction.zip'
          enabled: ${{parameters.fnBackgroundFunction}} 
        - name: 'fnBroadcasterFunction'
          artifactoryFolderName: 'FN_BroadcasterFunction'
          zip: 'fnBroadcasterFunction.zip'
          enabled: ${{parameters.fnBroadcasterFunction}} 
        - name: 'fnDatalinkFunction'
          artifactoryFolderName: 'FN_DatalinkFunction'
          zip: 'fnDatalinkFunction.zip'
          enabled: ${{parameters.fnDatalinkFunction}} 
        - name: 'fnMailFunction'
          artifactoryFolderName: 'FN_MailFunction'
          zip: 'fnMailFunction.zip'
          enabled: ${{parameters.fnMailFunction}} 
        - name: 'fnReportFunction'
          artifactoryFolderName: 'FN_ReportFunction'
          zip: 'fnReportFunction.zip'
          enabled: ${{parameters.fnReportFunction}} 
        - name: 'fnScheduleFunction'
          artifactoryFolderName: 'FN_ScheduleFunction'
          zip: 'fnScheduleFunction.zip'
          enabled: ${{parameters.fnScheduleFunction}} 
        - name: 'fnNotificationsFunction'
          artifactoryFolderName: 'FN_NotificationsFunction'
          zip: 'fnNotificationsFunction.zip'
          enabled: ${{parameters.fnNotificationsFunction}} 
        - name: 'fnPushNotificationsFunction'
          artifactoryFolderName: 'FN_PushNotificationsFunction'
          zip: 'fnPushNotificationsFunction.zip'
          enabled: ${{parameters.fnPushNotificationsFunction}} 
        - name: 'fnEngineFunction'
          artifactoryFolderName: 'FN_EngineFunction'
          zip: 'fnEngineFunction.zip'
          enabled: ${{parameters.fnEngineFunction}} 
        - name: 'fnPunchConnectorFunction'
          artifactoryFolderName: 'FN_PunchConnectorFunction'
          zip: 'fnPunchConnectorFunction.zip'
          enabled: ${{parameters.fnPunchConnectorFunction}} 
        - name: 'fnPNlinkFunction'
          artifactoryFolderName: 'FN_PNlinkFunction'
          zip: 'fnpnlinkfunction.zip'
          enabled: ${{parameters.fnPNlinkFunction}}
        - name: 'fnFTPStorageSyncFunction'
          artifactoryFolderName: 'FN_FTPStorageSyncFunction'
          zip: 'fnftpstoragesyncfunction.zip'
          enabled: ${{parameters.fnFTPStorageSyncFunction}}
        - name: 'reports'
          artifactoryFolderName: 'Common_reports'
          zip: 'reports.zip'
          enabled: ${{parameters.reports}} 
        - name: 'updates'
          artifactoryFolderName: 'Common_updates'
          zip: 'updates.zip'
          enabled: ${{parameters.updates}} 
        - name: 'templates'
          artifactoryFolderName: 'Common_templates'
          zip: 'templates.zip'
          enabled: ${{parameters.templates}} 

  #### Deploy to staging env azure
  - template: Templates/DeployAzureUnifiedStaging.yml
    parameters:
      slot: staging
      resourceGroup: 'mtpaaspr'
      azureService: SAAS-VisualTime-InfraDeployment
      environment: staging
      artifactoryService: ArtifactoryCloudV2-VisualTime
      artifactoryTargetName: vti-software-staging
      artifactoryBuildName: $(Build.DefinitionName)
      artifacts: 
        - name: 'VTLive'
          artifactoryFolderName: 'VT_Live'
          zip: 'VTLive.zip'
          destination: 'vtlivePr'
          enabled: ${{parameters.VTLive}} 
          type: 'webapp'
        - name: 'VTLiveApi'
          artifactoryFolderName: 'VT_LiveApi'
          zip: 'VTLiveApi.zip'
          destination: 'vtliveapiPr'
          enabled: ${{parameters.VTLiveApi}} 
          type: 'webapp'
        - name: 'VTPortal'
          artifactoryFolderName: 'VT_Portal'
          zip: 'VTPortal.zip'
          destination: 'vtportalPr'
          enabled: ${{parameters.VTPortal}}
          type: 'webapp'
        - name: 'VTTerminals'
          artifactoryFolderName: 'VT_Terminals'
          zip: 'VTTerminals.zip'
          destination: 'vtterminalsPr'
          enabled: ${{parameters.VTTerminals}}
          type: 'webapp'
        - name: 'VTVisits'
          artifactoryFolderName: 'VT_Visits'
          zip: 'VTVisits.zip'
          destination: 'vtvisitsPr'
          enabled: ${{parameters.VTVisits}}
          type: 'webapp'
        - name: 'fnAnalyticsFunction'
          artifactoryFolderName: 'FN_AnalyticsFunction'
          zip: 'fnAnalyticsFunction.zip'
          destination: 'fnAnalyticsFunctionPr'
          enabled: ${{parameters.fnAnalyticsFunction}}
          type: 'funapp'
        - name: 'fnBackgroundFunction'
          artifactoryFolderName: 'FN_BackgroundFunction'
          zip: 'fnBackgroundFunction.zip'
          destination: 'fnBackgroundFunctionPr'
          enabled: ${{parameters.fnBackgroundFunction}}
          type: 'funapp'
        - name: 'fnBroadcasterFunction'
          artifactoryFolderName: 'FN_BroadcasterFunction'
          zip: 'fnBroadcasterFunction.zip'
          destination: 'fnBroadcasterFunctionPr'
          enabled: ${{parameters.fnBroadcasterFunction}}
          type: 'funapp'
        - name: 'fnDatalinkFunction'
          artifactoryFolderName: 'FN_DatalinkFunction'
          zip: 'fnDatalinkFunction.zip'
          destination: 'fnDatalinkFunctionPr'
          enabled: ${{parameters.fnDatalinkFunction}}
          type: 'funapp'
        - name: 'fnMailFunction'
          artifactoryFolderName: 'FN_MailFunction'
          zip: 'fnMailFunction.zip'
          destination: 'fnMailFunctionPr'
          enabled: ${{parameters.fnMailFunction}}
          type: 'funapp'
        - name: 'fnReportFunction'
          artifactoryFolderName: 'FN_ReportFunction'
          zip: 'fnReportFunction.zip'
          destination: 'fnReportFunctionPr'
          enabled: ${{parameters.fnReportFunction}}
          type: 'funapp'
        - name: 'fnScheduleFunction'
          artifactoryFolderName: 'FN_ScheduleFunction'
          zip: 'fnScheduleFunction.zip'
          destination: 'fnScheduleFunctionPr'
          enabled: ${{parameters.fnScheduleFunction}}
          type: 'funapp'
        - name: 'fnPushNotificationsFunction'
          artifactoryFolderName: 'FN_PushNotificationsFunction'
          zip: 'fnPushNotificationsFunction.zip'
          destination: 'fnPushNotificationsFunctionPr'
          enabled: ${{parameters.fnPushNotificationsFunction}}
          type: 'funapp'
        - name: 'fnNotificationsFunction'
          artifactoryFolderName: 'FN_NotificationsFunction'
          zip: 'fnNotificationsFunction.zip'
          destination: 'fnNotificationFunctionPr'
          enabled: ${{parameters.fnNotificationsFunction}}
          type: 'funapp'
        - name: 'fnEngineFunction'
          artifactoryFolderName: 'FN_EngineFunction'
          zip: 'fnEngineFunction.zip'
          destination: 'fnengineFunctionPr'
          enabled: ${{parameters.fnEngineFunction}}
          type: 'funapp'
        - name: 'fnPunchConnectorFunction'
          artifactoryFolderName: 'FN_PunchConnectorFunction'
          zip: 'fnPunchConnectorFunction.zip'
          destination: 'fnpunchconnectorFunctionPr'
          enabled: ${{parameters.fnPunchConnectorFunction}}
          type: 'funapp'
        - name: 'fnPNLinkFunction'
          artifactoryFolderName: 'FN_PNlinkFunction'
          zip: 'fnpnlinkfunction.zip'
          destination: 'fnPNlinkFunctionPr'
          enabled: ${{parameters.fnPNlinkFunction}}
          type: 'funapp'
        - name: 'fnFTPStorageSyncFunction'
          artifactoryFolderName: 'FN_FTPStorageSyncFunction'
          zip: 'fnftpstoragesyncfunction.zip'
          destination: 'fnFTPStorageSyncPr'
          enabled: ${{parameters.fnFTPStorageSyncFunction}}
          type: 'funapp'
      resources:
        - name: 'reports'
          artifactoryFolderName: 'Common_reports'
          storageAccountName: 'rsstagingstorage'
          zip: 'reports.zip'
          container: 'upgrade'
          folder: 'reports'
          pattern: '*.sql;*.vtu'
          enabled: ${{parameters.reports}}
        - name: 'updates'
          artifactoryFolderName: 'Common_updates'
          storageAccountName: 'rsstagingstorage'
          zip: 'updates.zip'
          container: 'upgrade'
          folder: 'updates'
          pattern: '*.sql;*.vtu'
          enabled: ${{parameters.updates}}
      resourcesDatalink:
        - name: 'templates'
          artifactoryFolderName: 'Common_templates'
          storageAccountName: 'rsstagingdatalinksto'
          zip: 'templates.zip'
          container: 'datalink'
          pattern: '*.xlsx;*.vtu'
          folder: 'common_templates'
          enabled: ${{parameters.templates}}
  
  - template: Templates/PromoteArtifactory.yml
    parameters:
      environment: staging
      artifactoryService: ArtifactoryCloudV2-VisualTime
      artifactoryTargetRepo: vti-software-production
      artifactoryBuildName: $(Build.DefinitionName)
      artifacts: 
        - name: 'VTLive'
          artifactoryFolderName: 'VT_Live'
          zip: 'VTLive.zip'
          enabled: ${{parameters.VTLive}} 
        - name: 'VTLiveApi'
          artifactoryFolderName: 'VT_LiveApi'
          zip: 'VTLiveApi.zip'
          enabled: ${{parameters.VTLiveApi}} 
        - name: 'VTPortal'
          artifactoryFolderName: 'VT_Portal'
          zip: 'VTPortal.zip'
          enabled: ${{parameters.VTPortal}} 
        - name: 'VTTerminals'
          artifactoryFolderName: 'VT_Terminals'
          zip: 'VTTerminals.zip'
          enabled: ${{parameters.VTTerminals}} 
        - name: 'VTVisits'
          artifactoryFolderName: 'VT_Visits'
          zip: 'VTVisits.zip'
          enabled: ${{parameters.VTVisits}} 
        - name: 'fnAnalyticsFunction'
          artifactoryFolderName: 'FN_AnalyticsFunction'
          zip: 'fnAnalyticsFunction.zip'
          enabled: ${{parameters.fnAnalyticsFunction}} 
        - name: 'fnBackgroundFunction'
          artifactoryFolderName: 'FN_BackgroundFunction'
          zip: 'fnBackgroundFunction.zip'
          enabled: ${{parameters.fnBackgroundFunction}} 
        - name: 'fnBroadcasterFunction'
          artifactoryFolderName: 'FN_BroadcasterFunction'
          zip: 'fnBroadcasterFunction.zip'
          enabled: ${{parameters.fnBroadcasterFunction}} 
        - name: 'fnDatalinkFunction'
          artifactoryFolderName: 'FN_DatalinkFunction'
          zip: 'fnDatalinkFunction.zip'
          enabled: ${{parameters.fnDatalinkFunction}} 
        - name: 'fnMailFunction'
          artifactoryFolderName: 'FN_MailFunction'
          zip: 'fnMailFunction.zip'
          enabled: ${{parameters.fnMailFunction}} 
        - name: 'fnReportFunction'
          artifactoryFolderName: 'FN_ReportFunction'
          zip: 'fnReportFunction.zip'
          enabled: ${{parameters.fnReportFunction}} 
        - name: 'fnScheduleFunction'
          artifactoryFolderName: 'FN_ScheduleFunction'
          zip: 'fnScheduleFunction.zip'
          enabled: ${{parameters.fnScheduleFunction}} 
        - name: 'fnNotificationsFunction'
          artifactoryFolderName: 'FN_NotificationsFunction'
          zip: 'fnNotificationsFunction.zip'
          enabled: ${{parameters.fnNotificationsFunction}} 
        - name: 'fnPushNotificationsFunction'
          artifactoryFolderName: 'FN_PushNotificationsFunction'
          zip: 'fnPushNotificationsFunction.zip'
          enabled: ${{parameters.fnPushNotificationsFunction}} 
        - name: 'fnEngineFunction'
          artifactoryFolderName: 'FN_EngineFunction'
          zip: 'fnEngineFunction.zip'
          enabled: ${{parameters.fnEngineFunction}} 
        - name: 'fnPunchConnectorFunction'
          artifactoryFolderName: 'FN_PunchConnectorFunction'
          zip: 'fnPunchConnectorFunction.zip'
          enabled: ${{parameters.fnPunchConnectorFunction}} 
        - name: 'fnPNlinkFunction'
          artifactoryFolderName: 'FN_PNlinkFunction'
          zip: 'fnpnlinkfunction.zip'
          enabled: ${{parameters.fnPNlinkFunction}} 
        - name: 'fnFTPStorageSyncFunction'
          artifactoryFolderName: 'FN_FTPStorageSyncFunction'
          zip: 'fnftpstoragesyncfunction.zip'
          enabled: ${{parameters.fnFTPStorageSyncFunction}} 
        - name: 'reports'
          artifactoryFolderName: 'Common_reports'
          zip: 'reports.zip'
          enabled: ${{parameters.reports}} 
        - name: 'updates'
          artifactoryFolderName: 'Common_updates'
          zip: 'updates.zip'
          enabled: ${{parameters.updates}} 
        - name: 'templates'
          artifactoryFolderName: 'Common_templates'
          zip: 'templates.zip'
          enabled: ${{parameters.templates}} 

  #### Tag version
  - template: Templates/TagVersion.yml
  