function ensureInitialized(){return initializationPromise||(initializationPromise=(async()=>{try{await loadUserFields()}catch(n){DevExpress.ui.notify("Error cr�tico de inicializaci�n. Por favor, recargue la p�gina.","error",0);throw n;}})()),initializationPromise}function setupNavigationProtectionEverything(){window.addEventListener("beforeunload",function(n){if(window.sectionHasChanges("Collectives")||window.sectionHasChanges("CollectivesDefinition")){const t="No has guardado cambios en el colectivo. �Seguro que desea salir?";return setTimeout(function(){hideLoading()},100),n.returnValue=t,t}})}function exportEmployeesGrid(n){var t=new ExcelJS.Workbook,r=t.addWorksheet("Main sheet"),i;i="collectiveEmployees_"+(currentCollectiveView.Name||"UnnamedCollective")+"_"+moment(currentCollectiveDefinition.BeginDate).format(shortFormat)+"_"+moment().format("YYYYMMDD");DevExpress.excelExporter.exportDataGrid({worksheet:r,component:n.component,customizeCell:function(n){n.excelCell.font={name:"Arial",size:11};n.excelCell.alignment={horizontal:"left"}}}).then(function(){t.xlsx.writeBuffer().then(function(n){saveAs(new Blob([n],{type:"application/octet-stream"}),i+".xlsx")})})}function setupNavigationProtection(){document.addEventListener("keydown",function(n){(n.key==="F5"||n.keyCode===116)&&(window.sectionHasChanges("Collectives")||window.sectionHasChanges("CollectivesDefinition"))&&(n.preventDefault(),confirm("No has guardado cambios en el colectivo. "+String.fromCharCode(191)+"Seguro que desea salir?")?window.location.reload():setTimeout(function(){hideLoading()},100))});window.addEventListener("beforeunload",function(n){if((n.clientY<0||n.altKey||n.ctrlKey||n.metaKey||n.clientX>window.innerWidth)&&(window.sectionHasChanges("Collectives")||window.sectionHasChanges("CollectivesDefinition"))){const t="No has guardado cambios en el colectivo. "+String.fromCharCode(191)+"Seguro que desea salir?";return setTimeout(function(){hideLoading()},100),n.returnValue=t,t}})}function hideLoading(){}function initializeEmployeesPopup(){employeesPopupInstance||(employeesPopupInstance=$("#employeesPopup").dxPopup({title:"",visible:!1,hideOnOutsideClick:!0,showCloseButton:!0,width:800,height:775,contentTemplate:function(n){n.empty();$("<div>").attr("id","employeesDatagridPopup").appendTo(n).dxDataGrid({columns:[{dataField:"EmployeeName",caption:getTextFromCatalog(window.Collectives.i18n,"roCollectives_EmployeeName","Collectives")},{dataField:"Group",caption:getTextFromCatalog(window.Collectives.i18n,"roCollectives_Group","Collectives"),groupCellTemplate:function(n,t){n.text(t.value)}}],filterRow:{visible:!0,applyFilter:"auto"},headerFilter:{visible:!0},allowColumnReordering:!0,showBorders:!0,height:675,groupPanel:{visible:!0},sorting:{mode:"multiple"},paging:{pageSize:15},selection:{mode:"multiple",selectAllMode:"allPages",showCheckBoxesMode:"none"},"export":{enabled:!0,fileName:"EmpleadosColectivo_"+moment().format("YYYYMMDD"),allowExportSelectedData:!1},summary:{groupItems:[{column:"EmployeeName",summaryType:"count",displayFormat:getTextFromCatalog(window.Collectives.i18n,"roCollectives_EmployeesDataGrid_GroupCount","Collectives")+": {0}",showInGroupFooter:!0,alignByColumn:!0,alignment:"right"}],totalItems:[{column:"EmployeeName",summaryType:"count",displayFormat:getTextFromCatalog(window.Collectives.i18n,"roCollectives_EmployeesDataGrid_TotalCount","Collectives")+": {0}",alignment:"left"}]},dataSource:[],onExporting:exportEmployeesGrid})}}).dxPopup("instance"))}async function initializeFilterBuilder(n){filterBuilderInstance=$("#filterBuilder").dxFilterBuilder({fields:n,value:filter,onValueChanged:changeCollectiveDefinitionFilter,onInitialized:updateTexts,onContentReady:contentReadyFilter,customOperations:[createTimeAgoOperation("timeAgoMoreThan","roTimeAgoMoreThanOperation","<"),createTimeAgoOperation("timeAgoLessThan","roTimeAgoLessThanOperation",">"),createTimeAgoOperation("timeAgoMoreOrEqualThan","roTimeAgoMoreOrEqualThanOperation","<="),createTimeAgoOperation("timeAgoLessOrEqualThan","roTimeAgoLessOrEqualThanOperation",">="),{name:"anyof",caption:viewUtilsManager.DXTranslate("roAnyOfOperation"),icon:"check",editorTemplate(n){return $("<div>").dxTagBox({value:n.value,items:n.field.lookup.dataSource||[],inputAttr:{"aria-label":viewUtilsManager.DXTranslate("roAnyOfCaptionOperation")},onValueChanged(t){n.setValue(t.value&&t.value.length?t.value:null)},width:"350px"})},calculateFilterExpression(n,t){return n&&n.length&&Array.prototype.concat.apply([],n.map(n=>[[t.dataField,"=",n],"or"])).slice(0,-1)}},{name:"anniversary",caption:viewUtilsManager.DXTranslate("roAnniversaryOperation"),icon:"check",hasValue:!1,calculateFilterExpression(n,t){return[[t.dataField,"=","anniversary"]]}}]}).dxFilterBuilder("instance")}function createTimeAgoOperation(n,t,i){return{name:n,caption:viewUtilsManager.DXTranslate(t),icon:"event",dataTypes:["date"],editorTemplate(n){const i=$("<div>").dxNumberBox({value:n.value?.quantity||null,min:1,max:1200,showSpinButtons:!0,onValueChanged(i){n.value||(n.value={});i.value?(n.value.quantity=i.value,n.setValue(n.value),t.dxSelectBox("instance").option("disabled",!1)):(delete n.value.quantity,n.setValue(n.value),t.dxSelectBox("instance").option("disabled",!0))},width:"100px"}),t=$("<div>").dxSelectBox({items:[{id:"days",text:viewUtilsManager.DXTranslate("roTimeAgoDayUnitDay")},{id:"weeks",text:viewUtilsManager.DXTranslate("roTimeAgoDayUnitWeek")},{id:"months",text:viewUtilsManager.DXTranslate("roTimeAgoDayUnitMonth")},{id:"years",text:viewUtilsManager.DXTranslate("roTimeAgoDayUnitYear")}],value:n.value?.unit||null,displayExpr:"text",valueExpr:"id",inputAttr:{"aria-label":viewUtilsManager.DXTranslate("roTimeAgoCaptionOperation")},disabled:!n.value?.quantity,onValueChanged(t){n.value||(n.value={});n.value.unit=t.value;n.value.unittext=getTimeAgoUnit(t.value);n.setValue(n.value)}});return $("<div>").append(i).append(t)},customizeText(n){return!n||!n.value.quantity||!n.value.unit?null:`${n.value.quantity} ${n.value.unittext}`},calculateFilterExpression(n,t){return!n||!n.quantity||!n.unit?null:[[t.dataField,i,n.quantity+"*"+n.unit+"*timeAgo"]]}}}function getTimeAgoUnit(n){switch(n){case"days":return viewUtilsManager.DXTranslate("roTimeAgoDayUnitDay");case"weeks":return viewUtilsManager.DXTranslate("roTimeAgoDayUnitWeek");case"months":return viewUtilsManager.DXTranslate("roTimeAgoDayUnitMonth");case"years":return viewUtilsManager.DXTranslate("roTimeAgoDayUnitYear");default:return null}}function contentReadyFilter(){let n=document.querySelectorAll(".dx-filterbuilder-text.dx-filterbuilder-item-value > .dx-filterbuilder-item-value-text");n.forEach(n=>{let t=n.textContent;t.includes("00:00.000Z")&&(n.textContent=moment(n.textContent).format(shortFormat))})}function updateTexts(n){const t=humanizeFilterExpression(n.component.option("value")).replace(/\r\n/g,"<br>");t.trim()===""?$("#filterText").html("").css("opacity",0):$("#filterText").html(t).css("opacity",1);$("#filterText").html(t);$("#dataSourceText").text(formatValue(n.component.getFilterExpression()))}function formatValue(n,t=TAB_SIZE){return n&&Array.isArray(n[0])?`[${getLineBreak(t)}${n.map(n=>Array.isArray(n[0])?formatValue(n,t+TAB_SIZE):JSON.stringify(n)).join(`,${getLineBreak(t)}`)}${getLineBreak(t-TAB_SIZE)}]`:JSON.stringify(n)}function getLineBreak(n){return`
${new Array(n+1).join(" ")}`}function humanizeFilterExpression(n){function i(n){const t=u[n],r=new Set(["and","or","notAnd","notOr"]),i=r.has(n)?"\r\n":"";if(t){const n=viewUtilsManager.DXTranslate(t);if(n&&n!==t)return i+n}return i+n}function f(n,t){return n===null||n===undefined?"":typeof n=="string"&&(n.includes("00:00.000Z")||n.includes("00:00:00 GMT"))||typeof n=="object"&&(n.toString().includes("00:00.000Z")||n.toString().includes("00:00:00 GMT"))?moment(n).format(shortFormat):typeof n=="object"&&n.quantity&&n.unit?`${n.quantity} ${n.unittext||getTimeAgoUnit(n.unit)}`:Array.isArray(n)?t=="anyof"?"("+n.join(" "+viewUtilsManager.DXTranslate("roLogicOr")+" ")+")":n.join(" "+viewUtilsManager.DXTranslate("roLogicAnd")+" "):n}function r(n){if(!Array.isArray(n))return i(n);if(Array.isArray(n[0])||Array.isArray(n[1])){const t=n.map(n=>Array.isArray(n)?r(n):i(n)).join(" ");return`(${t})`}const u=n[0],t=n[1],e=f(n[2],t);return t==="anniversary"?`${i(t)} ${u}`:`${u} ${i(t)} ${e}`}if(!n||!Array.isArray(n)||n.length===0)return"";const u={and:"roLogicAnd",or:"roLogicOr",notAnd:"roLogicNotAnd",notOr:"roLogicNotOr","!":"roComparisonNot","=":"roComparisonEqual","<>":"roComparisonNotEqual",">":"roComparisonGreaterThan",">=":"roComparisonGreaterOrEqual","<":"roComparisonLessThan","<=":"roComparisonLessOrEqual",startswith:"roComparisonStartsWith",endswith:"roComparisonEndsWith",contains:"roComparisonContains",notcontains:"roComparisonNotContains",anyof:"roComparisonAnyOf",between:"roComparisonBetween",anniversary:"roTimeAnniversaryYear",timeAgoMoreThan:"roTimeAgoMoreThan",timeAgoLessThan:"roTimeAgoLessThan",timeAgoMoreOrEqualThan:"roTimeAgoMoreOrEqual",timeAgoLessOrEqualThan:"roTimeAgoLessOrEqual"};let t=r(n);if(t.startsWith("(")&&t.endsWith(")")){let n=0,i=!0;for(let r=0;r<t.length;r++)if(t[r]==="("?n++:t[r]===")"&&n--,n===0&&r<t.length-1){i=!1;break}i&&(t=t.substring(1,t.length-1))}return t.length>0&&(t=t.charAt(0).toUpperCase()+t.substring(1)),t}function findMissingUserFields(n){if(!n||!Array.isArray(n)||n.length===0)return[];const t=[];if(n.length===3&&typeof n[0]=="string"&&typeof n[1]=="string"){const i=n[0];return userFields.find(n=>n.dataField===i)||t.push(i),t}return n.forEach(n=>{if(Array.isArray(n)){const i=findMissingUserFields(n);t.push(...i)}}),t}function validateModel(n){return n.Name==null||!n.Name?(DevExpress.ui.notify(viewUtilsManager.DXTranslate("roCollectiveWithoutName"),"error",2e3),!1):!0}function isEmpty(n){for(const t in n)if(Object.hasOwn(n,t))return!1;return!0}function setupSaveCollectiveTooltip(){const n=$("#Collectives_btnSaveEntity");if(n&&n.length!==0){const t="saveCollectiveTooltip";$("#"+t).length===0&&$("body").append(`<div id="${t}"></div>`);const r="Recuerda guardar el colectivo para no perder los cambios",i=$("#"+t).dxTooltip({target:n,position:"bottom",arrowPosition:"top",contentTemplate:function(){return $("<div>").css({textAlign:"center",color:"#495057",fontSize:"13px",display:"flex"}).html(`
                    <i class="dx-icon dx-icon-warning" style="margin-right:10px; font-size:18px; color:#e65c00;"></i>
                    <span>${r}</span>
                `)},animation:{show:{type:"fade",duration:200,from:0,to:1},hide:{type:"fade",duration:200,from:1,to:0}},closeOnOutsideClick:!1,visible:!1,shading:!1,hideOnParentScroll:!1}).dxTooltip("instance");window.saveCollectiveTooltip=i;i&&i.show()}}function getEffectiveUIDate(){let i=currentCollectiveDefinition.EndDate,n=currentCollectiveDefinition.BeginDate,t=new DateManager(new Date,"UTC").startOf("day").toISOString(),r;return r=n!==undefined?moment(n)>=moment(t)?n:i!==undefined?moment(i)>moment(t)?t:i:n:t,{apiDate:r}}let currentCollectiveView={},originalCollectiveView={},userFields=[],removedUserFields=[],filterBuilderInstance=null,dataGridHistoric=null,currentCollectiveDefinition={},isProcessingHistoryItemClick=!1,isNewlyCreatedDefinition=!1,employeesPopupInstance=null,locale="es",shortFormat=getDateLocalizationFormats().moment,initializationPromise=null,dataGridsInitialized=!1;const filter=[],TAB_SIZE=4;(function(){var n=null;$(document).ready(async function(){viewUtilsManager.initAccordions();viewUtilsManager.setupCardListFilterButton("Collectives");viewUtilsManager.print("Collectives Module loaded");n=viewUtilsManager.createViewStateHandler();locale=JSON.parse(localStorage.getItem("roLanguage")).key;DevExpress.localization.locale(locale);window.loadRequest=loadCollective;window.loadUserFields=loadUserFields;window.saveData=saveData;window.deleteCurrentCollective=deleteCurrentCollective;window.refreshCardTree=viewUtilsManager.refreshCardTree;window.unselectCards=viewUtilsManager.unselectCards;window.filterBuilderInstance=filterBuilderInstance;window.dataGridHistoric=dataGridHistoric;window.Collectives_save=saveData;window.Collectives_close=null;window.Collectives_delete=deleteCurrentCollective;window.Collectives_undo=initializeCollectiveData;window.CollectivesDefinition_save=saveDataDefinition;window.CollectivesDefinition_close=null;window.CollectivesDefinition_delete=deleteCurrentCollectiveDefinition;window.CollectivesDefinition_undo=undoCollectiveDefinition;window.CollectivesDefinition_visualize=clickVisualizeEmployees;window.collectiveHistoricGrid_OnHistoryItemClick=clickHictoricEntry;window.collectiveHistoricGrid_OnNewClick=clickNewHistoricEntry;document.addEventListener("startStateEvent",n=>viewHandlerEvent(n),!1);n.transition(n.value,"read");$("#divNewButton").prependTo("#divTree");setDeleteStatus("Collectives",!1);viewUtilsManager.loadViewOptions("Collectives","read",async function(){try{await ensureInitialized();initializeEmployeesPopup();setupNavigationProtection();viewUtilsManager.getSelectedCardId()?await loadCollective():(checkDisabledButtons(!0),checkDisabledDefinitionButtons(!0),setDeleteStatus("Collectives",!1),setDeleteStatus("CollectivesDefinition",!1),$("#CardView_DXMainTable .dxcvCard").length>0?$("#CardView_DXMainTable .dxcvCard")[0].click():await newCollective())}catch(n){}},()=>{},"LiveCollectives")})})();const initializeDataGrids=()=>{if(dataGridsInitialized)return Promise.resolve();try{return new Promise(n=>{window.HistoricGrid.init("collectiveHistoricGrid",[],getTextFromCatalog(window.Collectives.i18n,"rocollectives_historictitle","Collectives"),{id:"Id",description:"Description",historyDate:"BeginDate"}),dataGridsInitialized=!0,setTimeout(()=>{updateNewHistoryButtonState(),n()},300)})}catch(n){return Promise.resolve()}};const loadUserFields=async()=>{try{const n=await $.ajax({type:"POST",url:BASE_URL+"Collectives/GetEmployeeUserfields",dataType:"json",data:{}});if(typeof n=="string"){$("#divCollectivesMainView").html("");DevExpress.ui.notify(n,"error",5e3);throw new Error("Error al cargar campos de usuario: "+n);}else userFields=n.map(n=>{let t={};switch(n.FieldType){case 0:t={dataType:"string",filterOperations:["=","<>","startswith","endswith","contains","notcontains"]};break;case 1:case 3:t={dataType:"number",filterOperations:["=","<>",">",">=","<","<=","between"]};break;case 2:const{formatMessage:i}=DevExpress.localization;t={dataType:"date",caption:i(n.FieldName),format:"shortDate",filterOperations:["=","<>",">",">=","<","<=","timeAgoMoreThan","timeAgoMoreOrEqualThan","timeAgoLessThan","timeAgoLessOrEqualThan","anniversary"],calculateFilterExpression:function(t,i){return[n.FieldName,i||"=",t]}};break;case 5:t={filterOperations:["=","<>","anyof"],lookup:{dataSource:n.ListValues}};break;default:t={dataType:"string"}}return{dataField:n.FieldName,...t}}),await initializeFilterBuilder(userFields),await initializeDataGrids()}catch(n){DevExpress.ui.notify(viewUtilsManager.DXTranslate("roCollectivesUserFieldsNotLoaded"),"error",2e3);currentCollectiveView={};throw n;}},updateEmployeesDataGrid=n=>{let i=getEffectiveUIDate();employeesPopupInstance||initializeEmployeesPopup();const t=$("#employeesDatagridPopup").dxDataGrid("instance");t&&(t.option("loadPanel",{enabled:!0,showIndicator:!0}),t.beginCustomLoading());$.ajax({type:"POST",url:BASE_URL+"Collectives/GetCollectiveEmployees",dataType:"json",data:{filterExpression:JSON.stringify(n.getFilterExpression()),refdate:i.apiDate},success:function(n){updateEmployeesDataGridDS(n)},error:function(){DevExpress.ui.notify("Error al cargar los empleados","error",3e3);t&&t.endCustomLoading()}})},updateEmployeesDataGridDS=n=>{setTimeout(function(){const t=$("#employeesDatagridPopup").dxDataGrid("instance");t&&(t.option("dataSource",n),t.refresh(),t.endCustomLoading())},100)};const loadCollective=async()=>{if(viewUtilsManager.getSelectedCardId()!=currentCollectiveView.Id){try{await ensureInitialized()}catch(n){return{Success:!1,Message:"Error de inicializaci�n."}}if(window.sectionHasChanges("Collectives")||window.sectionHasChanges("CollectivesDefinition")){viewUtilsManager.getSelectedCardId()!=currentCollectiveView.Id&&viewUtilsManager.setSelectedCardId(currentCollectiveView.Id);const n=getTextFromCatalog(window.Collectives.i18n,"rocollectives_pendingchangesoncollective","Collectives");return DevExpress.ui.notify(n,"warning",3e3),updateNewHistoryButtonState(),!1}if(viewUtilsManager.getSelectedCardId()>0)try{const n=await $.ajax({type:"POST",url:BASE_URL+"Collectives/GetCollective",dataType:"json",data:{idCollective:viewUtilsManager.getSelectedCardId()}});return typeof n=="string"?($("#divCollectivesMainView").html(""),DevExpress.ui.notify(n,"error",5e3),{Success:!1,Message:n}):(originalCollectiveView=n,currentCollectiveView=structuredClone(originalCollectiveView),isNewlyCreatedDefinition=!1,await initializeCollectiveData(),forceDisableChanges("Collectives"),setDeleteStatus("Collectives",!0),forceDisableChanges("CollectivesDefinition"),setDeleteStatus("CollectivesDefinition",!0),{Success:!0,Data:currentCollectiveView})}catch(n){return DevExpress.ui.notify(viewUtilsManager.DXTranslate("roCollectivesNotLoaded"),"error",2e3),currentCollectiveView={},{Success:!1,Message:"Error al cargar colectivo: "+n.message}}else return await clearData(),{Success:!0,Message:"Borramos datos del nuevo colectivo."}}},forceDisableChanges=n=>{setEntityChanges(n,!1),sb_hasChanges(n,!1)},initializeCollectiveData=async()=>(window.saveCollectiveTooltip&&window.saveCollectiveTooltip.hide(),isNewCollective())?(currentCollectiveDefinition={},newCollective(),forceDisableChanges("Collectives"),forceDisableChanges("CollectivesDefinition"),{Success:!0,Data:"OK"}):(currentCollectiveView=structuredClone(originalCollectiveView),$("#txtName").dxTextBox("instance").option("value",currentCollectiveView.Name),$("#txtName").dxTextBox("instance").option("onValueChanged",function(){checkDisabledButtons()}),$("#txtDescription").dxTextArea("instance").option("value",currentCollectiveView.Description),$("#txtDescription").dxTextArea("instance").option("onValueChanged",function(){checkDisabledButtons()}),await refreshHistoricDataGrid(),currentCollectiveView.HistoryEntries.length>0&&(currentCollectiveView.HistoryEntries.sort((n,t)=>moment(t.BeginDate).toDate()-moment(n.BeginDate).toDate()),await loadHistoricEntry(currentCollectiveView.HistoryEntries[0].Id)),setChangesBarTitle("Collectives",currentCollectiveView.Name),updateNewHistoryButtonState(),{Success:!0,Data:"OK"}),refreshHistoricDataGrid=async()=>{if(window.HistoricGrid&&typeof window.HistoricGrid.updateDS=="function"){currentCollectiveView||(currentCollectiveView={HistoryEntries:[]});Array.isArray(currentCollectiveView.HistoryEntries)||(currentCollectiveView.HistoryEntries=[]);try{const n=currentCollectiveView.HistoryEntries.filter(n=>n.EditionStatus!=2);await window.HistoricGrid.updateDS("collectiveHistoricGrid",n);n.length<=1?setDeleteStatus("CollectivesDefinition",!1):setDeleteStatus("CollectivesDefinition",!0)}catch(n){try{await window.HistoricGrid.updateDS("collectiveHistoricGrid",[])}catch(t){}}}},saveData=async()=>{if(isNewCollective()||updateCollectiveStatus(1),validateModel(currentCollectiveView))try{const n=await $.ajax({type:"POST",url:BASE_URL+"Collectives/CreateOrUpdateCollective",dataType:"json",data:{oCollectiveParam:currentCollectiveView}});return typeof n=="string"?(DevExpress.ui.notify(n,"error",5e3),{Success:!1,Message:n}):(window.saveCollectiveTooltip&&window.saveCollectiveTooltip.hide(),originalCollectiveView=n,currentCollectiveView=structuredClone(n),isNewlyCreatedDefinition=!1,await initializeCollectiveData(),checkDisabledButtons(),updateNewHistoryButtonState(),refreshCardTree(n.Id),DevExpress.ui.notify(viewUtilsManager.DXTranslate("roCollectivesSaved"),"success",2e3),{Success:!0,Data:n})}catch(n){return DevExpress.ui.notify(viewUtilsManager.DXTranslate("roCollectivesNotSaved"),"error",2e3),{Success:!1,Message:n}}else return{Success:!1,Message:"Modelo inv�lido"}},deleteCurrentCollective=async()=>{if(window.loadingRequest=!0,isEmpty(currentCollectiveView)){DevExpress.ui.notify(viewUtilsManager.DXTranslate("roCollectiveNoViewSelected"),"error",2e3);window.loadingRequest=!1;return}if(currentCollectiveView.Id==0){currentCollectiveView={};refreshCardTree(-1);unselectCards();$("#divCollectivesMainView").html("");window.loadingRequest=!1;return}try{const n=await $.ajax({type:"DELETE",url:BASE_URL+"Collectives/DeleteCollective",dataType:"json",data:{idCollective:viewUtilsManager.getSelectedCardId()}});return typeof n=="string"?(DevExpress.ui.notify(n,"error",5e3),{Success:!1,Data:n}):(currentCollectiveView={},{Success:!0,Data:currentCollectiveView})}catch(n){return DevExpress.ui.notify(viewUtilsManager.DXTranslate("roCollectiveNotDeleted"),"error",2e3),{Success:!1,Data:n}}finally{window.saveCollectiveTooltip&&window.saveCollectiveTooltip.hide();clearData();await refreshCardTree(0);setTimeout(function(){$("#CardView_DXMainTable .dxcvCard").length==0&&newCollective()},350);window.loadingRequest=!1}},newCollective=async()=>{try{await ensureInitialized()}catch(i){return}let n=!1;try{n=window.sectionHasChanges("Collectives")||window.sectionHasChanges("CollectivesDefinition")}catch(i){n=!0}if(n){const n=getTextFromCatalog(window.Collectives.i18n,"rocollectives_savebeforenewcollective","Collectives");DevExpress.ui.notify(n,"warning",3e3);return}refreshCardTree(-1);await clearData();let t=new DateManager(new Date,"UTC").startOf("day").toISOString();currentCollectiveDefinition={Id:getNewHistoricId(),BeginDate:t,EditionStatus:3,Description:"",Definition:"[]",FilterExpression:"[]"};currentCollectiveView&&Array.isArray(currentCollectiveView.HistoryEntries)||(currentCollectiveView={HistoryEntries:[]});currentCollectiveView.HistoryEntries.push(currentCollectiveDefinition);$("#txtHistoricDescription").dxTextBox("instance").option("value","");filterBuilderInstance&&filterBuilderInstance.option("value",[]);$("#datepicker").dxDateBox({type:"date",value:moment().utc().startOf("day").toDate(),width:120,inputAttr:{"aria-label":"Date"},displayFormat:getDateLocalizationFormats().format,onValueChanged:changeCollectiveDefinitionBeginDate});updateCollectiveStatus(3);await refreshHistoricDataGrid();updateNewHistoryButtonState();forceDisableChanges("Collectives");forceDisableChanges("CollectivesDefinition");await loadHistoricEntry(currentCollectiveDefinition.Id)},changeCollectiveName=n=>{currentCollectiveView.Name=n.component.option("value"),checkDisabledButtons()},changeCollectiveDesc=n=>{currentCollectiveView.Description=n.component.option("value"),checkDisabledButtons()},updateCollectiveStatus=n=>{currentCollectiveView.EditionStatus=n},isNewCollective=()=>currentCollectiveView.EditionStatus==3,checkDisabledButtons=(n=false)=>{const t=$("#txtName").dxTextBox("instance").option("value").length<=0||filterBuilderInstance?.option("value")==null||filterBuilderInstance?.option("value").length==0;sb_hasChanges("Collectives",!n&&!t);setChangesBarTitle("Collectives",$("#txtName").dxTextBox("instance").option("value"))},clearData=async()=>{$("#txtName").dxTextBox("instance").option("value",""),$("#txtDescription").dxTextArea("instance").option("value",""),filterBuilderInstance&&filterBuilderInstance.option("value",[]),currentCollectiveView={HistoryEntries:[]},currentCollectiveDefinition={},await refreshHistoricDataGrid(),checkDisabledButtons(!0),setDeleteStatus("Collectives",!1)},undoCollectiveDefinition=async()=>{if(isNewDefinitionCollective()&&currentCollectiveDefinition.Id<0)clearDefinitionData(!1),await loadHistoricEntry(currentCollectiveDefinition.Id),isNewCollective||setDeleteStatus("CollectivesDefinition",!0);else{const n=currentCollectiveView.HistoryEntries.findIndex(n=>n.Id==currentCollectiveDefinition.Id);if(n!==-1){const t=structuredClone(originalCollectiveView).HistoryEntries.find(n=>n.Id==currentCollectiveDefinition.Id);t&&(currentCollectiveView.HistoryEntries[n]=t)}await loadHistoricEntry(currentCollectiveDefinition.Id);isNewlyCreatedDefinition=!1}return updateNewHistoryButtonState(),{Success:!0,Message:"OK"}},saveDataDefinition=async()=>{const n=await validateDefinition();if(n.Data){isNewDefinitionCollective()||updateCollectiveDefinitionStatus(1);const n=currentCollectiveView.HistoryEntries.findIndex(n=>n.Id==currentCollectiveDefinition.Id);n!==-1?currentCollectiveView.HistoryEntries[n]=currentCollectiveDefinition:currentCollectiveView.HistoryEntries.push(currentCollectiveDefinition);await refreshHistoricDataGrid();await loadHistoricEntry(currentCollectiveDefinition.Id);setEntityChanges("CollectivesDefinition",!1);sb_hasChanges("CollectivesDefinition",!1);isNewCollective()||updateCollectiveStatus(1);checkDisabledButtons();isNewlyCreatedDefinition=!1;setTimeout(()=>{updateNewHistoryButtonState()},100);setupSaveCollectiveTooltip()}return{Success:!0,Data:"OK"}},validateDefinition=async()=>{try{currentCollectiveDefinition.CollectiveId=currentCollectiveView.Id;const n=await $.ajax({type:"POST",url:BASE_URL+"Collectives/ValidateCollectiveDefinition",dataType:"json",data:{oCollectiveDefinitionParam:currentCollectiveDefinition}});return typeof n=="string"?(DevExpress.ui.notify(n,"error",5e3),{Success:!0,Message:n}):{Success:!0,Data:n}}catch(n){return DevExpress.ui.notify(viewUtilsManager.DXTranslate("roCollectivesNotSaved"),"error",2e3),{Success:!1,Message:n}}},deleteCurrentCollectiveDefinition=async()=>{try{const t=currentCollectiveDefinition.Id<0||isNewlyCreatedDefinition;t?currentCollectiveView.HistoryEntries=currentCollectiveView.HistoryEntries.filter(n=>n.Id!==currentCollectiveDefinition.Id):updateCollectiveDefinitionStatus(2);isNewlyCreatedDefinition=!1;forceDisableChanges("CollectivesDefinition");clearDefinitionData(!0);await refreshHistoricDataGrid();const n=currentCollectiveView.HistoryEntries.filter(n=>n.EditionStatus!==2);return n&&n.length>0&&(n.sort((n,t)=>moment(t.BeginDate).toDate()-moment(n.BeginDate).toDate()),setTimeout(async()=>{try{await loadHistoricEntry(n[0].Id);window.HistoricGrid.selectRow("collectiveHistoricGrid",n[0].Id)}catch(t){}},250)),checkDisabledButtons(),updateNewHistoryButtonState(),{Success:!0,Message:"OK"}}catch(n){return forceDisableChanges("CollectivesDefinition"),DevExpress.ui.notify("Error al eliminar la definici�n","error",2e3),{Success:!1,Message:n.message}}},changeCollectiveDefinitionDesc=n=>{currentCollectiveDefinition.Description=n.value,checkDisabledDefinitionButtons()},changeCollectiveDefinitionBeginDate=n=>{const t=new DateManager(n.value,"UTC").toISOString();currentCollectiveDefinition.BeginDate=t;updateTexts({component:filterBuilderInstance});checkDisabledDefinitionButtons()},changeCollectiveDefinitionFilter=n=>{updateTexts(n),currentCollectiveDefinition.Definition=JSON.stringify(filterBuilderInstance.option("value")),currentCollectiveDefinition.FilterExpression=JSON.stringify(filterBuilderInstance.getFilterExpression()),checkDisabledDefinitionButtons()},clickHictoricEntry=async n=>{if(!isProcessingHistoryItemClick){if(window.sectionHasChanges("CollectivesDefinition")){setTimeout(()=>{window.HistoricGrid.selectRow("collectiveHistoricGrid",currentCollectiveDefinition?.Id)},100);const n=getTextFromCatalog(window.Collectives.i18n,"roCollectives_PendingChangesOnDefinition","Collectives");DevExpress.ui.notify(n,"warning",3e3);return}try{isProcessingHistoryItemClick=!0;const t=n?.selectedRowKeys[0];t&&await loadHistoricEntry(t)}finally{isProcessingHistoryItemClick=!1}}},clickNewHistoricEntry=async()=>{if(canAddNewHistoricEntry())try{isNewlyCreatedDefinition=!0;disableNewHistoryBtn();await newHistoryEntry();disableNewHistoryBtn()}catch(n){isNewlyCreatedDefinition=!1}else{let n="";n=isNewCollective()&&currentCollectiveView.Id<=0?getTextFromCatalog(window.Collectives.i18n,"roCollectives_saveBeforeNewDefinition","Collectives"):getTextFromCatalog(window.Collectives.i18n,"roCollectives_pendingChangesOnDefinition","Collectives");DevExpress.ui.notify(n,"warning",3e3)}},updateNewHistoryButtonState=(n=false)=>{try{const t=$(`#newHistoryItem_collectiveHistoricGrid`).dxButton("instance");if(t){const i=n?!0:!canAddNewHistoricEntry();t.option("disabled",i);i?$(`#newHistoryItem_collectiveHistoricGrid`).addClass("disabled"):$(`#newHistoryItem_collectiveHistoricGrid`).removeClass("disabled")}}catch(t){}},disableNewHistoryBtn=()=>{try{const n=$(`#newHistoryItem_collectiveHistoricGrid`).dxButton("instance");n&&(n.option("disabled",!0),$(`#newHistoryItem_collectiveHistoricGrid`).addClass("disabled"))}catch(n){}},canAddNewHistoricEntry=()=>{try{return isNewlyCreatedDefinition?!1:!currentCollectiveView||isEmpty(currentCollectiveView)||!currentCollectiveView.HistoryEntries||isNewCollective()||currentCollectiveView.Id<=0?!1:!window.sectionHasChanges("CollectivesDefinition")}catch(n){return!1}},clickVisualizeEmployees=()=>{let n=getEffectiveUIDate();return $("#employeesPopup").dxPopup("instance").option("title",(currentCollectiveView.Name||"")+" "+getTextFromCatalog(window.Collectives.i18n,"roCollectives_atDate","Collectives")+" "+moment(n.apiDate).format("DD/MM/YYYY")),$("#employeesPopup").dxPopup("instance").show(),updateEmployeesDataGrid($("#filterBuilder").dxFilterBuilder("instance")),{Success:!0,Message:"OK"}},canNavigateAway=()=>{if(window.sectionHasChanges("Collectives")||window.sectionHasChanges("CollectivesDefinition")){const n=viewUtilsManager.DXTranslate("roCollectiveSaveCurrentDefinition")||"Debe guardar o descartar los cambios en la definici�n actual";return DevExpress.ui.notify(n,"warning",3e3),!1}return!0},newHistoryEntry=async()=>{let n=new DateManager(new Date,"UTC").startOf("day").toISOString();currentCollectiveDefinition={Id:getNewHistoricId(),BeginDate:n,EditionStatus:3,Description:"",Definition:"[]",FilterExpression:"[]"};currentCollectiveView.HistoryEntries.push(currentCollectiveDefinition);await refreshHistoricDataGrid();await loadHistoricEntry(currentCollectiveDefinition.Id)},getNewHistoricId=()=>{const n=currentCollectiveView.HistoryEntries;if(!n||n.length===0)return-1;let t=n.reduce((n,t)=>t.Id<n?t.Id:n,n[0].Id);return t>0&&(t=0),t-1};const loadHistoricEntry=async n=>{if(!filterBuilderInstance||!userFields){DevExpress.ui.notify("Error interno: Componentes de filtro no listos para cargar entrada hist�rica.","error",5e3);return}const i=currentCollectiveView.HistoryEntries.find(t=>t.Id==n);if(!i){DevExpress.ui.notify(`Error: No se encontr� la entrada hist�rica(Id: ${n}).`,"error",3e3);await clearDefinitionData(!0);return}currentCollectiveDefinition=i;await window.HistoricGrid.selectRow("collectiveHistoricGrid",n);$("#txtHistoricDescription").dxTextBox("instance").option("value",currentCollectiveDefinition.Description);let t=[];try{currentCollectiveDefinition.Definition&&currentCollectiveDefinition.Definition.trim()!==""&&(t=JSON.parse(currentCollectiveDefinition.Definition))}catch(u){DevExpress.ui.notify("Error al procesar la definici�n del filtro guardada. Se usar� un filtro vac�o.","warning",5e3);t=[]}const r=findMissingUserFields(t);if(r.length>0){const n=getTextFromCatalog(window.Collectives.i18n,"rocollectives_removeduserfields","Collectives")+": "+[...new Set(r)].join(", ");DevExpress.ui.notify(n,"warning",5e3);t=[]}try{filterBuilderInstance.option("value",t)}catch(u){if(DevExpress.ui.notify("Error al aplicar el filtro guardado. Se mostrar� un filtro vac�o.","error",5e3),filterBuilderInstance)try{filterBuilderInstance.option("value",[])}catch(n){}}updateEmployeesDataGridDS([]);$("#datepicker").dxDateBox({type:"date",value:moment(currentCollectiveDefinition.BeginDate).toDate(),width:120,inputAttr:{"aria-label":"Date"},displayFormat:getDateLocalizationFormats().format,onValueChanged:changeCollectiveDefinitionBeginDate});$("#lastChange_name").html(currentCollectiveDefinition.ModifiedBy);typeof currentCollectiveDefinition.ModifiedDate!="undefined"?$("#lastChange_date").html(new DateManager(currentCollectiveDefinition.ModifiedDate,"UTC").format(shortFormat)):$("#lastChange_date").html(moment().format(shortFormat));typeof currentCollectiveDefinition.ModifiedDate!="undefined"?$("#lastChange_time").html(new DateManager(currentCollectiveDefinition.ModifiedDate,"UTC").format("HH:mm")):$("#lastChange_time").html(moment().format("HH:mm"));setEntityChanges("CollectivesDefinition",!1);sb_hasChanges("CollectivesDefinition",!1);updateNewHistoryButtonState()},updateCollectiveDefinitionStatus=n=>{currentCollectiveDefinition.EditionStatus=n},isNewDefinitionCollective=()=>currentCollectiveDefinition.EditionStatus==3,checkDisabledDefinitionButtons=()=>{const n=$("#txtHistoricDescription").dxTextBox("instance"),t=filterBuilderInstance?.option("value");if(n&&filterBuilderInstance){const i=!n.option("value")||n.option("value").length<=0,r=!t||Array.isArray(t)&&t.length===0,u=i||r;sb_hasChanges("CollectivesDefinition",!u);updateNewHistoryButtonState()}},clearDefinitionData=(n=true)=>{$("#txtHistoricDescription").dxTextBox("instance").option("value",""),$("#datepicker").dxDateBox("instance").option("value",new Date),filterBuilderInstance.option("value",[]),n&&window.HistoricGrid.selectRow("collectiveHistoricGrid",null),sb_hasChanges("CollectivesDefinition",!1),setDeleteStatus("CollectivesDefinition",!1)};