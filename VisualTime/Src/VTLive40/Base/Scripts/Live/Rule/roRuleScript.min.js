(function(){let i={},n=101,t=!1,f=!1,r=!1,u=0;$(document).ready(async function(){window.Rule_save=async()=>d(i);window.Rule_close=async()=>tt();window.Rule_undo=async()=>g(i);window.Rule_delete=async()=>nt(i);window.RuleHistory_save=async()=>it(i);window.RuleHistory_undo=async()=>rt(i);window.RuleHistory_delete=async()=>ut(i);window.parentCloseAndApplySelector=async n=>p(n);window.ruleHistoryGrid_OnHistoryItemClick=async n=>w(n);window.ruleHistoryGrid_OnNewClick=async n=>b(n);window.Rule={SetValue:n=>{i=n},GetValue:()=>i,Events:{onLoad:async()=>c()}};window.RuleEditor={loaded:!1,Events:{onLoad:async(n,t)=>st(n,t),confirmRuleDefinition:n=>et(n),cancelRuleDefinition:()=>ot(),getCurrentRuleDefinition:()=>ft()}};const c=async()=>{if(t=!0,window.Rule.GetValue()==null){DevExpress.ui.notify(getTextFromCatalog(window.RuleGroups.i18n,"roConvertedError","RulesGroup"));return}setEntityChanges("Rule",!1);sb_hasChanges("Rule",!1);setChangesBarTitle("Rule",window.Rule.GetValue().Name);setEntityChanges("RuleHistory",!1);sb_hasChanges("RuleHistory",!1);setDeleteStatus("Rule",!0);n=window.Rule.GetValue().RuleDefinitions[0].Id;await s();window.HistoricGrid.init("ruleHistoryGrid",window.Rule.GetValue().RuleDefinitions,getTextFromCatalog(window.RuleGroups.i18n,"roRuleDetail_HistoryTitle","RulesGroup"),{id:"Id",description:"Description",historyDate:"EffectiveFrom"});t=!1},s=async()=>{$("#txtName").dxTextBox("instance").option("value",window.Rule.GetValue().Name);$("#txtName").dxTextBox("instance").option("onValueChanged",function(){if(!t){const n=window.Rule.GetValue();n.Name=$("#txtName").dxTextBox("instance").option("value");window.Rule.SetValue(n);checkDisabledButtons()}});$("#txtDescription").dxTextArea("instance").option("value",window.Rule.GetValue().Description);$("#txtDescription").dxTextArea("instance").option("onValueChanged",function(){if(!t){const n=window.Rule.GetValue();n.Description=$("#txtDescription").dxTextArea("instance").option("value");window.Rule.SetValue(n);checkDisabledButtons()}});$("#lblTypeValue").text(window.Rule.GetValue().TypeDescription);const n=window.RulesManager.Data.RuleTypes().find(n=>n.Id==window.Rule.GetValue().Type);$("#lblTypeDescription").text(n.Name+". "+n.Description);a();v()},e=async()=>{$("#dpAvailableFrom").dxDateBox({type:"date",value:moment(window.Rule.GetValue().RuleDefinitions.find(t=>t.Id==n).EffectiveFrom).toDate(),width:130,displayFormat:getDateLocalizationFormats().format,inputAttr:{"aria-label":"Date"},onValueChanged:function(i){if(!t){const r=i.value,t=window.Rule.GetValue();t.RuleDefinitions.find(t=>t.Id==n).EffectiveFrom=dateToJsonIsoString(r);window.Rule.SetValue(t);checkDisabledHistoryButtons()}}}),$("#txtDefinitionDescription").dxTextBox("instance").option("value",window.Rule.GetValue().RuleDefinitions.find(t=>t.Id==n).Description),$("#txtDefinitionDescription").dxTextBox("instance").option("onValueChanged",function(){if(!t){const t=window.Rule.GetValue();t.RuleDefinitions.find(t=>t.Id==n).Description=$("#txtDefinitionDescription").dxTextBox("instance").option("value");window.Rule.SetValue(t);checkDisabledHistoryButtons()}}),y(),l(),await window.HistoricGrid.selectRow("ruleHistoryGrid",n)},l=async()=>{const t=window.Rule.GetValue().RuleDefinitions.find(t=>t.Id==n);if(t!=null&&t.EmployeeContext!=null){let n={};t.EmployeeContext!=null&&(n.UserFields=t.EmployeeContext.UserFields,n.ComposeFilter=t.EmployeeContext.ComposeFilter,n.ComposeMode=t.EmployeeContext.ComposeMode,n.Filter=t.EmployeeContext.Filters,n.Operation=t.EmployeeContext.Operation);$("#txtWhoRuleApply").dxTextBox("instance").option("value",buildSelectedEmployeesString(n))}else $("#txtWhoRuleApply").dxTextBox("instance").option("value",buildSelectedEmployeesString(""));$("#txtWhoRuleApply").off("click");$("#txtWhoRuleApply").on("click",function(){parent.showLoader(!0);let t=window.Rule.GetValue().RuleDefinitions.find(t=>t.Id==n).EmployeeContext,i={Employees:"",Groups:"",Filter:"",UserFields:"",ComposeMode:"",ComposeFilter:"",Advanced:!1,Operation:""};t!=null&&(i={Employees:[],Groups:[],Filter:t.Filter,UserFields:t.UserFields,ComposeMode:t.ComposeMode,ComposeFilter:t.ComposeFilter,Advanced:!1,Operation:t.Operation});$("#divRuleContextSelector").load("/Employee/EmployeeSelectorPartial?feature=Employees&pageName=rules&config=111&unionType=or&advancedMode=0&advancedFilter=0&allowAll=0&allowNone=0",function(){loadPartialInfo();initUniversalSelector(i,!1,"rulesSelector");parent.showLoader(!1)})})},a=async()=>{$("#cboGroup").dxSelectBox({dataSource:window.RulesManager.Data.RuleGroups(),valueExpr:"Id",displayExpr:"Name",acceptCustomValue:!0,value:window.Rule.GetValue().GroupId,placeholder:getTextFromCatalog(window.RuleGroups.i18n,"lblAddOrSelectGroups","RulesGroup"),onCustomItemCreating:function(n){const t=n.text,i={Id:t,Name:t},r=n.component.getDataSource();r.store().insert(i);r.reload();n.customItem=i},onValueChanged:function(n){if(!t){const t=window.Rule.GetValue();t.GroupId=n.value;t.GroupName=n.component.option("displayValue");window.Rule.SetValue(t);checkDisabledButtons()}}})},v=async()=>{$("#tbTags").dxTagBox({dataSource:window.RulesManager.Data.Tags(),valueExpr:"id",displayExpr:"id",acceptCustomValue:!0,searchEnabled:!0,showSelectionControls:!0,placeholder:getTextFromCatalog(window.RuleGroups.i18n,"lblAddOrSelectTags","RulesGroup"),value:window.Rule.GetValue().Tags,onCustomItemCreating:function(n){const r=n.text,t={id:r},i=n.component.getDataSource();i.store().insert(t);i.reload();n.customItem=t},onValueChanged:function(n){if(!t){if(JSON.stringify(n.previousValue)===JSON.stringify(n.value))return;const t=window.Rule.GetValue();t.Tags=n.value;window.Rule.SetValue(t);checkDisabledButtons()}}})},y=async()=>{$("#tbShifts").dxTagBox({dataSource:window.RulesManager.Data.Shifts().map(n=>({Id:n.Id,Name:n.Name})),valueExpr:"Id",displayExpr:"Name",searchEnabled:!0,showSelectionControls:!0,placeholder:getTextFromCatalog(window.RuleGroups.i18n,"lblSelectShift","RulesGroup"),onValueChanged:function(i){if(!t){const t=window.Rule.GetValue(),u=t.RuleDefinitions.find(t=>t.Id==n).Shifts,f=[];let r=1;u!=null&&(r=u.length>0?Math.max(...u.map(n=>n.Order))+1:0);for(let u=0;u<i.value.length;u++){const e=i.value[u],o=window.RulesManager.Data.Shifts().find(n=>n.Id==e),s=window.RulesManager.Data.ShiftGroups().find(n=>n.Id==o.GroupId);if(t.RuleDefinitions.find(t=>t.Id==n).Shifts!=null&&t.RuleDefinitions.find(t=>t.Id==n).Shifts.find(n=>n.IdShift==e)!=null)f.push(t.RuleDefinitions.find(t=>t.Id==n).Shifts.find(n=>n.IdShift==e));else{const n=window.RulesManager.Data.Shifts().find(n=>n.Id==e);f.push({IdShift:parseInt(e),ShiftName:o.Name,IdShiftGroup:o.GroupId,ShiftGroupName:s.Name,IdRule:t.Id,Order:r});r=r+1}}t.RuleDefinitions.find(t=>t.Id==n).Shifts=f;window.Rule.SetValue(t);checkDisabledHistoryButtons()}}}),typeof window.Rule.GetValue()!="undefined"&&window.Rule.GetValue().RuleDefinitions.find(t=>t.Id==n).Shifts!=null?$("#tbShifts").dxTagBox("instance").option("value",window.Rule.GetValue().RuleDefinitions.find(t=>t.Id==n).Shifts.map(n=>n.IdShift)):$("#tbShifts").dxTagBox("instance").option("value",[])},p=function(t){const i=window.Rule.GetValue().RuleDefinitions.find(t=>t.Id==n);i.EmployeeContext!=null?(i.EmployeeContext.UserFields=t.UserFields,i.EmployeeContext.ComposeFilter=t.ComposeFilter,i.EmployeeContext.ComposeMode=t.ComposeMode,i.EmployeeContext.Filters=t.Filter,i.EmployeeContext.Operation=t.Operation):i.EmployeeContext={UserFields:t.UserFields,ComposeFilter:t.ComposeFilter,ComposeMode:t.ComposeMode,Filters:t.Filter,Operation:t.Operation};$("#txtWhoRuleApply").dxTextBox("instance").option("value",buildSelectedEmployeesString(t));checkDisabledHistoryButtons()},w=async i=>{if(!f)try{f=!0;sectionHasChanges("RuleHistory")||r&&i.selectedRowKeys!=u?i.selectedRowKeys[0]!=i.currentDeselectedRowKeys[0]&&(e(),DevExpress.ui.notify(getTextFromCatalog(window.RuleGroups.i18n,"roPendingChanges","RulesGroup"),"error",2e3)):(n=i.selectedRowKeys[0],t=!0,await e(),t=!1)}finally{f=!1}},b=async()=>{if(!r&&!sectionHasChanges("RuleHistory")){let f=-1;const i=window.Rule.GetValue().RuleDefinitions;if(i!=null&&i.length>0){const n=i.map(n=>n.Id).filter(n=>n<0);n.length>0&&(f=Math.min(...n)-1)}n=f;const s={Id:n,Description:"",EffectiveFrom:`/Date(${(new Date).getTime()})/`,EditionStatus:3,Shifts:[],EmployeeContext:null};window.Rule.GetValue().RuleDefinitions.push(s);t=!0;r=!0;u=n;await o();await e();k();t=!1}},h=()=>{try{const n=$(`#newHistoryItem_ruleHistoryGrid`).dxButton("instance");n&&(n.option("disabled",!1),$(`#newHistoryItem_ruleHistoryGrid`).removeClass("disabled"))}catch(n){console.error("Error deshabilitando bot�n:",n)}},k=()=>{try{const n=$(`#newHistoryItem_ruleHistoryGrid`).dxButton("instance");n&&(n.option("disabled",!0),$(`#newHistoryItem_ruleHistoryGrid`).addClass("disabled"))}catch(n){console.error("Error deshabilitando bot�n:",n)}},o=async()=>{const n=window.Rule.GetValue().RuleDefinitions.filter(n=>n.EditionStatus!=2);window.HistoricGrid.updateDS("ruleHistoryGrid",n);n.length<=1?setDeleteStatus("RuleHistory",!1):setDeleteStatus("RuleHistory",!0)},d=async n=>{if(sectionHasChanges("RuleHistory")||r)return DevExpress.ui.notify(getTextFromCatalog(window.RuleGroups.i18n,"roPendingChangesOnHistory","RulesGroup"),"error",2e3),{Success:!1,Data:null,ErrorText:""};else{let t=!1;return $("#ruleFrm").dxPopup("instance").hide(),t=await window.RulesManager.RuleExists(n)?await window.RulesManager.UpdateRule(n):await window.RulesManager.AddRule(n),sectionHasChanges("Rule")&&sb_hasChanges("RuleMng",!0),t?DevExpress.ui.notify(getTextFromCatalog(window.RuleGroups.i18n,"roSavedRuleOK","RulesGroup"),"warning",2e3):DevExpress.ui.notify(getTextFromCatalog(window.RuleGroups.i18n,"roErrorSavingRule","RulesGroup"),"error",2e3),{Success:!0,Data:null,ErrorText:""}}},g=async n=>(sb_hasChanges("Rule",!1),sb_hasChanges("RuleHistory",!1),r=!1,u=0,window.RulesManager.ReloadRule(n),await s(),o(),{Success:!0,Data:null,ErrorText:""}),nt=async n=>{const t=window.RulesManager.DeleteRule(n,window.RulesManager.GetDS());return t?(DevExpress.ui.notify(getTextFromCatalog(window.RuleGroups.i18n,"roDeletedRuleOK","RulesGroup"),"success",2e3),window.Rule.SetValue(null),sb_hasChanges("Rule",!1),sb_hasChanges("RuleMng",!0),$("#ruleFrm").dxPopup("instance").hide()):DevExpress.ui.notify(getTextFromCatalog(window.RuleGroups.i18n,"roErrorDeletingRule","RulesGroup"),"error",2e3),{Success:!0,Data:null,ErrorText:""}},tt=async()=>(window.Rule.SetValue(null),sb_hasChanges("Rule",!1),sb_hasChanges("RuleHistory",!1),r=!1,u=0,$("#ruleFrm").dxPopup("instance").hide(),{Success:!0,Data:null,ErrorText:""}),it=async()=>await $.ajax({url:`${BASE_URL}Rule/ValidateRuleHistory`,data:window.Rule.GetValue().RuleDefinitions.find(t=>t.Id==n),type:"POST",dataType:"json",success:t=>{if(t.Success)return setEntityChanges("RuleHistory",!1),sb_hasChanges("RuleHistory",!1),setEntityChanges("Rule",!0),sb_hasChanges("Rule",!0),window.Rule.GetValue().RuleDefinitions.find(t=>t.Id==n).EditionStatus=1,o(),r=!1,u=0,h(),{Success:!0,Data:null,ErrorText:""};DevExpress.ui.notify(t.ErrorText)},error:n=>{console.error(n)}}),rt=async i=>(sb_hasChanges("RuleHistory",!1),window.RulesManager.GetRuleHistoryItem(i,n),t=!0,await e(),t=!1,{Success:!0,Data:null,ErrorText:""}),ut=async()=>(setEntityChanges("RuleHistory",!1),sb_hasChanges("RuleHistory",!1),setEntityChanges("Rule",!0),sb_hasChanges("Rule",!0),h(),r=!1,u=0,window.Rule.GetValue().RuleDefinitions.find(t=>t.Id==n).EditionStatus=2,await o(),{Success:!0,Data:null,ErrorText:""}),ft=()=>{},et=async()=>{},ot=async()=>{$("#editDailyRuleFrm").dxPopup("instance").hide()},st=n=>{let t=n.component._$popupContent[0].querySelector("#ifDailyRuleEditor"),i=parent.showLoader;t?window.RuleEditor.loaded||(t.addEventListener("load",function(){let n=t;i(!1);n.contentWindow.setGetCurrentRuleDefinition(window.RuleEditor.Events.getCurrentRuleDefinition);n.contentWindow.setOnSaveRuleEdition(window.RuleEditor.Events.confirmRuleDefinition);n.contentWindow.setOnCancelEdition(window.RuleEditor.Events.cancelRuleDefinition);n.contentWindow.onAdvancedRulePopupShown()}),window.RuleEditor.loaded=!0):console.warn("No se encontr� el iframe con nombre ifFrameRuleEditor")}})})();const checkDisabledButtons=(n=false)=>{const t=$("#txtName").dxTextBox("instance").option("value").length<=0;sb_hasChanges("Rule",!n&&!t);setChangesBarTitle("Rule",$("#txtName").dxTextBox("instance").option("value"))},checkDisabledHistoryButtons=(n=false)=>{const t=$("#txtDefinitionDescription").dxTextBox("instance").option("value").length<=0;sb_hasChanges("RuleHistory",!n&&!t)},openDailyRule=()=>{parent.showLoader(!0),$("#editDailyRuleFrm").dxPopup("instance").show()};