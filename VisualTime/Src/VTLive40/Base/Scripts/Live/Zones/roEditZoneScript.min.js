function maxCapacity(n){n.value?($("#txtZoneCapacity").dxTextBox("instance").option("disabled",!1),$(".divShowZoneCapacity").show()):($("#txtZoneCapacity").dxTextBox("instance").option("disabled",!0),$("#txtZoneCapacity").dxTextBox("option","value",null),$("#chkShowZoneCapacity").dxSwitch("option","value",null),$("#selectZoneSupervisor").dxSelectBox("option","value",null),$(".divShowZoneCapacity").hide())}function openAddNewZonePopUp(){clearEditFields();$("#editZonePopup").dxPopup("instance").show();$("#btnEditZone").hide();$("#btnAddNewZone").show()}function popUpHidden(){openPopUp=!1}function popUpShown(){openPopUp=!0;let n=$("#ckZoneLocationWorkingMode").dxSwitch("instance");ipRestrictionEnabled=n.option("value");ipRestrictionEnabled?($(".editZoneMap").hide(),$(".editZoneIps").show()):($(".editZoneMap").show(),$(".editZoneIps").hide());$("#map").dxMap("instance").repaint();$("#configDiv").show();$("#advancedDiv").hide();$("#zoneConfiguration").addClass("bTabZones-active");$("#zoneAdvanced").removeClass("bTabZones-active");$("#zoneAdvanced").addClass("bTabZones");$("#zoneConfiguration").off("click");$("#zoneConfiguration").on("click",function(){$("#configDiv").show();$("#advancedDiv").hide();$("#zoneConfiguration").addClass("bTabZones-active");$("#zoneAdvanced").removeClass("bTabZones-active")});$("#zoneAdvanced").off("click");$("#zoneAdvanced").on("click",function(){$("#configDiv").hide();$("#advancedDiv").show();$("#zoneConfiguration").removeClass("bTabZones-active");$("#zoneAdvanced").addClass("bTabZones-active")});$("#gridInactiviyZones").dxDataGrid("instance").getDataSource()==null&&$("#gridInactiviyZones").dxDataGrid({dataSource:[]});$("#gridExceptionZones").dxDataGrid("instance").getDataSource()==null&&$("#gridExceptionZones").dxDataGrid({dataSource:[]});$("#gridIpRestrictions").dxDataGrid("instance").getDataSource()==null&&$("#gridIpRestrictions").dxDataGrid({dataSource:[]})}function decimalToRgb(n){return{red:n>>16&255,green:n>>8&255,blue:n&255}}function componentToHex(n){let t=n.toString(16);return t.length==1?"0"+t:t}function rgbToHex(n,t,i){return"#"+componentToHex(n)+componentToHex(t)+componentToHex(i)}function openEditZonePopUp(){clearEditFields();$.ajax({type:"GET",url:BASE_URL+"Zones/LoadInfoZone",contentType:"application/json; charset=utf-8",data:{id:$("#idZoneEdit").val()},success:function(n){for(const t of n.ZonesInactivity)t.Begin=new Date(parseInt(t.Begin.substr(6))),t.End=new Date(parseInt(t.End.substr(6)));$("#gridInactiviyZones").dxDataGrid({dataSource:n.ZonesInactivity});for(const t of n.ZonesException)t.ExceptionDate=new Date(parseInt(t.ExceptionDate.substr(6)));$("#gridExceptionZones").dxDataGrid({dataSource:n.ZonesException});$("#txtName").dxTextBox("option","value",n.Name);$("#txtZoneCapacity").dxTextBox("option","value",n.Capacity);n.Capacity!=null?$("#chkZoneCapacity").dxCheckBox("instance").option("value",!0):$("#chkZoneCapacity").dxCheckBox("instance").option("value",!1);$("#chkShowZoneCapacity").dxSwitch("option","value",n.CapacityVisible);$("#chkZoneNameAsLocation").dxSwitch("option","value",n.ZoneNameAsLocation);$("#chkIsEmergencyZone").dxSwitch("option","value",n.IsEmergencyZone);let t=decimalToRgb(parseInt(n.Color));$("#selectColor").dxColorBox("option","value",rgbToHex(t.red,t.green,t.blue));$("#selectTimeZone").dxSelectBox("option","value",n.DefaultTimezone);$("#selectTelecommutingType").dxSelectBox("option","value",n.TelecommutingZoneType);let i=$("#selectWorkCenter").dxSelectBox("getDataSource")._store._array;if(n.WorkCenter!=null&&i.filter(t=>t.Name===n.WorkCenter).length<=0&&(i.push({Name:n.WorkCenter}),$("#selectWorkCenter").dxSelectBox({dataSource:i})),$("#selectWorkCenter").dxSelectBox("option","value",n.WorkCenter),$("#selectZoneSupervisor").dxSelectBox("option","value",n.Supervisor),$("#txtDescription").dxTextArea("option","value",n.Description),$("#selectType").dxSwitch("option","value",n.IsWorkingZone),n.GoogleMapInfo!=null){let t=n.GoogleMapInfo.Shape;t==_RECTANGLE_SHAPE?($("#googleRectCords").val(dbCoordsArray2JSON(n.GoogleMapInfo.Coordinates)),$("#googlePolCords").val(""),$("#zoneShape").val(_RECTANGLE_SHAPE)):t==_POLYGON_SHAPE&&($("#googlePolCords").val(dbCoordsArray2JSON(n.GoogleMapInfo.Coordinates)),$("#googleRectCords").val(""),$("#zoneShape").val(_POLYGON_SHAPE));$("#googleMapCenter").val(JSON.stringify({Latitud:n.GoogleMapInfo.Center.Latitud,Longitud:n.GoogleMapInfo.Center.Longitud}));$("#googleMapZoom").val(n.GoogleMapInfo.Zoom);$("#zoneArea").val(n.Area)}let r=[];n.IpsRestriction!=null&&n.IpsRestriction.length>0&&(r=n.IpsRestriction.map(function(n){return{Ip:n}}));$("#gridIpRestrictions").dxDataGrid({dataSource:r})},error:function(){clearEditFields()}});$("#editZonePopup").dxPopup("instance").show();$("#btnEditZone").show();$("#btnAddNewZone").hide()}function calculateWeekDay(n){let t=[viewUtilsManager.DXTranslate("sunday"),viewUtilsManager.DXTranslate("monday"),viewUtilsManager.DXTranslate("tuesday"),viewUtilsManager.DXTranslate("wednesday"),viewUtilsManager.DXTranslate("thursday"),viewUtilsManager.DXTranslate("friday"),viewUtilsManager.DXTranslate("saturday")];return t[n.value]}function editTimeCell(n,t){$("<div>").appendTo(n).dxDateBox({type:"time",onValueChanged:function(n){t.setValue(n.value)}})}function editDateCell(n,t){$("<div>").appendTo(n).dxDateBox({type:"date",onValueChanged:function(n){t.setValue(n.value)}})}function editSelectDayCell(n,t){const i=[{ID:1,Name:viewUtilsManager.DXTranslate("monday")},{ID:2,Name:viewUtilsManager.DXTranslate("tuesday")},{ID:3,Name:viewUtilsManager.DXTranslate("wednesday")},{ID:4,Name:viewUtilsManager.DXTranslate("thursday")},{ID:5,Name:viewUtilsManager.DXTranslate("friday")},{ID:6,Name:viewUtilsManager.DXTranslate("saturday")},{ID:0,Name:viewUtilsManager.DXTranslate("sunday")}];$("<div>").appendTo(n).dxSelectBox({dataSource:i,valueExpr:"ID",displayExpr:"Name",onValueChanged:function(n){t.setValue(n.value)}})}function initializeCenter(n){if($("#googleMapCenter")!=undefined&&$("#googleMapCenter").val()!=""&&$("#googleMapCenter").val()!=null&&$("#googleMapCenter").val()!=undefined){let t=JSON.parse($("#googleMapCenter").val());n.setCenter(new google.maps.LatLng(t.Latitud,t.Longitud))}else centerCurrentLocation()}function initializeZoom(n){n.setZoom(parseInt($("#googleMapZoom").val()))}function CleanMapControl(n){let t=document.createElement("div");t.style.backgroundColor="#FFFFFF";t.style.borderStyle="solid";t.style.borderWidth="3px";t.style.borderColor="#ccc";t.style.height="27px";t.style.marginTop="5px";t.style.marginLeft="-52px";t.style.paddingTop="3px";t.style.cursor="pointer";t.style.textAlign="center";n.appendChild(t);let i=document.createElement("div");i.style.fontSize="10px";i.style.paddingLeft="4px";i.style.paddingRight="4px";i.innerHTML='<img src="Base/Images/tbt/delete.png"/>';t.appendChild(i);google.maps.event.addDomListener(t,"click",function(){cleanMap()})}function addCleanMapControl(n){let t=document.createElement("div");CleanMapControl(t,n);t.index=1;n.controls[google.maps.ControlPosition.TOP_RIGHT].push(t)}function initializeRectangleZone(n){if($("#googleRectCords").val()!=null&&$("#googleRectCords").val()!=""){drawingmanager.setMap(null);addCleanMapControl(n);let t=JSON.parse($("#googleRectCords").val()),r=new google.maps.LatLngBounds(new google.maps.LatLng(parseFloat(t[1].Latitud),parseFloat(t[1].Longitud)),new google.maps.LatLng(parseFloat(t[0].Latitud),parseFloat(t[0].Longitud)));drawedRectangle=new google.maps.Rectangle({bounds:r,map:n});let i=$("#selectColor").dxColorBox("option","value"),u={strokeColor:i,fillColor:i,fillOpacity:.2};updateDrawedRectangle(u)}}function initializePolygonZone(n){if($("#googlePolCords").val()!=null&&$("#googlePolCords").val()!=""){drawingmanager.setMap(null);let r=JSON.parse($("#googlePolCords").val());const t=[];for(const n of r)t.push(new google.maps.LatLng(parseFloat(n.Latitud),parseFloat(n.Longitud)));drawedPolygon=new google.maps.Polygon({paths:t,map:n});let i=$("#selectColor").dxColorBox("option","value"),u={strokeColor:i,fillColor:i,fillOpacity:.2};updateDrawedPolygon(u)}}function updateDrawingManagerControlColor(n){drawingmanager!=null&&drawingmanager.setOptions({rectangleOptions:n,polygonOptions:n})}function updateDrawedRectangle(n){drawedRectangle.setOptions(n)}function updateDrawedPolygon(n){drawedPolygon.setOptions(n)}function onColorChanged(n){let i=n.value,t={strokeColor:i,fillColor:i,fillOpacity:.2};updateDrawingManagerControlColor(t);drawedRectangle!=null&&updateDrawedRectangle(t);drawedPolygon!=null&&updateDrawedPolygon(t)}function cleanMap(){$("#googlePolCords").val(null);$("#googleRectCords").val(null);$("#googleMapCenter").val(null);$("#googleMapZoom").val(10);$("#zoneShape").val(null);$("#zoneArea").val(null);let n=$("#map").dxMap("instance");n!=null&&n.repaint()}function clearEditFields(){$("#txtName").dxTextBox("option","value",null);$("#selectColor").dxColorBox("option","value",null);$("#selectTimeZone").dxSelectBox("option","value",null);$("#selectTelecommutingType").dxSelectBox("option","value",2);$("#selectWorkCenter").dxSelectBox("option","value",null);$("#selectZoneSupervisor").dxSelectBox("option","value",null);$("#txtDescription").dxTextArea("option","value",null);$("#selectType").dxSwitch("option","value",!0);$("#chkShowZoneCapacity").dxSwitch("option","value",null);$("#chkZoneNameAsLocation").dxSwitch("option","value",null);$("#chkZoneCapacity").dxCheckBox("option","value",null);$("#txtZoneCapacity").dxTextBox("option","value",null);cleanMap();$("#gridInactiviyZones").dxDataGrid({dataSource:[]});$("#gridExceptionZones").dxDataGrid({dataSource:[]});$("#gridIpRestrictions").dxDataGrid({dataSource:[]})}function cancelZone(){$("#editZonePopup").dxPopup("instance").hide()}function getPolygonPath(n){return n.join("|").replace(/\(/g,"").replace(/\)/g,"").replace(/\ /g,"")+"|"+n[0].toString().replace(/\(/g,"").replace(/\)/g,"")}function getRectanglePath(n,t){return n.lat()+","+n.lng()+"|"+n.lat()+","+t.lng()+"|"+t.lat()+","+t.lng()+"|"+t.lat()+","+n.lng()+"|"+n.lat()+","+n.lng()}function setSearchBar(n){const t=document.createElement("input");t.placeholder=viewUtilsManager.DXTranslate("roZoneGoogleSearch");const i=new google.maps.places.SearchBox(t);n.controls[google.maps.ControlPosition.TOP_LEFT].push(t);n.addListener("bounds_changed",()=>{i.setBounds(n.getBounds())});let r=[];i.addListener("places_changed",()=>{const u=i.getPlaces();if(u.length!=0){r.forEach(n=>{n.setMap(null)});r=[];const t=new google.maps.LatLngBounds;u.forEach(i=>{if(i.geometry&&i.geometry.location){const u={url:i.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};r.push(new google.maps.Marker({map:n,icon:u,title:i.name,position:i.geometry.location}));i.geometry.viewport?t.union(i.geometry.viewport):t.extend(i.geometry.location)}});n.fitBounds(t)}})}function createMarker(n){if(n.geometry&&n.geometry.location){const t=new google.maps.Marker({map,position:n.geometry.location});google.maps.event.addListener(t,"click",()=>{infowindow.setContent(n.name||""),infowindow.open(map)})}}function onMapReady(n){if(openPopUp){let t=n.originalMap;setSearchBar(t);drawingmanager=new google.maps.drawing.DrawingManager;drawingmanager.setOptions({drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT,drawingModes:[google.maps.drawing.OverlayType.RECTANGLE]}});drawingmanager.setMap(t);let i=$("#selectColor").dxColorBox("option","value"),r={strokeColor:i,fillColor:i,fillOpacity:.2};i!=null&&i!=undefined&&updateDrawingManagerControlColor(r);initializeZoom(t);initializeCenter(t);initializeRectangleZone(t);initializePolygonZone(t);google.maps.event.addListener(drawingmanager,"polygoncomplete",function(n){drawedPolygon=n;let t=n.getPath().getArray();drawingmanager.setDrawingMode(null);drawingmanager.setMap(null);$("input#googlePolCords").val(mapCoordsArray2JSON(t));$("input#zoneShape").val(google.maps.drawing.OverlayType.POLYGON);$("#zoneArea").val(google.maps.geometry.spherical.computeArea(t))});google.maps.event.addListener(drawingmanager,"rectanglecomplete",function(n){addCleanMapControl(t);drawedRectangle=n;let u=n.getBounds(),i=u.getNorthEast(),r=u.getSouthWest();drawingmanager.setDrawingMode(null);drawingmanager.setMap(null);$("input#googleRectCords").val(mapCoordsArray2JSON([i,r]));$("input#zoneShape").val(google.maps.drawing.OverlayType.RECTANGLE);$("#zoneArea").val(google.maps.geometry.spherical.computeArea([new google.maps.LatLng(i.lat(),i.lng()),new google.maps.LatLng(i.lat(),r.lng()),new google.maps.LatLng(r.lat(),r.lng()),new google.maps.LatLng(r.lat(),i.lng())]))});google.maps.event.addListener(t,"center_changed",function(){(t.getCenter().lat()!=0||t.getCenter().lng()!=0)&&$("#googleMapCenter").val(JSON.stringify({Latitud:t.getCenter().lat(),Longitud:t.getCenter().lng()}))});google.maps.event.addListener(t,"zoom_changed",function(){t.getZoom()==null||t.getZoom()==undefined||isNaN(t.getZoom())||$("#googleMapZoom").val(t.getZoom())})}}function centerCurrentLocation(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(n){let t={lat:n.coords.latitude,lng:n.coords.longitude};($("#googleMapCenter")==undefined||$("#googleMapCenter").val()==""||$("#googleMapCenter").val()==null||$("#googleMapCenter").val()==undefined)&&($("#map").dxMap({center:t}),$("#googleMapCenter").val(JSON.stringify({Latitud:n.coords.latitude,Longitud:n.coords.longitude})))})}function onInitialized(){}function dbCoordsArray2JSON(n){let t="[";for(let i=0;i<n.length;i++)t+=i<n.length-1?JSON.stringify({Latitud:n[i].Latitud,Longitud:n[i].Longitud})+",":JSON.stringify({Latitud:n[i].Latitud,Longitud:n[i].Longitud});return t+="]"}function mapCoordsArray2JSON(n){let t="[";for(let i=0;i<n.length;i++)t+=i<n.length-1?JSON.stringify({Latitud:n[i].lat(),Longitud:n[i].lng()})+",":JSON.stringify({Latitud:n[i].lat(),Longitud:n[i].lng()});return t+="]"}function getZoneObject(n){let h=$("input#idZoneEdit").val(),c=$("#txtName").dxTextBox("instance").option("value"),l=$("#selectColor").dxColorBox("instance").option("value"),a=$("#selectTimeZone").dxSelectBox("instance").option("value"),v=$("#selectTelecommutingType").dxSelectBox("instance").option("value"),y=$("#selectWorkCenter").dxSelectBox("instance").option("value"),p=$("#selectZoneSupervisor").dxSelectBox("instance").option("value"),w=$("#txtDescription").dxTextArea("instance").option("value"),b=$("#selectType").dxSwitch("instance").option("value"),k=$("#txtZoneCapacity").dxTextBox("instance").option("value"),d=$("#chkShowZoneCapacity").dxSwitch("instance").option("value"),g=$("#chkZoneNameAsLocation").dxSwitch("instance").option("value"),nt=$("#chkIsEmergencyZone").dxSwitch("instance").option("value"),i=$("input#googlePolCords").val(),r=$("input#googleRectCords").val(),tt=$("#gridInactiviyZones").dxDataGrid("instance").getDataSource().items(),it=$("#gridExceptionZones").dxDataGrid("instance").getDataSource().items(),f="",e="",rt=$("#zoneShape").val(),t=null,ut=$("#zoneArea").val(),o=null;$("#googleMapCenter")!=undefined&&$("#googleMapCenter").val()!=""&&(f=JSON.parse($("#googleMapCenter").val()));$("#googleMapZoom").val()==null||$("#googleMapZoom").val()==undefined||isNaN($("#googleMapZoom").val())||(e=JSON.parse($("#googleMapZoom").val()));i!=null&&i!=""&&(t=JSON.parse(i));r!=null&&r!=""&&(t=JSON.parse(r));t!=null&&(o={Center:f,Zoom:e,Shape:rt,Coordinates:t});let s=[],u=$("#gridIpRestrictions").dxDataGrid("instance").getDataSource().items();return u!=null&&u.length>0&&(s=u.map(function(n){return n.Ip})),{ID:n?-1:h,Name:c,Capacity:k,CapacityVisible:d,Color:l,DefaultTimezone:a,WorkCenter:y,Description:w,IsWorkingZone:b,IsEmergencyZone:nt,GoogleMapInfo:o,Area:ut,ZoneNameAsLocation:g,ZonesInactivity:tt,ZonesException:it,TelecommutingZoneType:v,Supervisor:p,IpsRestriction:s}}function addNewZone(){let n=getZoneObject(!0),i=$("#ckZoneLocationWorkingMode").dxSwitch("instance"),r=i.option("value"),t=!1;t=r?n.IpsRestriction==null||n.IpsRestriction!=null&&n.IpsRestriction.length==0:n.GoogleMapInfo==null;n.Name==""||n.DefaultTimezone==null||t?n.Name==""?DevExpress.ui.notify(viewUtilsManager.DXTranslate("roZoneSaveErrorName"),"error",3e3):n.DefaultTimezone==null?DevExpress.ui.notify(viewUtilsManager.DXTranslate("roZoneSaveErrorTimeZone"),"error",3e3):t&&DevExpress.ui.notify(viewUtilsManager.DXTranslate("roZoneSaveErrorGoogleCoords"),"error",3e3):$.ajax({type:"POST",url:BASE_URL+"Zones/InsertOrUpdateZone",contentType:"application/json; charset=utf-8",data:JSON.stringify(n),success:function(){DevExpress.ui.notify("¡Zona creada!","success",1e3);clearEditFields();RefreshZonesList();$("#editZonePopup").dxPopup("instance").hide()},error:function(n,t,i){DevExpress.ui.notify(i,"error",3e3)}})}function saveEditedZone(){let n=getZoneObject(!1),i=$("#ckZoneLocationWorkingMode").dxSwitch("instance"),r=i.option("value"),t=!1;t=r?n.IpsRestriction==null||n.IpsRestriction!=null&&n.IpsRestriction.length==0:n.GoogleMapInfo==null;n.Name==""||n.DefaultTimezone==null||t?n.Name==""?DevExpress.ui.notify(viewUtilsManager.DXTranslate("roZoneSaveErrorName"),"error",3e3):n.DefaultTimezone==null?DevExpress.ui.notify(viewUtilsManager.DXTranslate("roZoneSaveErrorTimeZone"),"error",3e3):t&&DevExpress.ui.notify(viewUtilsManager.DXTranslate("roZoneSaveErrorGoogleCoords"),"error",3e3):$.ajax({type:"POST",url:BASE_URL+"Zones/InsertOrUpdateZone",contentType:"application/json; charset=utf-8",data:JSON.stringify(n),success:function(){DevExpress.ui.notify("¡Zona actualizada!","success",1e3);clearEditFields();RefreshZonesList();$("#editZonePopup").dxPopup("instance").hide()},error:function(n,t,i){DevExpress.ui.notify(i,"error",3e3)}})}function inactivityZoneUpdating(n){n.newData==null?(n.cancel=!0,DevExpress.ui.notify(viewUtilsManager.DXTranslte("errorInactivityZones"),"error",3e3)):n.newData.Begin!=null?((n.newData.End!=null&&n.newData.Begin>=n.newData.End||n.newData.End==null&&n.newData.Begin>=n.oldData.End)&&(n.cancel=!0),DevExpress.ui.notify(viewUtilsManager.DXTranslate("incorrectDates"),"error",3e3),n.component.cancelEditData()):n.newData.End!=null&&((n.newData.Begin!=null&&n.newData.Begin>=n.newData.End||n.newData.Begin==null&&n.oldData.Begin>=n.newData.End)&&(n.cancel=!0),DevExpress.ui.notify(viewUtilsManager.DXTranslate("incorrectDates"),"error",3e3),n.component.cancelEditData())}function checkDaySelected(n){return n.data.WeekDay!=null}function inactivityZoneInserting(n){n.data.ChildData=[];n.data==null||n.data.WeekDay==null||n.data.Begin==null||n.data.End==null?(n.cancel=!0,DevExpress.ui.notify(viewUtilsManager.DXTranslate("errorInactivityZones"),"error",3e3),n.component.cancelEditData()):n.data.Begin>=n.data.End&&(n.cancel=!0,DevExpress.ui.notify(viewUtilsManager.DXTranslate("incorrectDates"),"error",3e3),n.component.cancelEditData())}function inactivityZonesNewRow(n){n.data.IDZone=$("#idZoneEdit").val()}function exceptionZoneInserting(n){n.data.ChildData=[];(n.data==null||n.data.ExceptionDate==null)&&(n.cancel=!0,DevExpress.ui.notify(viewUtilsManager.DXTranslate("errorExceptionZones"),"error",3e3),n.component.cancelEditData())}function exceptionZonesNewRow(n){n.data.IDZone=$("#idZoneEdit").val()}function onTimeZoneOpened(n){let t=n.component._list;t.option("useNativeScrolling")||(t.option("useNativeScrolling",!0),t._scrollView.option("useNative",!0),t.reload())}var drawedRectangle,drawedPolygon,openPopUp,drawingmanager,ipRestrictionEnabled;