function onTypeChange(n){if(n.value==null&&(n.value=-1),onTypeChangeEvent)onTypeChangeEvent=!1;else{var t=$("#gridRulesBots").dxDataGrid("instance");if(t&&t.totalCount()>0)return DevExpress.ui.notify("Debes eliminar todas las reglas para cambiar de tipo de bot.","error",6e3),onTypeChangeEvent=!0,n.component.option("value",n.previousValue),!1;botHasChanges(!0);$("#divBotsWhen").load("/Bots/GetBotTypeDescription?idTypeBot="+n.value,function(){currentBotView.Type=n.value})}}function beforeSend(){}function refreshRules(){$("#gridRulesBots").dxDataGrid("instance").refresh()}function RulesRemoved(){botHasChanges(!0)}function onCellPrepared(n){n.rowType=="header"&&n.cellElement.css("text-align","left")}function context_menu(){}function toolbar_preparing(){}function onRulePopupShown(){try{$.ajax({type:"POST",url:BASE_URL+"Bots/GetAvailableRulesForView",dataType:"json",data:{iBotType:currentBotView.Type},success:function(n){if(typeof n=="string")DevExpress.ui.notify(n,"error",5e3);else{$("#BotCreationRule").dxSelectBox("instance").option("dataSource",n);selectedRule?$("#BotCreationRule").dxSelectBox("instance").option("value",selectedRule?.row?.data?.Type):$("#BotCreationRule").dxSelectBox("instance").option("value",n[0]?.Id);let t=$("#BotsIdTemplate").data("dxSelectBox")||$("#BotsIdTemplateList").data("dxTagBox");t?t.NAME==="dxSelectBox"?t.option("value",selectedRule.row.data.IDTemplate):t.NAME==="dxTagBox"&&t.option("value",selectedRule.row.data.Definition.SourceIds):$("#ckruleActivated").dxCheckBox("instance").option("value",!0)}},error:function(){DevExpress.ui.notify(viewUtilsManager.DXTranslate("roBotSaved"),"error",2e3)}})}catch(n){console.error(n)}}function onRulePopupHiding(){$("#BotRuleName").dxTextBox("instance").option("value",null);$("#BotCreationRule").dxSelectBox("instance").option("value",null);$("#newRulePopup").dxPopup("instance").hide();$("#ckruleActivated").dxCheckBox("instance").option("value",!1);selectedRule&&(selectedRule=null);let n=$("#BotsIdTemplate").data("dxSelectBox")||$("#BotsIdTemplateList").data("dxTagBox");emptyField(n)}function onNewBotPopupShown(){}function onNewBotPopUpHidden(){}function saveBotPopUp(){var n,t;currentBotView.Id=0;n=$("#BotNameConfig").dxTextBox("instance").option("value");n?(t=AvailableBotTypes[0].Id,$("#divBotsMainView").load("/Bots/GetBotView?idView=-1&idTypeBot="+t,function(){$("#divBotsWhen").load("/Bots/GetBotTypeDescription?idTypeBot="+AvailableBotTypes[0].Id,function(){});BotRules=[];$("#gridRulesBots").dxDataGrid("instance").option("dataSource",BotRules);botHasChanges(!0);$("#BotName").dxTextBox("instance").option("value",n);$("#BotType").dxSelectBox("instance").option("value",t);$("#BotNameConfig").dxTextBox("instance").option("value",null);$("#newBotPopup").dxPopup("instance").hide()})):DevExpress.ui.notify(viewUtilsManager.DXTranslate("roBotWithoutName"),"error",2e3)}function cancelBotPopUp(){$("#BotNameConfig").dxTextBox("instance").option("value",null);$("#newBotPopup").dxPopup("instance").hide()}function onBotNameChange(){botHasChanges(!0)}function botHasChanges(n){try{var t=document.querySelector("#saveBar > div > div");hasChanges=n;t.style.display=n?"":"none"}catch(i){showError("hasChangesEventsScheduler",i)}}function isEmpty(n){for(const t in n)if(Object.hasOwn(n,t))return!1;return!0}function validateModel(n){return n.Id==null?(DevExpress.ui.notify(viewUtilsManager.DXTranslate("roBotWithoutId"),"error",2e3),!1):n.Name==null||!n.Name?(DevExpress.ui.notify(viewUtilsManager.DXTranslate("roBotWithoutName"),"error",2e3),!1):n.Type==null?(DevExpress.ui.notify(viewUtilsManager.DXTranslate("roBotWithoutType"),"error",2e3),!1):!0}function validateRuleModel(n,t,i,r){if(!n)return DevExpress.ui.notify(viewUtilsManager.DXTranslate("roRuleWithoutName"),"error",2e3),!1;if(t==null)return DevExpress.ui.notify(viewUtilsManager.DXTranslate("roRuleWithoutType"),"error",2e3),!1;if(i==null&&r==null)return DevExpress.ui.notify(viewUtilsManager.DXTranslate("roRuleWithoutIdTemplate"),"error",2e3),!1;return!0;var n,t,i}function undoChanges(){currentBotView.Id==0?(currentBotView={},BotRules=[],unselectCards(),$("#divBotsMainView").html("")):loadRequest(currentBotView.Id);botHasChanges(!1)}function addNewRule(){$("#newRulePopup").dxPopup("instance").show()}function saveRulePopUp(){var n=$("#BotRuleName").dxTextBox("instance").option("value"),t=$("#BotCreationRule").dxSelectBox("instance")?.option("value"),u=$("#ckruleActivated").dxCheckBox("instance").option("value"),i=$("#BotsIdTemplate").data("dxSelectBox")?.option("value"),r=$("#BotsIdTemplateList").data("dxTagBox")?.option("value"),f;validateRuleModel(n,t,i,r)&&(selectedRule?($("#gridRulesBots").dxDataGrid("instance").getDataSource().store().update(selectedRule.row.key,{Name:n,Type:t,IsActive:u,IDTemplate:i,Definition:{SourceIds:r}}),selectedRule=null):(f={Id:0,IdBot:currentBotView.Id,Type:t,Name:n,IsActive:u,IDTemplate:i,Definition:{SourceIds:r}},$("#gridRulesBots").dxDataGrid("instance").getDataSource().store().insert(f)),$("#gridRulesBots").dxDataGrid("instance").refresh(),botHasChanges(!0),$("#BotRuleName").dxTextBox("instance").option("value",null),$("#BotCreationRule").dxSelectBox("instance").option("value",null),$("#BotsIdTemplate").data("dxSelectBox")?.option("value",null),$("#BotsIdTemplateList").data("dxTagBox")?.option("value",null),$("#newRulePopup").dxPopup("instance").hide())}function cancelRulePopUp(){$("#newRulePopup").dxPopup("instance").hide()}function getWidth(){return document.documentElement.clientWidth-40}function getHeight(){return document.documentElement.clientHeight-40}function onRuleCreationChange(n){n.value!=null&&$("#divCreateRuleMainView").load("/Bots/GetRuleView?idRule="+n.value,function(){let n=$("#BotsIdTemplate").data("dxSelectBox")||$("#BotsIdTemplateList").data("dxTagBox"),t=n.getDataSource();t.reload();let i=t.store()._array;n.option("dataSource",new DevExpress.data.DataSource({store:{type:"array",data:i,key:"ID"},paginate:!0,pageSize:50,pageLoadMode:"scrollBottom"}))})}function deleteRulesNotFromType(){var t=ViewBag.AvailableRules,n=$("#gridRulesBots").dxDataGrid("instance"),i=n.filter(function(n){return t.some(function(t){return t.id===n.id})});n.splice(0,n.length,...i)}function GetCurrentBotView(){return currentBotView!=null&&currentBotView.Id!=null?currentBotView.Id:null}function onInitNewRow(n){n.data=addedRow;addedRow=null}function onRowRemoving(n){console.log(n)}function RuleSelected(n){n.row!=null&&($("#newRulePopup").dxPopup("instance").show(),$("#BotRuleName").dxTextBox("instance").option("value",n.row.data.Name),$("#BotCreationRule").dxSelectBox("instance").option("value",n.row.data.Type),$("#ckruleActivated").dxCheckBox("instance").option("value",n.row.data.IsActive),selectedRule=n)}function AllowModify(){return!0}function emptyField(n){n&&n.option("value",null)}var currentBotView={},hasChanges=!1,bAddNewBot=!1,addedRow={},BotRules=[],selectedRule=null,onTypeChangeEvent=!1;(function(){function e(n){var t=n.detail;viewUtilsManager.print(t.currentState+" state");switch(t.currentState){}}var n=null,i;$(document).ready(async function(){viewUtilsManager.initAccordions();viewUtilsManager.setupCardListFilterButton("Bots");viewUtilsManager.print("Bots Module loaded");n=viewUtilsManager.createViewStateHandler();window.addNewBot=u;window.deleteCurrentBot=i;window.deleteConfirmed=t;window.clearForm=f;window.loadRequest=r;window.saveData=o;window.refreshCardTree=viewUtilsManager.refreshCardTree;window.unselectCards=viewUtilsManager.unselectCards;document.addEventListener("startStateEvent",n=>e(n),!1);n.transition(n.value,"read");viewUtilsManager.loadViewOptions("Bots","read",function(){},()=>{},"LiveBots")});const r=()=>{$.ajax({type:"POST",url:BASE_URL+"Bots/GetBot",dataType:"json",data:{idBot:viewUtilsManager.getSelectedCardId()},success:function(n){typeof n=="string"?($("#divBotsMainView").html(""),DevExpress.ui.notify(n,"error",5e3)):(currentBotView=n,$("#divBotsMainView").load("/Bots/GetBotView?idView="+n.Id+"&idTypeBot="+n.Type,function(){BotRules=n.BotRules;$("#divBotsWhen").load("/Bots/GetBotTypeDescription?idTypeBot="+n.Type,function(){});$("#gridRulesBots").dxDataGrid("instance").option("dataSource",BotRules);$("#BotName").dxTextBox("instance").option("value",currentBotView.Name);$("#BotType").dxSelectBox("instance").option("value",currentBotView.Type);$("#BotType").dxSelectBox("instance").option("disabled",!0);botHasChanges(!1)}))},error:function(){DevExpress.ui.notify(viewUtilsManager.DXTranslate(currentBotView),"error",2e3);currentBotView={};BotRules=[]}})},u=()=>{$("#newBotPopup").dxPopup("instance").show()},f=()=>{$("#BotName").dxTextBox("instance").option("value",null),$("#BotType").dxSelectBox("instance").option("value",null)},t=()=>{if(window.loadingRequest=!0,isEmpty(currentBotView))DevExpress.ui.notify(viewUtilsManager.DXTranslate("roBotNoViewSelected"),"error",2e3);else if(currentBotView.Id==0)currentBotView={},BotRules=[],refreshCardTree(-1),botHasChanges(!1),unselectCards(),$("#divBotsMainView").html(""),window.loadingRequest=!1;else try{$.ajax({type:"DELETE",url:BASE_URL+"Bots/DeleteBot",dataType:"json",data:{idBot:viewUtilsManager.getSelectedCardId()},success:function(n){typeof n=="string"?DevExpress.ui.notify(n,"error",5e3):(currentBotView={},BotRules=[])},error:function(){DevExpress.ui.notify(viewUtilsManager.DXTranslate("roBotSaved"),"error",2e3)}})}catch(n){console.error(n)}finally{botHasChanges(!1);$("#divBotsMainView").html("");refreshCardTree(-1);window.loadingRequest=!1}};i=function(){var n=[];n.push(viewUtilsManager.buildButtonDialog("Yes","Yes",t));n.push(viewUtilsManager.buildButtonDialog("No","No",function(){}));viewUtilsManager.showModalDialog(this.parent.Robotics.Client.JSErrors.JSErrorTypes.roJsWarning,"","roJsWarning","roBotConfirmDelete",n)};const o=()=>{if(currentBotView.Name=$("#BotName").dxTextBox("instance").option("value"),currentBotView.Type=$("#BotType").dxSelectBox("instance").option("value"),currentBotView.BotRules=BotRules,validateModel(currentBotView))try{$.ajax({type:"POST",url:BASE_URL+"Bots/CreateOrUpdateBot",dataType:"json",data:{oBotParam:currentBotView},success:function(n){typeof n=="string"?DevExpress.ui.notify(n,"error",5e3):(currentBotView=n,refreshCardTree(n.Id),botHasChanges(!1))},error:function(){DevExpress.ui.notify(viewUtilsManager.DXTranslate(currentBotView),"error",2e3)}})}catch(n){console.error(n)}}})();