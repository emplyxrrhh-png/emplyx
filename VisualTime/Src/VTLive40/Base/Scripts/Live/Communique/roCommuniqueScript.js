(function () {
    const AL_LLEGAR_A_LA_FECHA_Y_HORA = window.parent.Globalize.formatMessage(
        "AL_LLEGAR_A_LA_FECHA_Y_HORA"
    );

    const CUANDO_QUIERES_ENVIAR = window.parent.Globalize.formatMessage(
        "CUANDO_QUIERES_ENVIAR"
    );

    const CUANDO_HAYAN_RESPONDIDO_MAS_DEL = window.parent.Globalize.formatMessage(
        "CUANDO_HAYAN_RESPONDIDO_MAS_DEL"
    );
    const ES_OBLIGATORIO_LEER_Y_CONTESTAR_AL_ENTRAR_A_VISUAL_TIME_PORTAL = window.parent.Globalize.formatMessage(
        "ES_OBLIGATORIO_LEER_Y_CONTESTAR_AL_ENTRAR_A_VISUAL_TIME_PORTAL"
    );
    const COLGAR_EN_EL_TABLON_DE_ANUNCIOS = window.parent.Globalize.formatMessage(
        "COLGAR_EN_EL_TABLON_DE_ANUNCIOS"
    );
    const ASEGURESE_DE_GUARDAR_CAMBIOS_QUIERE_PERDER_NUEVO_COMUNICADO = window.parent.Globalize.formatMessage(
        "ASEGURESE_DE_GUARDAR_CAMBIOS_QUIERE_PERDER_NUEVO_COMUNICADO"
    );
    const GUARDAR_COMUNICADO = window.parent.Globalize.formatMessage(
        "GUARDAR_COMUNICADO"
    );
    const ENVIAR_COMUNICADO = window.parent.Globalize.formatMessage(
        "ENVIAR_COMUNICADO"
    );
    const CANCELAR_COMUNICADO = window.parent.Globalize.formatMessage(
        "CANCELAR_COMUNICADO"
    );
    const QUIERE_SEGUIR_PERDER_CAMBIOS = window.parent.Globalize.formatMessage(
        "QUIERE_SEGUIR_PERDER_CAMBIOS"
    );
    const NO_SE_HA_PODIDO_CANCELAR = window.parent.Globalize.formatMessage(
        "NO_SE_HA_PODIDO_CANCELAR"
    );
    const NO_SE_HA_PODIDO_REACTIVAR = window.parent.Globalize.formatMessage(
        "NO_SE_HA_PODIDO_REACTIVAR"
    );
    const REACTIVAR_COMUNICADO = window.parent.Globalize.formatMessage(
        "REACTIVAR_COMUNICADO"
    );
    const PARA_MANDAR_COMUNICADO_DEBE_CONTENER = window.parent.Globalize.formatMessage(
        "PARA_MANDAR_COMUNICADO_DEBE_CONTENER"
    );
    const PARA_MANDAR_COMUNICADO_DEBE_TENER_DESTINATARIOS = window.parent.Globalize.formatMessage(
        "PARA_MANDAR_COMUNICADO_DEBE_TENER_DESTINATARIOS"
    );
    const ASUNTO = window.parent.Globalize.formatMessage("ASUNTO");
    const MENSAJE = window.parent.Globalize.formatMessage("MENSAJE");
    const ELIMINAR_COMUNICADO = window.parent.Globalize.formatMessage(
        "ELIMINAR_COMUNICADO"
    );
    const SEGURO_QUIERE_ELIMINAR_COMUNICADO = window.parent.Globalize.formatMessage(
        "SEGURO_QUIERE_ELIMINAR_COMUNICADO"
    );
    const EMPLEADO = window.parent.Globalize.formatMessage("roEmployeeName");
    const GRUPO = window.parent.Globalize.formatMessage("roActualGroup");
    const COMUNICADO = window.parent.Globalize.formatMessage("COMUNICADO");
    const ESCRIBE_AQUI = window.parent.Globalize.formatMessage("ESCRIBE_AQUI");
    const ANADIR_ADJUNTOS = window.parent.Globalize.formatMessage(
        "ANADIR_ADJUNTOS"
    );
    const ADJUNTAR = window.parent.Globalize.formatMessage("ADJUNTAR");
    const HASTA_X_ADJUNTOS = window.parent.Globalize.formatMessage(
        "HASTA_X_ADJUNTOS",
        ["2"]
    );
    const MAXIMO_X_ADJUNTOS = window.parent.Globalize.formatMessage(
        "MAXIMO_X_ADJUNTOS",
        ["2"]
    );
    const ADJUNTAR_DOCUMENTOS = window.parent.Globalize.formatMessage(
        "ADJUNTAR_DOCUMENTOS"
    );
    const ES_DE_LECTURA_OBLIGATORIA = window.parent.Globalize.formatMessage(
        "ES_DE_LECTURA_OBLIGATORIA"
    );
    const PARA = window.parent.Globalize.formatMessage("PARA");
    const SELECCIONADOS = window.parent.Globalize.formatMessage("SELECCIONADOS");
    const SELECCIONA_DESTINATARIOS = window.parent.Globalize.formatMessage(
        "SELECCIONA_DESTINATARIOS"
    );
    const RESPUESTAS = window.parent.Globalize.formatMessage("RESPUESTAS");
    const PERMITIR_RESPUESTAS_PERSONALIZADAS = window.parent.Globalize.formatMessage(
        "PERMITIR_RESPUESTAS_PERSONALIZADAS"
    );
    const ANADE_OPCIONES_DE_RESPUESTA = window.parent.Globalize.formatMessage(
        "ANADE_OPCIONES_DE_RESPUESTA"
    );
    const ELIMINAR_RESPUESTA = window.parent.Globalize.formatMessage(
        "ELIMINAR_RESPUESTA"
    );
    const MAX_RESPUESTAS = 4;
    const ANADOR_RESPUESTA_MAXIMO_DE_X = window.parent.Globalize.formatMessage(
        "ANADOR_RESPUESTA_MAXIMO_DE_X",
        [MAX_RESPUESTAS]
    );
    const MAXIMO_DE_X_RESPUESTAS_POSIBLES = window.parent.Globalize.formatMessage(
        "MAXIMO_DE_X_RESPUESTAS_POSIBLES",
        [MAX_RESPUESTAS]
    );
    const ANADIR_OPCION_DE_RESPUESTA = window.parent.Globalize.formatMessage(
        "ANADIR_OPCION_DE_RESPUESTA"
    );
    const PERMITIR_CAMBIAR_DE_OPINION = window.parent.Globalize.formatMessage(
        "PERMITIR_CAMBIAR_DE_OPINION"
    );
    const ANADE_OPCIONES_DE_RESPUESTA_PARA_HABILITAR = window.parent.Globalize.formatMessage(
        "ANADE_OPCIONES_DE_RESPUESTA_PARA_HABILITAR"
    );
    const BORRADOR = window.parent.Globalize.formatMessage("BORRADOR");
    const ENVIADO = window.parent.Globalize.formatMessage("ENVIADO");
    const CADUCADO = window.parent.Globalize.formatMessage("CADUCADO");
    const CANCELADO = window.parent.Globalize.formatMessage("CANCELADO");
    const LECTURA_OBLIGATORIA = window.parent.Globalize.formatMessage(
        "LECTURA_OBLIGATORIA"
    );
    const ADJUNTOS = window.parent.Globalize.formatMessage("ADJUNTOS");
    const DESCARGAR_DOCUMENTO = window.parent.Globalize.formatMessage(
        "DESCARGAR_DOCUMENTO"
    );
    const ELIMINAR_DOCUMENTO_ADJUNTO = window.parent.Globalize.formatMessage(
        "ELIMINAR_DOCUMENTO_ADJUNTO"
    );
    const QUIERE_BORRAR_DEFINITIVAMENTE_EL_ADJUNTO = window.parent.Globalize.formatMessage(
        "QUIERE_BORRAR_DEFINITIVAMENTE_EL_ADJUNTO"
    );
    const BORRAR_ADJUNTO = window.parent.Globalize.formatMessage(
        "BORRAR_ADJUNTO"
    );
    const DESTINATARIOS = window.parent.Globalize.formatMessage("DESTINATARIOS");
    const NO_HAY_OPCIONES_DE_RESPUESTA = window.parent.Globalize.formatMessage(
        "NO_HAY_OPCIONES_DE_RESPUESTA"
    );
    const CADUCIDAD = window.parent.Globalize.formatMessage("CADUCIDAD");
    const PLANIFICACION = window.parent.Globalize.formatMessage("PLANIFICACION");
    const LEIDOS = window.parent.Globalize.formatMessage("LEIDOS");
    const PENDIENTES = window.parent.Globalize.formatMessage("PENDIENTES");
    const LISTA_DE_RESULTADOS = window.parent.Globalize.formatMessage(
        "LISTA_DE_RESULTADOS"
    );
    const LEIDO = window.parent.Globalize.formatMessage("LEIDO");
    const RESPONDIDO = window.parent.Globalize.formatMessage("RESPONDIDO");
    const RESPUESTA = window.parent.Globalize.formatMessage("RESPUESTA");
    const FECHA_LECTURA = window.parent.Globalize.formatMessage("FECHA_LECTURA");
    const FECHA_RESPUESTA = window.parent.Globalize.formatMessage(
        "FECHA_RESPUESTA"
    );
    const EXPORTAR_DATOS_FILTRADOS = window.parent.Globalize.formatMessage(
        "EXPORTAR_DATOS_FILTRADOS"
    );
    const LISTA_RESULTADOS_COMUNICADO = window.parent.Globalize.formatMessage(
        "LISTA_RESULTADOS_COMUNICADO"
    );
    const PARA_GUARDAR_COMUNICADO_DEBE_CONTENER_ASUNTO = window.parent.Globalize.formatMessage(
        "PARA_GUARDAR_COMUNICADO_DEBE_CONTENER_ASUNTO"
    );
    const NO_SE_HA_PODIDO_GUARDAR_COMUNICADO = window.parent.Globalize.formatMessage(
        "NO_SE_HA_PODIDO_GUARDAR_COMUNICADO"
    );
    const DESCARTAR_CAMBIOS = window.parent.Globalize.formatMessage(
        "DESCARTAR_CAMBIOS"
    );
    const ARCHIVAR_COMUNICADO = window.parent.Globalize.formatMessage(
        "ARCHIVAR_COMUNICADO"
    );
    const NO_SE_HA_PODIDO_ARCHIVAR_COMUNICADO = window.parent.Globalize.formatMessage(
        "NO_SE_HA_PODIDO_ARCHIVAR_COMUNICADO"
    );
    const DESARCHIVAR_COMUNICADO = window.parent.Globalize.formatMessage(
        "DESARCHIVAR_COMUNICADO"
    );
    const NO_SE_HA_PODIDO_DESARCHIVAR_COMUNICADO = window.parent.Globalize.formatMessage(
        "NO_SE_HA_PODIDO_DESARCHIVAR_COMUNICADO"
    );
    const NO_HAY_COMUNICADOS_ARCHIVADOS = window.parent.Globalize.formatMessage(
        "NO_HAY_COMUNICADOS_ARCHIVADOS"
    );
    const COMUNICADOS_ARCHIVADOS = window.parent.Globalize.formatMessage(
        "COMUNICADOS_ARCHIVADOS"
    );

    const INSERTAR_TABLA = window.parent.Globalize.formatMessage(
        "INSERTAR_TABLA"
    );

    const NUMERO_FILAS = window.parent.Globalize.formatMessage(
        "NUMERO_FILAS"
    );

    const NUMERO_COLUMNAS = window.parent.Globalize.formatMessage(
        "NUMERO_COLUMNAS"
    );

    DevExpress.localization.loadMessages({
        "es": {
            "dxHtmlEditor-dialogInsertTableCaption": INSERTAR_TABLA,
            "dxHtmlEditor-dialogInsertTableRowsField": NUMERO_FILAS,
            "dxHtmlEditor-dialogInsertTableColumnsField": NUMERO_COLUMNAS
        },
        "zh": {
            "dxHtmlEditor-dialogInsertTableCaption": INSERTAR_TABLA,
            "dxHtmlEditor-dialogInsertTableRowsField": NUMERO_FILAS,
            "dxHtmlEditor-dialogInsertTableColumnsField": NUMERO_COLUMNAS
        },
        "pt": {
            "dxHtmlEditor-dialogInsertTableCaption": INSERTAR_TABLA,
            "dxHtmlEditor-dialogInsertTableRowsField": NUMERO_FILAS,
            "dxHtmlEditor-dialogInsertTableColumnsField": NUMERO_COLUMNAS
        },
        "it": {
            "dxHtmlEditor-dialogInsertTableCaption": INSERTAR_TABLA,
            "dxHtmlEditor-dialogInsertTableRowsField": NUMERO_FILAS,
            "dxHtmlEditor-dialogInsertTableColumnsField": NUMERO_COLUMNAS
        },
        "gl": {
            "dxHtmlEditor-dialogInsertTableCaption": INSERTAR_TABLA,
            "dxHtmlEditor-dialogInsertTableRowsField": NUMERO_FILAS,
            "dxHtmlEditor-dialogInsertTableColumnsField": NUMERO_COLUMNAS
        },
        "fr": {
            "dxHtmlEditor-dialogInsertTableCaption": INSERTAR_TABLA,
            "dxHtmlEditor-dialogInsertTableRowsField": NUMERO_FILAS,
            "dxHtmlEditor-dialogInsertTableColumnsField": NUMERO_COLUMNAS
        },
        "eu": {
            "dxHtmlEditor-dialogInsertTableCaption": INSERTAR_TABLA,
            "dxHtmlEditor-dialogInsertTableRowsField": NUMERO_FILAS,
            "dxHtmlEditor-dialogInsertTableColumnsField": NUMERO_COLUMNAS
        },
        "en": {
            "dxHtmlEditor-dialogInsertTableCaption": INSERTAR_TABLA,
            "dxHtmlEditor-dialogInsertTableRowsField": NUMERO_FILAS,
            "dxHtmlEditor-dialogInsertTableColumnsField": NUMERO_COLUMNAS
        },
        "ca": {
            "dxHtmlEditor-dialogInsertTableCaption": INSERTAR_TABLA,
            "dxHtmlEditor-dialogInsertTableRowsField": NUMERO_FILAS,
            "dxHtmlEditor-dialogInsertTableColumnsField": NUMERO_COLUMNAS
        }
    });

    const state = {
        communiques: {
            0: {
                Id: 0,
                Subject: "",
                Message: "",
                Employees: [],
                AdvancedEmployees: [],
                Groups: [],
                AdvancedGroups: [],
                CreatedBy: 1,
                SentOn: "",
                IdCompany: 0,
                Documents: [],
                AllowedResponses: [],
                AllowCustomResponses: true,
                AllowChangeResponse: true,
                ExpirationDate: "2079-01-01T00:00:00",
                ResponsePercentageLimit: 75,
                forceFeedback: 0,
                MandatoryRead: false,
                Status: 0,
                expiration: [
                    {
                        option: 1,
                        active: false,
                    },
                    { option: 2, active: false },
                ],
                Statistics: [],
            },
        },
        //files: { 1: { id: 1, name: "Archivo 1" }, 2: { id: 2, name: "Archivo 2" } },
        drafts: [2, 3],
        sent: [0, 1],
        feedbackOptions: [
            ES_OBLIGATORIO_LEER_Y_CONTESTAR_AL_ENTRAR_A_VISUAL_TIME_PORTAL,
            COLGAR_EN_EL_TABLON_DE_ANUNCIOS,
        ],
        selectedCommunique: 0,
        expirations: {
            1: {
                id: 1,
                label: AL_LLEGAR_A_LA_FECHA_Y_HORA,
                defaultValue: new Date(
                    new Date().setDate(new Date().getDate() + 1)
                ).setHours(0, 0, 0, 0),
            },
            2: { id: 2, label: CUANDO_HAYAN_RESPONDIDO_MAS_DEL },
        },
        planifications: {
            1: {
                id: 1,
                label: CUANDO_QUIERES_ENVIAR,
                defaultValue: new Date(
                    new Date().setDate(new Date().getDate() + 1)
                ).setHours(0, 0, 0, 0),
            }
        },
        inEdition: false,
    };

    let $communiqueCards;
    let $customSearchBar;
    let $fieldsEditor;
    const messageWrapper = "div#messageCommunique > div.widgetForm",
        configWrapper = "div#configCommunique > div.widgetForm",
        commReadOnlyWrapper = "div#messageCommunique > div.widgetForm",
        confReadOnlyWrapper = "div#configCommunique > div.widgetForm",
        statisticsWrapper = "div#statisticsCommunique > div.widgetStatistics";

    $(document).ready(async function () {
        $communiqueCards = document.querySelectorAll(".communiqueCard");
        $customSearchBar = document.querySelector("#customSearchBar");
        $fieldsEditor = document.querySelector("#fieldsEditor");
        window.reloadCardsPanel = reloadCardsPanel;

        const allCommuniques = await getAllCommuniques();
        allCommuniques.map((communique) => formatCommuniqueToClient(communique));

        await buildMainButtons(
            "div.switchMainViewTabs",
            state.communiques[state.selectedCommunique]
        );

        /*---------------------------LISTENERS LISTENERS LISTENERS LISTENERS ------------------------*/
        $($communiqueCards).off("click", handleCardClick);
        $($communiqueCards).on("click", handleCardClick);
        $($customSearchBar).on("keyup", () => handleSearch(""));
        /*---------------------------LISTENERS LISTENERS LISTENERS LISTENERS ------------------------*/

        //select first card
        //if ($communiqueCards.length > 0) {
        //$communiqueCards[0].click();
        reloadCardsPanel();
        //filterCommuniquesBy("active");
        /* } else {
            handleNewCommunique();
        } */

        $('#communiqueeConfiguration').off("click");
        $('#communiqueeConfiguration').on("click", function (e) {
            $("#configCommunique").show();
            $("#messageCommunique").hide();
            $("#statisticsCommunique").hide();
            $("#communiqueStatisticsContainer .VTpageSeparator").hide();
            $("#communiqueeConfiguration").addClass("bTabCommuniquees-active")
            $("#communiqueeDesign").removeClass("bTabCommuniquees-active")
            $("#communiqueeResults").removeClass("bTabCommuniquees-active")
        });

        $('#communiqueeDesign').off("click");
        $('#communiqueeDesign').on("click", function (e) {
            $("#configCommunique").hide();
            $("#messageCommunique").show();
            $("#statisticsCommunique").hide();
            $("#communiqueStatisticsContainer .VTpageSeparator").hide();
            $("#communiqueeConfiguration").removeClass("bTabCommuniquees-active")
            $("#communiqueeDesign").addClass("bTabCommuniquees-active")
            $("#communiqueeResults").removeClass("bTabCommuniquees-active")
        });

        $('#communiqueeResults').off("click");
        $('#communiqueeResults').on("click", function (e) {
            $("#configCommunique").hide();
            $("#messageCommunique").hide();
            $("#statisticsCommunique").show();
            $("#communiqueStatisticsContainer .VTpageSeparator").show();
            $("#communiqueeConfiguration").removeClass("bTabCommuniquees-active")
            $("#communiqueeDesign").removeClass("bTabCommuniquees-active")
            $("#communiqueeResults").addClass("bTabCommuniquees-active")
        });
    });

    window.parentCloseAndApplySelector = function (currentSelection) {
        var comm = state.communiques[state.selectedCommunique];

        comm.Employees = currentSelection.Employees;
        comm.Groups = currentSelection.Groups;

        buildConfig(configWrapper, comm, state);
        setEditing(true);
    };

    const setEditing = (inEdition = true) => {
        state.inEdition = inEdition;
        const discartOrSaveDivs = [
            ...document.querySelectorAll(".saveOrDiscartDiv"),
        ];

        if (inEdition) {
            discartOrSaveDivs.map((d) => (d.style.display = ""));
        } else {
            discartOrSaveDivs.map((d) => (d.style.display = "none"));
        }
    };

    async function handleCardClick() {
        let userConfims = true;

        if (state.selectedCommunique === -1 && state.inEdition === true) {
            userConfims = await DevExpress.ui.dialog.confirm(
                ASEGURESE_DE_GUARDAR_CAMBIOS_QUIERE_PERDER_NUEVO_COMUNICADO,
                GUARDAR_COMUNICADO
            );
            setEditing(false);
        }

        if (state.inEdition === true) {
            userConfims = await DevExpress.ui.dialog.confirm(
                QUIERE_SEGUIR_PERDER_CAMBIOS,
                GUARDAR_COMUNICADO
            );
            setEditing(false);
        }

        if (userConfims) {
            delete state.communiques[-1];

            const communiqueId = $(this)
                .find(".communiqueCardInfo")
                .attr("data-communique-id");

            //take source to preview, set it to current communique
            const communique = await getCommunique(communiqueId);
            state.selectedCommunique = communiqueId;

            //build report

            buildCommunique(
                {
                    message: messageWrapper,
                    config: configWrapper,
                    commReadOnly: commReadOnlyWrapper,
                    confReadOnly: confReadOnlyWrapper,
                    statistics: statisticsWrapper,
                },
                state.communiques[state.selectedCommunique],
                state
            );

            buildMainButtons(
                "div.switchMainViewTabs",
                (!communique && state.communiques[communiqueId]) || communique
            );

            handleCardClickStyles($(this));
        } else {
            return;
        }
    }

    const handleShrinkExpandCommTree = (shrinkBtn, expandBtn, isShrink) => {
        const divTree = document.querySelector("#divTree");
        if (isShrink) {
            divTree.style.display = "none";
            shrinkBtn.style.display = "none";
            expandBtn.style.display = "";
        } else {
            divTree.style.display = "";
            expandBtn.style.display = "none";
            shrinkBtn.style.display = "";
        }
    };

    const handleCardClickStyles = (thisCard) => {
        //reset styles
        [...document.querySelectorAll(".communiqueCard")].map((card) => {
            card.classList.remove("communiqueCardClicked");
        });

        //apply new styles
        thisCard.addClass("communiqueCardClicked");
    };

    const filterCommuniquesBy = async (filter) => {
        // change viewTab active
        // display none for all communiques not this filter

        const communiqueCards = [...document.querySelectorAll(".communiqueCard")];

        if (filter === "active") {
            communiqueCards.map((card) => {
                const commId = card
                    .getElementsByClassName("communiqueCardInfo")[0]
                    .getAttribute("data-communique-id");

                card.style.display =
                    state.communiques[commId] && state.communiques[commId].Archived
                        ? "none"
                        : "";
            });
        } else if (filter === "archived") {
            communiqueCards.map((card) => {
                const commId = card
                    .getElementsByClassName("communiqueCardInfo")[0]
                    .getAttribute("data-communique-id");

                card.style.display =
                    state.communiques[commId] && state.communiques[commId].Archived
                        ? ""
                        : "none";
            });
        }

        //if current communique is visible do nothing
        const currentCommCardChild = document.querySelector(
            `.communiqueCard div[data-communique-id='${state.selectedCommunique}']`
        );

        let currentCommCard;
        if (state.selectedCommunique !== 0 && state.selectedCommunique !== -1) {
            if (!currentCommCardChild) {
                reloadCardsPanel();
                return;
                //reloadCardsList(state.selectedCommunique);
            }
            currentCommCard = currentCommCardChild.parentElement.parentElement;
        } else {
            currentCommCard = communiqueCards.find(
                (card) => card.style.display !== "none"
            );
        }

        if (!!currentCommCard && currentCommCard.style.display !== "none") {
            currentCommCard.click();
        } else {
            const firstCommuniqueCard = communiqueCards.find(
                (card) => card.style.display !== "none"
            );
            if (firstCommuniqueCard) {
                firstCommuniqueCard.click();
            } else if (filter === "active") {
                const existsActive = Object.keys(state.communiques).find(
                    (commId) => commId !== "0" && !state.communiques[commId].Archived
                );
                if (!existsActive) handleNewCommunique();
            } else if (filter === "archived") {
                DevExpress.ui.dialog.alert(
                    NO_HAY_COMUNICADOS_ARCHIVADOS,
                    COMUNICADOS_ARCHIVADOS
                );
                document.querySelector("#filterActiveCommBtn").click();
            }
        }
    };

    function handleSearch(forceReload = "") {
        const originSearch = document.querySelector("#CardView_DXSE_I");
        originSearch.value =
            originSearch.value === `${$customSearchBar.value}${forceReload}`
                ? `${$customSearchBar.value}`
                : `${$customSearchBar.value}${forceReload}`;

        originSearch.onchange();

        reloadCardsPanel();
    }

    const base64ToarrayBlob = (b64Data) => {
        const byteCharacters = atob(b64Data);
        const byteNumbers = new Array(byteCharacters.length);

        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }

        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: "application/octet-binary" });
    };

    const handleDownloadFileClicked = (file) => {
        const fileName = file.name || file.Title;
        const fileBlob = file.name ? file : base64ToarrayBlob(file.Document);
        const aElement = document.createElement("a");

        aElement.setAttribute("download", fileName);
        aElement.setAttribute("href", window.URL.createObjectURL(fileBlob));
        aElement.click();
        aElement.remove();
    };

    const handleNewCommunique = async () => {
        $("#communiqueeResults").hide();
        const newCommunique = {
            ...state.communiques[0],
            Id: -1,
            CreatedOn: Date.now(),
            Subject: "",
            Message: "",
            Employees: [],
            AdvancedEmployees: [],
            Groups: [],
            AdvancedGroups: [],
            CreatedBy: 1,
            SentOn: "",
            IdCompany: 0,
            Documents: [],
            AllowedResponses: [],
            AllowChangeResponse: true,
            ExpirationDate: "2079-01-01T00:00:00",
            PlanificationDate: "2000-01-01T00:00:00",
            ResponsePercentageLimit: 75,
            forceFeedback: 0,
            MandatoryRead: false,
            Status: 0,
            expiration: [
                {
                    option: 1,
                    active: false,
                },
                { option: 2, active: false },
            ],
            planification: [
                {
                    option: 1,
                    active: false,
                }
            ],
            Statistics: [],
        };
        state.communiques[newCommunique.Id] = newCommunique;
        state.selectedCommunique = newCommunique.Id;

        buildCommunique(
            {
                message: messageWrapper,
                config: configWrapper,
                commReadOnly: commReadOnlyWrapper,
                confReadOnly: confReadOnlyWrapper,
                statistics: statisticsWrapper,
            },
            newCommunique,
            state
        );

        await buildMainButtons("div.switchMainViewTabs", newCommunique);

        [...document.querySelectorAll(".communiqueCard")].map((card) => {
            card.classList.remove("communiqueCardClicked");
        });

        if ($("#EmployeeText").dxTagBox("instance") != null)
            $("#EmployeeText").dxTagBox("instance").option("value", null);
        if ($("#GroupText").dxTagBox("instance") != null)
            $("#GroupText").dxTagBox("instance").option("value", null);

        setEditing(true);
        await cleanAttachedFilesFromSession();
    };

    const handleSendCommunique = async (comm) => {
        if (comm.Subject.length < 1) {
            DevExpress.ui.dialog.alert(
                PARA_MANDAR_COMUNICADO_DEBE_CONTENER + ASUNTO,
                ENVIAR_COMUNICADO
            );
            return;
        }
        if (comm.Message.length < 1) {
            DevExpress.ui.dialog.alert(
                PARA_MANDAR_COMUNICADO_DEBE_CONTENER + MENSAJE,
                ENVIAR_COMUNICADO
            );
            return;
        }
        if (comm.Employees.length < 1 && comm.Groups.length < 1) {
            DevExpress.ui.dialog.alert(
                PARA_MANDAR_COMUNICADO_DEBE_TENER_DESTINATARIOS,
                ENVIAR_COMUNICADO
            );
            return;
        }

        /* 		//save
        const response = await saveCommunique(comm); */
        //send
        //if (response || !response) {
        const response = await saveCommunique({ ...comm, Status: 1 });
        if (response || !response) {
            reloadCardsList();
        }
        //}
    };

    const handleCancelCommunique = async (comm) => {
        comm.Status = 3;
        comm.Archived = true;
        const response = await saveCommunique(comm);
        if (!!response) {
            reloadCardsList();
            setEditing(false);
        } else {
            DevExpress.ui.dialog.alert(NO_SE_HA_PODIDO_CANCELAR, CANCELAR_COMUNICADO);
        }
    };

    const handleUncancelCommunique = async (comm) => {
        comm.Status = 1;
        const response = await saveCommunique(comm);
        if (!!response) {
            reloadCardsList();
            setEditing(false);
        } else {
            DevExpress.ui.dialog.alert(
                NO_SE_HA_PODIDO_REACTIVAR,
                REACTIVAR_COMUNICADO
            );
        }
    };

    const handleRemoveCommunique = async (comm) => {
        const userConfirms = await DevExpress.ui.dialog.confirm(
            SEGURO_QUIERE_ELIMINAR_COMUNICADO,
            ELIMINAR_COMUNICADO
        );

        if (userConfirms) {
            const response = await deleteCommunique(comm.Id);

            if (response || !response) {
                const communiqueId = $(".communiqueCard")
                    .first()
                    .find(".communiqueCardInfo")
                    .attr("data-communique-id");
                state.selectedCommunique = communiqueId;
                reloadCardsList();
            }
        }
    };

    const formatedCommuniqueToSave = async (props) => {
        //make a copy of props
        const communique = { ...props };

        communique.Id = props.Id === 0 ? -1 : props.Id;

        //check if expiration date is needed
        communique.ExpirationDate = props.expiration.find((exp) => exp.option === 1)
            .active
            ? communique.ExpirationDate
            : window.parent.moment(3439753200000).format("YYYY-MM-DDTHH:mm:ss");
        //check if planification date is needed
        communique.PlanificationDate = props.planification.find((plan) => plan.option === 1)
            .active
            ? communique.PlanificationDate
            : window.parent.moment.utc('2000-01-01T00:00:00').format("YYYY-MM-DDTHH:mm:ss");
        //check if percentage is needed
        communique.ResponsePercentageLimit = props.expiration.find(
            (exp) => exp.option === 2
        ).active
            ? communique.ResponsePercentageLimit
            : -1;

        //check if answers are empty
        communique.AllowedResponses = communique.AllowCustomResponses
            ? props.AllowedResponses.filter((asw) => asw.length > 0)
            : [];
        if (communique.AllowedResponses.length === 0) communique.AllowChangeResponse = false;

        //insert correct CreatedBy....FUCKKK
        communique.CreatedBy = await getCurrentEmployeePassport();

        communique.CreatedOn =
            typeof props.CreatedOn === "number"
                ? window.parent.moment(props.CreatedOn).format("YYYY-MM-DDTHH:mm:ss")
                : props.CreatedOn;

        //remove unnecessary props
        delete communique.expiration;
        delete communique.planification;
        delete communique.forceFeedback;
        //delete communique.attached;
        delete communique.Asunto;
        delete communique.Mensaje;

        return communique;
    };

    const formatCommuniqueToClient = (props) => {
        if (!props) return;

        props = {
            Communique: !!props.Communique ? props.Communique : props,
            Statistics: !!props.EmployeeCommuniqueStatus
                ? props.EmployeeCommuniqueStatus
                : {},
        };

        const communique = {
            Groups: [],
            Employees: [],
            ...props.Communique,
            Documents: props.Communique.Documents.map(
                (doc) => ((doc.Title = `${doc.Title}${doc.DocumentType}`), doc)
            ),
            ExpirationDate:
                props.Communique.ExpirationDate === "2079-01-01T00:00:00"
                    ? "2079-01-01T00:00:00"
                    : props.Communique.ExpirationDate,
            expiration: [
                {
                    option: 1,
                    active: props.Communique.ExpirationDate !== "2079-01-01T00:00:00",
                },
                {
                    option: 2,
                    active:
                        !props.Communique.ResponsePercentageLimit ||
                            props.Communique.ResponsePercentageLimit === -1
                            ? false
                            : true,
                },
            ],
            PlanificationDate:
                props.Communique.PlanificationDate === "2000-01-01T00:00:00"
                    ? "2000-01-01T00:00:00"
                    : props.Communique.PlanificationDate,
            planification: [
                {
                    option: 1,
                    active: props.Communique.PlanificationDate !== "2000-01-01T00:00:00",
                }
            ],
            AllowCustomResponses: props.Communique.AllowedResponses.length !== 0,
            Statistics: props.Statistics,
        };

        state.communiques[props.Communique.Id] = communique;
        return communique;
    };

    const getCommunique = async (Id) => {
        let communique;
        await $.ajax({
            url: `${BASE_URL}Communique/GetCommunique`,
            data: { Id },
            type: "POST",
            dataType: "json",
            success: (data) => (communique = data),
            error: (error) => console.error(error),
        });

        return formatCommuniqueToClient(communique);
    };

    const getAllCommuniques = async () => {
        let allCommuniques;
        await $.ajax({
            url: `${BASE_URL}Communique/GetAllCommuniques`,
            data: {},
            type: "POST",
            dataType: "json",
            success: (data) => (allCommuniques = data),
            error: (error) => console.error(error),
        });

        return allCommuniques;
    };

    const getPermisionOverCommuniques = async () => {
        let permission;
        try {
            await $.ajax({
                url: `${BASE_URL}Communique/GetPermisionOverCommuniques`,
                data: {},
                type: "POST",
                dataType: "json",
                success: (data) => (permission = data),
                error: (error) => console.error(error),
            });
        } catch (error) {
            //console.log(error);
        } finally {
            //console.log("GetPermisionOverCommuniques", permission);
        }

        return permission;
    };

    const getPermissionToAttachDocuments = async () => {
        let permission;
        try {
            await $.ajax({
                url: `${BASE_URL}Communique/GetPermissionToAttachDocuments`,
                data: {},
                type: "POST",
                dataType: "json",
                success: (data) => (permission = data),
                error: (error) => console.error(error),
            });
        } catch (error) {
            //console.log(error);
        } finally {
            //console.log("GetPermissionToAttachDocuments", permission);
        }

        return permission;
    };

    const getViewTemplate = async (templateName) => {
        let template;
        await $.ajax({
            url: `${BASE_URL}Communique/GetViewTemplate`,
            data: { templateName },
            type: "POST",
            dataType: "html",
            success: (data) => (template = data),
            error: (error) => console.error(error),
        });

        return template;
    };

    const saveCommunique = async (props) => {
        let response = {};
        const communique = await formatedCommuniqueToSave(props);
        try {
            await $.ajax({
                url: `${BASE_URL}Communique/SaveCommunique`,
                data: { communique: JSON.stringify(communique) },
                type: "POST",
                dataType: "json",
                success: (data) => (response = data),
                error: (error) => console.error(error),
            });
        } catch (error) {
            console.error(error);
            response = false;
        } finally {
            // if (!!response.Status && response.Status === 0)
            if (!!response.Communique) {
                state.selectedCommunique = response.Communique.Id;
                state.communiques[response.Communique.Id] = response.Communique;
                setEditing(false);
            }
        }
        return response;
    };

    const removeAttachedFile = async (documentTitle) => {
        let response;
        try {
            await $.ajax({
                url: `${BASE_URL}Communique/RemoveAttachedFile`,
                data: { documentTitle },
                type: "POST",
                dataType: "text",
                success: (data) => (response = data),
                error: (error) => console.error(error),
            });
        } catch (error) {
            console.error(error);
        } finally {
            response = true;
        }
        return response;
    };

    const cleanAttachedFilesFromSession = async () => {
        let response;
        try {
            await $.ajax({
                url: `${BASE_URL}Communique/CleanAttachedFilesFromSession`,
                data: {},
                type: "POST",
                dataType: "text",
                success: (data) => (response = data),
                error: (error) => console.error(error),
            });
        } catch (error) {
            console.error(error);
        } finally {
            response = true;
        }
        return response;
    };

    const deleteCommunique = async (IdCommunique) => {
        let response;
        try {
            await $.ajax({
                url: `${BASE_URL}Communique/DeleteCommunique`,
                data: { IdCommunique },
                type: "POST",
                dataType: "text",
                success: (data) => (response = data),
                error: (error) => console.error(error),
            });
        } catch (error) {
            //console.log(error);
        } finally {
            response = true;
            delete state.communiques[IdCommunique];
            state.selectedCommunique = parseInt(
                state.communiques[Object.keys(state.communiques)[0]],
                10
            );
        }
        return response;
    };

    const getCurrentEmployeePassport = async () => {
        let passport;
        await $.ajax({
            url: `${BASE_URL}Communique/GetCurrentEmployeePassport`,
            data: {},
            type: "POST",
            dataType: "json",
            success: (data) => (passport = data),
            error: (error) => console.error(error),
        });

        return passport;
    };

    const calculateEmployees = (selector) => {
        const listOfSelections = selector
            .substring(0, selector.indexOf("@"))
            .split(",");
        const initState = {
            employees: [],
            groups: [],
        };

        return listOfSelections.reduce((selections, sel) => {
            if (sel.indexOf("A") > -1) {
                selections.groups.push(sel.substring(1, sel.length));
            } else if (sel.indexOf("B") > -1) {
                selections.employees.push(sel.substring(1, sel.length));
            }

            return selections;
        }, initState);
    };

    window.collectParamValues = async (param1, param2, param3) => {
        const comm = state.communiques[state.selectedCommunique];
        const employeesSelector = `${param1 || -1}@${param2 || -1}@${param3 || ""}`;

        const { employees, groups } = calculateEmployees(employeesSelector);
        comm.AdvancedEmployees = employees;
        comm.AdvancedGroups = groups;
    };

    const reloadCardsPanel = () => {
        const panel = document.querySelector(".dxcvCSD");
        resizePanel(panel);

        const $reportCards = [...document.querySelectorAll(".communiqueCard")];
        const cardsPanelObserver = buildCardsPanelObserver(panel);

        if ($reportCards.length > 0) {
            cardsPanelObserver.observe($reportCards[$reportCards.length - 1]);
        } else {
            //panel vacío
            document.querySelector("#commRemoveBtn").style.display = "none"; //ocultamos botón borrado si no existen comunicados en el listado
            document.querySelector("#commSendBtn").style.display = "none"; //ocultamos botón enviado si no existen comunicados en el listado
        }

        $(".communiqueCard").off("click", handleCardClick);
        $(".communiqueCard").on("click", handleCardClick);

        document.querySelector(".mainActionBtn.viewTab.activeTab").click();
    };

    const reloadCardsList = (selectedCard) => {
        $("#customSearchBar").val(null);
        handleSearch(" ");
        let counter = 0;
        const clickCardInterval = setInterval(() => {
            //console.warn("clickCardInterval", "iteration => " + counter);

            const card = document.querySelector(
                `.communiqueCard div[data-communique-id='${selectedCard || state.selectedCommunique
                }']`
            );
            if (card || counter === 60) {
                clearInterval(clickCardInterval);
                card.click();
            } else {
                counter++;
            }
        }, 1000);
    };

    window.onresize = () => {
        resizePanel(document.querySelector(".dxcvCSD"));
    };

    function resizePanel(panel) {
        panel.parentNode.style.height = `${window.innerHeight - 250}px`;
    }

    const buildCommunique = async (wrappers, comm, state) => {
        const permission = await getPermisionOverCommuniques();
        const permissionAttachments = await getPermissionToAttachDocuments();

        Object.entries(wrappers).map(
            (wrp) =>
            (document.querySelector(
                wrp[1]
            ).parentElement.parentElement.style.display = "none")
        );

        if (permission > 3) {
            if (typeof comm !== "undefined") {
                if (comm.Status === 0) {
                    buildMessage(wrappers.message, comm, state);
                    buildConfig(wrappers.config, comm, state);
                    if ($("#communiqueeResults").hasClass("bTabCommuniquees-active")) {
                        $("#communiqueeConfiguration").addClass("bTabCommuniquees-active");
                        $("#communiqueeResults").removeClass("bTabCommuniquees-active");
                        $("#communiqueeDesign").removeClass("bTabCommuniquees-active");
                        $("#configCommunique").show();
                        $("#messageCommunique").hide();
                    }
                    $("#communiqueeResults").hide();
                } else if (comm.Status > 0) {
                    buildCommReadOnly(wrappers.commReadOnly, wrappers.confReadOnly, comm, state);
                    buildStatistics(wrappers.statistics, comm, state);
                    $("#communiqueeResults").show();
                }
                if (comm.Id === -1) {
                    document.querySelector("#commRemoveBtn").style.display = "none"; //ocultamos botón borrado si no existen comunicados en el listado
                    document.querySelector("#commSendBtn").style.display = "none"; //ocultamos botón enviado si no existen comunicados en el listado
                }
                if (!permissionAttachments) {
                    $(".comm-config-fileuploader").hide()
                    $(".dx-field-item-label-text").filter(function () {
                        const elementText = $(this).text().replace(/\s+/g, ' ').trim();
                        return elementText === ANADIR_ADJUNTOS;
                    }).hide();
                }
            }
        } else {
            buildCommReadOnly(wrappers.commReadOnly, wrappers.confReadOnly, comm, state);
            buildStatistics(wrappers.statistics, comm, state);
            $("#communiqueeResults").show();
        }
    };

    const buildMessage = async (container, comm, state) => {
        $(container).empty();
        $(container).dxForm({
            formData: comm,
            width: "100%",
            name: "mainForm",
            alignItemLabels: true,
            alignItemLabelsInAllGroups: true,
            colCount: 4,
            items: [
                {
                    itemType: "group",
                    cssClass: "first-group",
                    name: "message",
                    colSpan: 4,
                    colCount: 3,
                    items: [
                        {
                            cssClass: "VTpageSeparator",
                            colSpan: 3,
                            label: { text: COMUNICADO, showColon: false },
                            itemType: "group",
                        },
                        {
                            dataField: ESCRIBE_AQUI,
                            label: { location: "top", showColon: false },
                            colSpan: 3,
                            cssClass: "form-group-indented communique-html-content",
                            editorType: "dxHtmlEditor",
                            editorOptions: {
                                elementAttr: { id: "messageEditor" },
                                height: 500,
                                value: comm.Message,
                                toolbar: {
                                    items: [
                                        {
                                            name: "undo",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandUndo")
                                            }
                                        },
                                        {
                                            name: "redo",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandRedo")
                                            }
                                        },
                                        "separator",
                                        {
                                            name: "size",
                                            acceptedValues: ["8pt", "10pt", "12pt", "14pt", "18pt", "24pt", "36pt"],
                                            options: {
                                                placeholder: window.parent.Globalize.formatMessage('dxHtmlEditor-commandFontSize'),
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-commandFontSize"),
                                                displayExpr: function (item) {
                                                    return window.parent.Globalize.formatMessage('dxHtmlEditor-commandFontSize')
                                                },
                                                itemTemplate: function (data, index, element) {
                                                    element.text(data)
                                                }
                                            }
                                        },
                                        {
                                            name: "font",
                                            acceptedValues: ["Arial", "Courier New", "Georgia", "Impact", "Lucida Console", "Tahoma", "Times New Roman", "Verdana"],
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-commandFontName"),
                                                placeholder: window.parent.Globalize.formatMessage('dxHtmlEditor-commandFontName'),
                                                displayExpr: function (item) {
                                                    return window.parent.Globalize.formatMessage('dxHtmlEditor-commandFontName')
                                                },
                                                itemTemplate: function (data, index, element) {
                                                    element.text(data)
                                                }
                                            }
                                        },
                                        "separator", {
                                            name: "bold",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandBold")
                                            }
                                        }, {
                                            name: "italic",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandItalic")
                                            }
                                        }, {
                                            name: "strike",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandStrike")
                                            }
                                        }, {
                                            name: "underline",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandUnderline")
                                            }
                                        }, "separator",
                                        {
                                            name: "alignLeft",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandAlignLeft")
                                            }
                                        }, {
                                            name: "alignCenter",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandAlignCenter")
                                            }
                                        }, {
                                            name: "alignRight",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandAlignRight")
                                            }
                                        }, {
                                            name: "alignJustify",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandAlignJustify")
                                            }
                                        }, "separator",
                                        {
                                            name: "orderedList",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-orderedList")
                                            }
                                        }, {
                                            name: "bulletList",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-bulletList")
                                            }
                                        }, "separator",
                                        {
                                            name: "header",
                                            acceptedValues: [false, 1, 2, 3, 4, 5],
                                            options: {
                                                placeholder: window.parent.Globalize.formatMessage('dxHtmlEditor-heading'),
                                                displayExpr: function (item) {
                                                    return window.parent.Globalize.formatMessage('dxHtmlEditor-heading')
                                                },
                                                itemTemplate: function (data, index, element) {
                                                    if (index === 0) {
                                                        element.text(window.parent.Globalize.formatMessage("dxHtmlEditor-normalText"))
                                                    }
                                                    else {
                                                        element.text(window.parent.Globalize.formatMessage("dxHtmlEditor-heading" + data))
                                                    }
                                                },
                                            }
                                        }, "separator",
                                        {
                                            name: "color",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-color")
                                            }
                                        }, {
                                            name: "background",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-background")
                                            }
                                        }, "separator",
                                        {
                                            name: "link",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-link")
                                            }
                                        },
                                        {
                                            widget: "dxButton",
                                            name: "image",
                                            options: {
                                                text: window.parent.Globalize.formatMessage("dxDiagram-commandInsertShapeImage"),
                                                stylingMode: "text",
                                                onClick: function () {
                                                    var popup = $("#addImagePopup").dxPopup("instance");
                                                    popup.show();
                                                },
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandInsertShapeImage")
                                            }
                                        }, "separator",
                                        {
                                            name: "clear",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("Clear")
                                            }
                                        }, {
                                            name: "codeBlock",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-codeblock")
                                            }
                                        }, "separator",
                                        {
                                            name: "insertTable",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-insertTable")
                                            }
                                        }, {
                                            name: "deleteTable",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-deleteTable")
                                            }
                                        },
                                        {
                                            name: "insertRowAbove",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-insertRowAbove")
                                            }
                                        }, {
                                            name: "insertRowBelow",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-insertRowBelow")
                                            }
                                        }, {
                                            name: "deleteRow",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-deleteRow")
                                            }
                                        },
                                        {
                                            name: "insertColumnLeft",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-insertColumnLeft")
                                            }
                                        }, {
                                            name: "insertColumnRight",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-insertColumnRight")
                                            }
                                        }, {
                                            name: "deleteColumn",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-deleteColumn")
                                            }
                                        }]
                                },
                                onValueChanged: (e) => {
                                    comm.Message = e.value;

                                    setEditing(true);
                                    //buildConfig(container, comm, state);
                                },
                            },
                        }
                    ],
                },
            ],
        });

        document.querySelector(
            container
        ).parentElement.parentElement.style.display = "";
    };

    const buildConfig = async (container, comm, state) => {
        $(container).empty();
        $(container).dxForm({
            formData: comm,
            width: "100%",
            name: "mainForm",
            alignItemLabels: false,
            alignItemLabelsInAllGroups: false,
            colCount: 4,
            items: [
                {
                    itemType: "group",
                    cssClass: "comm-config-form-group",
                    colSpan: 4,
                    colCount: 4,
                    items: [
                        {
                            itemType: "group",
                            //cssClass: "form-group-indented",
                            name: "response",
                            colSpan: 4,
                            items: [
                                {
                                    itemType: "group",
                                    cssClass: "first-group",
                                    name: "message",
                                    colSpan: 4,
                                    colCount: 3,
                                    items: [
                                        {
                                            cssClass: "VTpageSeparator",
                                            colSpan: 3,
                                            label: { text: COMUNICADO, showColon: false },
                                            itemType: "group",
                                        },
                                        {
                                            colSpan: 3,
                                            dataField: ASUNTO,
                                            label: { location: "top", showColon: false },
                                            cssClass: "form-group-indented",
                                            editorOptions: {
                                                value: comm.Subject,
                                                maxLength: 50,
                                                onValueChanged: (e) => {
                                                    comm.Subject = e.event.target.value;

                                                    setEditing(true);
                                                },
                                            },
                                        },
                                        {
                                            colSpan: 3,
                                            itemType: "group",
                                            cssClass: "form-group-indented",
                                            dataField: ANADIR_ADJUNTOS,
                                            label: { location: "top", showColon: false },
                                            items: [
                                                {
                                                    cssClass: "comm-config-fileuploader",
                                                    template: (item, element) => {
                                                        const fileUploader = $(element)
                                                            .dxFileUploader({
                                                                selectButtonText: ADJUNTAR,
                                                                multiple: true,
                                                                uploadMode: "instantly",
                                                                uploadUrl: `${BASE_URL}Communique/SaveAttachedFile/${comm.Id}`,
                                                                name: "file",
                                                                labelText: HASTA_X_ADJUNTOS,
                                                                accept: "*",
                                                                allowedExtensions: [".pdf", ".png", ".jpg", ".jpeg"],
                                                                maxFileSize: MAX_FILE_SIZE * 1000,
                                                                readyToUploadMessage: "",
                                                                value: comm.Documents.map(
                                                                    (doc) =>
                                                                        (!!doc.Title &&
                                                                            new File(
                                                                                [base64ToarrayBlob(doc.Document)],
                                                                                doc.Title
                                                                            )) ||
                                                                        doc
                                                                ),
                                                                onValueChanged: (e) => {
                                                                    if (e.value.length <= 2) {
                                                                        let fileToRemove;

                                                                        if (e.value.length > e.previousValue.length) {
                                                                            e.value.map((f) => {
                                                                                const fileIsNew =
                                                                                    comm.Documents.filter(
                                                                                        (doc) => doc.name === f.name
                                                                                    ).length === 0;
                                                                                if (fileIsNew) {
                                                                                    comm.Documents.push(f);
                                                                                }
                                                                            });
                                                                        }

                                                                        if (e.value.length < e.previousValue.length) {
                                                                            comm.Documents.map(async (doc) => {
                                                                                if (!e.value.filter(function (v) { return v.name === doc.Title; }).length > 0) {
                                                                                    await removeAttachedFile(doc.Title);
                                                                                }
                                                                            });
                                                                        }
                                                                    } else {
                                                                        const newValue = e.value
                                                                            .filter(
                                                                                (f) =>
                                                                                    e.previousValue.find((prev) => prev === f) ===
                                                                                    f
                                                                            )
                                                                            .filter((_, i) => i < 2);
                                                                        e.component.reset();
                                                                        e.component.option("value", newValue);

                                                                        DevExpress.ui.dialog.alert(
                                                                            MAXIMO_X_ADJUNTOS,
                                                                            ADJUNTAR_DOCUMENTOS
                                                                        );
                                                                    }

                                                                    setEditing(true);
                                                                },
                                                                onContentReady: (e) => {
                                                                    [
                                                                        ...document.querySelectorAll(
                                                                            ".dx-fileuploader-files-container .dx-fileuploader-file .dx-fileuploader-file-name"
                                                                        ),
                                                                    ].map((fileDiv) => {
                                                                        e.component.option("value").map((file) => {
                                                                            if (file.name === fileDiv.innerText) {
                                                                                fileDiv.addEventListener(
                                                                                    "click",
                                                                                    () => handleDownloadFileClicked(file),
                                                                                    false
                                                                                );
                                                                            }
                                                                        });
                                                                    });
                                                                },
                                                            })
                                                            .dxFileUploader("instance");
                                                    },
                                                },
                                            ],
                                        },
                                        {
                                            editorType: "dxRadioGroup",
                                            cssClass: "form-group-indented",
                                            colSpan: 3,
                                            dataField: ES_DE_LECTURA_OBLIGATORIA,
                                            label: { location: "top", showColon: false },
                                            editorOptions: {
                                                items: state.feedbackOptions,
                                                value: comm.MandatoryRead
                                                    ? state.feedbackOptions[0]
                                                    : state.feedbackOptions[1],
                                                onValueChanged: (e) => {
                                                    comm.MandatoryRead = e.value === state.feedbackOptions[0];

                                                    setEditing(true);
                                                },
                                            },
                                        },
                                        {
                                            cssClass: "VTpageSeparator",
                                            colSpan: 3,
                                            label: { text: PARA, showColon: false },
                                            itemType: "group",
                                        },
                                        {
                                            colSpan: 3,
                                            colCount: 4,
                                            cssClass: "form-group-indented",
                                            name: "recipients",
                                            itemType: "group",
                                            items: [
                                                {
                                                    colSpan: 1,
                                                    editorType: "dxTextBox",
                                                    name: "sentence",
                                                    datafield: SELECCIONADOS,
                                                    editorOptions: {
                                                        text: function () {
                                                            let currentSelectorView = { Employees: [], Groups: [], Filter: "11110", UserFields: "", ComposeMode: 'Custom', ComposeFilter: "", Advanced: false, Operation: "or" };

                                                            if (comm != null) {
                                                                if (comm.Employees != null) {
                                                                    for (let i = 0; i < comm.Employees.length; i++) currentSelectorView.ComposeFilter += currentSelectorView.ComposeFilter == '' ? `B${comm.Employees[i]}` : `,B${comm.Employees[i]}`;
                                                                }

                                                                if (comm.Groups != null) {
                                                                    for (let i = 0; i < comm.Groups.length; i++) currentSelectorView.ComposeFilter += currentSelectorView.ComposeFilter == '' ? `A${comm.Groups[i]}` : `,A${comm.Groups[i]}`;
                                                                }
                                                            }

                                                            return buildSelectedEmployeesString(currentSelectorView);
                                                        },
                                                        readOnly: true,
                                                        onValueChanged: (e) => setEditing(true)
                                                    },
                                                },
                                                {
                                                    colSpan: 1,
                                                    editorType: "dxButton",
                                                    cssClass: "comm-select-recipients-button CY-btnSelectDest",
                                                    editorOptions: {
                                                        text: SELECCIONA_DESTINATARIOS,
                                                        onClick: async (e) => {

                                                            let currentView = { Employees: [], Groups: [], Filter: "11110", UserFields: "", ComposeMode: 'Custom', ComposeFilter: "", Advanced: false, Operation: "or" };

                                                            if (comm != null) {
                                                                if (comm.Employees != null) {
                                                                    for (let i = 0; i < comm.Employees.length; i++) currentView.ComposeFilter += currentView.ComposeFilter == '' ? `B${comm.Employees[i]}` : `,B${comm.Employees[i]}`;
                                                                }

                                                                if (comm.Groups != null) {
                                                                    for (let i = 0; i < comm.Groups.length; i++) currentView.ComposeFilter += currentView.ComposeFilter == '' ? `A${comm.Groups[i]}` : `,A${comm.Groups[i]}`;
                                                                }
                                                            }


                                                            parent.showLoader(true);
                                                            $("#divCommuniqueEmployeeSelector").load('/Employee/EmployeeSelectorPartial?feature=Employees&pageName=communique&config=100&unionType=or&advancedMode=1&advancedFilter=0', function () {
                                                                loadPartialInfo();
                                                                initUniversalSelector(currentView,false,'communiqueSelector');
                                                                parent.showLoader(false);
                                                            });
                                                        },
                                                    },
                                                },
                                            ],
                                        },
                                    ],
                                },
                                {
                                    cssClass: "VTpageSeparator",
                                    colSpan: 4,
                                    label: { text: RESPUESTAS, showColon: false },
                                    itemType: "group",
                                },
                                {
                                    editorType: "dxCheckBox",
                                    editorOptions: {
                                        text: PERMITIR_RESPUESTAS_PERSONALIZADAS,
                                        hint: ANADE_OPCIONES_DE_RESPUESTA,
                                        value: comm.AllowCustomResponses,
                                        onValueChanged: (e) => {
                                            comm.AllowCustomResponses = e.value;
                                            if (!e.value)
                                                comm.AllowedResponses = [];
                                            buildConfig(container, comm, state);
                                            setEditing(true);
                                        },
                                    },
                                },
                                {
                                    itemType: "group",
                                    cssClass: "answers-group",
                                    name: "answers",
                                    colCount: 6,
                                    items: [
                                        ...comm.AllowedResponses.map((answer, i, arr) => ({
                                            colSpan: 1,
                                            width: "35px",
                                            editorType: "dxTextBox",
                                            name: `answer-${i}`,
                                            editorOptions: {
                                                readOnly: !comm.AllowCustomResponses,
                                                value: answer,
                                                maxLength: 50,
                                                onValueChanged: (e) => {
                                                    comm.AllowedResponses[i] = e.event.target.value;
                                                    setEditing(true);
                                                },
                                                buttons: [
                                                    {
                                                        name: "removeAnswer",
                                                        options: {
                                                            icon: "close",
                                                            stylingMode: "text",
                                                            hint: ELIMINAR_RESPUESTA,
                                                            onClick: (e) => {
                                                                comm.AllowedResponses = comm.AllowedResponses.filter(
                                                                    (_, index) => index !== i
                                                                );
                                                                buildConfig(container, comm, state);
                                                                setEditing(true);
                                                            },
                                                        },
                                                    },
                                                ],
                                            },
                                        })),
                                        {
                                            colSpan: 1,
                                            editorType: "dxButton",
                                            editorOptions: {
                                                icon: "plus",
                                                disabled: !comm.AllowCustomResponses,
                                                hint: ANADOR_RESPUESTA_MAXIMO_DE_X,
                                                onClick: async (e) => {
                                                    if (comm.AllowedResponses.length < MAX_RESPUESTAS) {
                                                        comm.AllowedResponses.push("");
                                                        await buildConfig(container, comm, state);
                                                        setEditing(true);
                                                    } else {
                                                        DevExpress.ui.dialog.alert(
                                                            MAXIMO_DE_X_RESPUESTAS_POSIBLES,
                                                            ANADIR_OPCION_DE_RESPUESTA
                                                        );
                                                    }
                                                },
                                            },
                                        },
                                    ],
                                },
                                {
                                    editorType: "dxCheckBox",
                                    editorOptions: {
                                        text: PERMITIR_CAMBIAR_DE_OPINION,
                                        hint: ANADE_OPCIONES_DE_RESPUESTA_PARA_HABILITAR,
                                        readOnly: comm.AllowedResponses.length === 0,
                                        value:
                                            comm.AllowedResponses.length === 0
                                                ? false
                                                : comm.AllowChangeResponse,
                                        onValueChanged: (e) => {
                                            comm.AllowChangeResponse = e.value;

                                            setEditing(true);
                                        },
                                    },
                                },
                            ],
                        },
                        {
                            visible: (AdvancedCommuniques == 'True'),
                            cssClass: "VTpageSeparator",
                            colSpan: 4,
                            label: { text: "Planificación", showColon: false },
                            itemType: "group",
                        },
                        {
                            itemType: "group",
                            cssCLass: "com-planification-group",
                            cssClass: "form-group-indented",
                            colSpan: 4,
                            colCount: 18,
                            items: [
                                {
                                    editorType: "dxCheckBox",
                                    colSpan: 4,
                                    editorOptions: {
                                        text: state.planifications[1].label,
                                        visible: (AdvancedCommuniques == 'True'),
                                        value: comm.planification.find((exp) => exp.option === 1)
                                            .active,
                                        onValueChanged: (e) => {
                                            comm.planification.find((exp) => exp.option === 1).active =
                                                e.value;

                                            if (!e.value) {
                                                comm.PlanificationDate = "2000-01-01T00:00:00";
                                            } else {
                                                comm.PlanificationDate = window.parent.moment().add(1, 'day').startOf('day').format("YYYY-MM-DDTHH:mm:ss");
                                            }
                                            buildConfig(container, comm, state);

                                            setEditing(true);
                                        },
                                    },
                                },
                                {
                                    colSpan: 3,
                                    editorType: "dxDateBox",
                                    editorOptions: {
                                        type: "datetime",
                                        min: new Date(),
                                        displayFormat: "dd-MM-yyyy, HH:mm",
                                        visible: (AdvancedCommuniques == 'True'),
                                        disabled: !comm.planification.find((plan) => plan.option === 1)
                                            .active,
                                        value:
                                            comm.PlanificationDate !== "2000-01-01T00:00:00"
                                                ? window.parent.moment(
                                                    comm.PlanificationDate,
                                                    "YYYY-MM-DDTHH:mm:ss"
                                                )
                                                : new Date(
                                                    new Date().setDate(new Date().getDate() + 1)
                                                ).setHours(0, 0, 0, 0),
                                        onValueChanged: (e) => {
                                            comm.PlanificationDate = window.parent
                                                .moment(e.value)
                                                .format("YYYY-MM-DDTHH:mm:ss");

                                            setEditing(true);
                                        },
                                    },
                                },
                                { itemType: "empty", colSpan: 11 },
                            ],
                        },
                        {
                            cssClass: "VTpageSeparator",
                            colSpan: 4,
                            label: { text: "Finalización", showColon: false },
                            itemType: "group",
                        },
                        {
                            itemType: "group",
                            cssClass: "form-group-indented com-caducidad-group",
                            colSpan: 4,
                            colCount: 18,
                            items: [
                                /* {
                                    editorType: "dxTextBox",
                                    colSpan: 18,
                                    cssClass: "comm-simulate-label",
                                    editorOptions: {
                                        readOnly: true,
                                        stylingMode: "filled",
                                        value: "Los empleados dejaran de ver el comunicado:"
                                    }
                                }, */
                                {
                                    editorType: "dxCheckBox",
                                    colSpan: 4,
                                    editorOptions: {
                                        text: state.expirations[1].label,
                                        value: comm.expiration.find((exp) => exp.option === 1)
                                            .active,
                                        onValueChanged: (e) => {
                                            comm.expiration.find((exp) => exp.option === 1).active =
                                                e.value;

                                            if (!e.value) comm.ExpirationDate = "2079-01-01T00:00:00";

                                            buildConfig(container, comm, state);

                                            setEditing(true);
                                        },
                                    },
                                },
                                {
                                    colSpan: 3,
                                    editorType: "dxDateBox",
                                    editorOptions: {
                                        type: "datetime",
                                        min: new Date(),
                                        displayFormat: "dd-MM-yyyy, HH:mm",
                                        disabled: !comm.expiration.find((exp) => exp.option === 1)
                                            .active,
                                        value:
                                            comm.ExpirationDate !== "2079-01-01T00:00:00"
                                                ? window.parent.moment(
                                                    comm.ExpirationDate,
                                                    "YYYY-MM-DDTHH:mm:ss"
                                                )
                                                : new Date(
                                                    new Date().setDate(new Date().getDate() + 7)
                                                ).setHours(0, 0, 0, 0),
                                        onValueChanged: (e) => {
                                            comm.ExpirationDate = window.parent
                                                .moment(e.value)
                                                .format("YYYY-MM-DDTHH:mm:ss");

                                            setEditing(true);
                                        },
                                    },
                                },
                                { itemType: "empty", colSpan: 11 },
                                {
                                    itemType: "group",
                                    colSpan: 18,
                                    colCount: 18,
                                    items: [
                                        {
                                            editorType: "dxCheckBox",
                                            colSpan: 4,
                                            editorOptions: {
                                                text: state.expirations[2].label + ":",
                                                hint:
                                                    "Añade opciones de respuesta para habilitar este campo",
                                                readOnly: comm.AllowedResponses.length === 0,
                                                value:
                                                    comm.AllowedResponses.length === 0
                                                        ? false
                                                        : comm.expiration.find((exp) => exp.option === 2)
                                                            .active,
                                                onValueChanged: (e) => {
                                                    comm.expiration.find(
                                                        (exp) => exp.option === 2
                                                    ).active = e.value;

                                                    if (!e.value) comm.ResponsePercentageLimit = -1;

                                                    buildConfig(container, comm, state);

                                                    setEditing(true);
                                                },
                                            },
                                        },
                                        {
                                            editorType: "dxSlider",
                                            colSpan: 5,
                                            editorOptions: {
                                                disabled: !comm.expiration.find(
                                                    (exp) => exp.option === 2
                                                ).active,
                                                value:
                                                    comm.ResponsePercentageLimit === -1 ||
                                                        !comm.ResponsePercentageLimit
                                                        ? 100
                                                        : comm.ResponsePercentageLimit,
                                                label: {
                                                    visible: true,
                                                    position: "top",
                                                    format: (value) => `${value}%`,
                                                },
                                                tooltip: {
                                                    enabled: true,
                                                    format: (value) => `${value}%`,
                                                    position: "bottom",
                                                    showMode: "always",
                                                },
                                                onValueChanged: (e) => {
                                                    comm.ResponsePercentageLimit = e.value;

                                                    setEditing(true);
                                                },
                                            },
                                        },
                                    ],
                                },
                            ],
                        },
                    ],
                },
            ],
        });

        document.querySelector(
            container
        ).parentElement.parentElement.style.display = "";
    };

    const buildCommReadOnly = async (container, container2, comm, state) => {
        const status = [BORRADOR, ENVIADO, CADUCADO, CANCELADO];
        $(container).empty();
        $(container2).empty();
        $(container2).dxForm({
            formData: comm,
            width: "100%",
            name: "mainForm",
            colCount: 4,
            items: [
                {
                    cssClass: "VTpageSeparator",
                    colSpan: 4,
                    label: { text: status[comm.Status], showColon: false },
                    itemType: "group",
                },
                {
                    itemType: "group",
                    cssClass: "first-group",
                    name: "message",
                    colSpan: 4,
                    colCount: 4,
                    items: [
                        {
                            cssClass: "VTpageSeparator",
                            colSpan: 4,
                            label: { text: COMUNICADO, showColon: false },
                            itemType: "group",
                        },
                        {
                            dataField: ASUNTO,
                            label: { location: "top", showColon: false },
                            cssClass: "form-group-indented",
                            colSpan: 4,
                            editorOptions: {
                                readOnly: true,
                                value: comm.Subject,
                            },
                        },
                        {
                            editorType: "dxCheckBox",
                            cssClass: "comm-MandatoryRead-checkbox form-group-indented",
                            colSpan: 4,
                            editorOptions: {
                                text: LECTURA_OBLIGATORIA,
                                value: comm.MandatoryRead,
                                readOnly: true,
                            },
                        },
                        {
                            colSpan: 4,
                            itemType: "group",
                            cssClass: "form-group-indented",
                            dataField: ADJUNTOS,
                            label: { location: "top", showColon: false },
                            colCount: 4,
                            items: comm.Documents.map((doc) => ({
                                editorType: "dxTextBox",
                                colSpan: 4,
                                editorOptions: {
                                    value: doc.Title,
                                    buttons: [
                                        {
                                            name: "downloadDocument",
                                            location: "after",
                                            options: {
                                                type: "normal",
                                                icon: "download",
                                                stylingMode: "text",
                                                hint: DESCARGAR_DOCUMENTO,
                                                onClick: (e) => handleDownloadFileClicked(doc),
                                            },
                                        },
                                        {
                                            name: "removeDocument",
                                            location: "before",
                                            options: {
                                                type: "normal",
                                                icon: "close",
                                                stylingMode: "text",
                                                hint: ELIMINAR_DOCUMENTO_ADJUNTO,
                                                onClick: async (e) => {
                                                    const userConfims = await DevExpress.ui.dialog.confirm(
                                                        QUIERE_BORRAR_DEFINITIVAMENTE_EL_ADJUNTO,
                                                        BORRAR_ADJUNTO
                                                    );

                                                    if (userConfims) {
                                                        await removeAttachedFile(doc.Title);
                                                        await saveCommunique(comm);
                                                        document
                                                            .querySelector(".communiqueCardClicked")
                                                            .click();
                                                    }
                                                },
                                            },
                                        },
                                    ],
                                },
                            })),
                        },
                        {
                            cssClass: "VTpageSeparator",
                            colSpan: 4,
                            label: { text: PARA, showColon: false },
                            itemType: "group",
                        },
                        {
                            dataField: DESTINATARIOS,
                            label: { location: "top", showColon: false },
                            cssClass: "form-group-indented",
                            colSpan: 4,
                            editorType: "dxTextBox",
                            editorOptions: {
                                text: function () {
                                    let currentSelectorView = { Employees: [], Groups: [], Filter: "11110", UserFields: "", ComposeMode: 'Custom', ComposeFilter: "", Advanced: false, Operation: "or" };

                                    if (comm != null) {
                                        if (comm.Employees != null) {
                                            for (let i = 0; i < comm.Employees.length; i++) currentSelectorView.ComposeFilter += currentSelectorView.ComposeFilter == '' ? `B${comm.Employees[i]}` : `,B${comm.Employees[i]}`;
                                        }

                                        if (comm.Groups != null) {
                                            for (let i = 0; i < comm.Groups.length; i++) currentSelectorView.ComposeFilter += currentSelectorView.ComposeFilter == '' ? `A${comm.Groups[i]}` : `,A${comm.Groups[i]}`;
                                        }
                                    }

                                    return buildSelectedEmployeesString(currentSelectorView);
                                },
                                readOnly: true
                                //width: "400px",
                            },
                        },
                    ],
                },
                {
                    itemType: "group",
                    colSpan: 4,
                    colCount: 4,
                    items: [
                        {
                            cssClass: "VTpageSeparator",
                            colSpan: 4,
                            label: { text: RESPUESTAS, showColon: false },
                            itemType: "group",
                        },
                        {
                            itemType: "group",
                            cssClass: "form-group-indented",
                            name: "response",
                            colSpan: 4,
                            items: [
                                {
                                    itemType: "group",
                                    cssClass: "answers-group",
                                    name: "answers",
                                    colCount: 6,
                                    items:
                                        (comm.AllowedResponses.length === 0 && [
                                            {
                                                colSpan: 6,
                                                cssClass: "comm-simulate-label",
                                                editorType: "dxTextBox",
                                                editorOptions: {
                                                    stylingMode: "filled",
                                                    readOnly: true,
                                                    value: NO_HAY_OPCIONES_DE_RESPUESTA,
                                                },
                                            },
                                        ]) ||
                                        comm.AllowedResponses.map((answer, i, arr) => ({
                                            colSpan: 4,
                                            width: "35px",
                                            editorType: "dxTextBox",
                                            name: `answer-${i}`,
                                            editorOptions: {
                                                value: answer,
                                                readOnly: true,
                                            },
                                        })),
                                },
                                {
                                    editorType: "dxCheckBox",
                                    editorOptions: {
                                        text: PERMITIR_CAMBIAR_DE_OPINION,
                                        value: comm.AllowChangeResponse,
                                        readOnly: true,
                                    },
                                },
                            ],
                        },
                        {
                            visible: (AdvancedCommuniques == 'True'),
                            cssClass: "VTpageSeparator",
                            colSpan: 4,
                            label: { text: PLANIFICACION, showColon: false },
                            itemType: "group",
                        },
                        {
                            itemType: "group",
                            cssClass: "form-group-indented",
                            colSpan: 4,
                            colCount: 9,
                            items: [
                                {
                                    editorType: "dxCheckBox",
                                    colSpan: 2,
                                    editorOptions: {
                                        text: state.planifications[1].label,
                                        visible: (AdvancedCommuniques == 'True'),
                                        value: comm.planification.find((exp) => exp.option === 1)
                                            .active,
                                        readOnly: true,
                                    },
                                },
                                {
                                    colSpan: 2,
                                    editorType: "dxDateBox",
                                    editorOptions: {
                                        type: "datetime",
                                        displayFormat: "dd-MM-yyyy, HH:mm",
                                        visible: (AdvancedCommuniques == 'True'),
                                        value:
                                            comm.PlanificationDate.indexOf("2000") > -1
                                                ? ""
                                                : comm.PlanificationDate,
                                        showDropDownButton: false,
                                        disabled: comm.PlanificationDate.indexOf("2000") > -1,
                                        readOnly: true,
                                    },
                                },
                                { itemType: "empty", colSpan: 4 },
                            ],
                        },
                        {
                            cssClass: "VTpageSeparator",
                            colSpan: 4,
                            label: { text: CADUCIDAD, showColon: false },
                            itemType: "group",
                        },
                        {
                            itemType: "group",
                            cssClass: "form-group-indented",
                            colSpan: 4,
                            colCount: 18,
                            items: [
                                {
                                    editorType: "dxCheckBox",
                                    colSpan: 4,
                                    editorOptions: {
                                        text: state.expirations[1].label,
                                        value: comm.expiration.find((exp) => exp.option === 1)
                                            .active,
                                        readOnly: true,
                                    },
                                },
                                {
                                    colSpan: 3,
                                    editorType: "dxDateBox",
                                    editorOptions: {
                                        type: "datetime",
                                        displayFormat: "dd-MM-yyyy, HH:mm",
                                        value:
                                            comm.ExpirationDate.indexOf("2079") > -1
                                                ? ""
                                                : comm.ExpirationDate,
                                        showDropDownButton: false,
                                        disabled: comm.ExpirationDate.indexOf("2079") > -1,
                                        readOnly: true,
                                    },
                                },
                                { itemType: "empty", colSpan: 11 },
                                {
                                    itemType: "group",
                                    colSpan: 18,
                                    colCount: 18,
                                    items: [
                                        {
                                            editorType: "dxCheckBox",
                                            colSpan: 4,
                                            editorOptions: {
                                                text: state.expirations[2].label + ":",
                                                value: comm.expiration.find((exp) => exp.option === 2)
                                                    .active,
                                                readOnly: true,
                                            },
                                        },
                                        {
                                            editorType: "dxTextBox",
                                            colSpan: 5,
                                            editorOptions: {
                                                value: `${comm.ResponsePercentageLimit === -1 ||
                                                    !comm.ResponsePercentageLimit
                                                    ? "--"
                                                    : comm.ResponsePercentageLimit
                                                    }%`,
                                                disabled: !comm.expiration.find(
                                                    (exp) => exp.option === 2
                                                ).active,
                                                readOnly: true,
                                            },
                                        },
                                    ],
                                },
                            ],
                        },
                    ],
                },
            ],
        });
        document.querySelector(
            container2
        ).parentElement.parentElement.style.display = "";
        $(container).dxForm({
            formData: comm,
            width: "100%",
            name: "mainForm",
            alignItemLabels: true,
            alignItemLabelsInAllGroups: true,
            colCount: 4,
            items: [
                {
                    itemType: "group",
                    cssClass: "first-group",
                    name: "message",
                    colSpan: 4,
                    colCount: 3,
                    items: [
                        {
                            cssClass: "VTpageSeparator",
                            colSpan: 3,
                            label: { text: COMUNICADO, showColon: false },
                            itemType: "group",
                        },
                        {
                            dataField: MENSAJE,
                            label: { location: "top", showColon: false },
                            cssClass: "form-group-indented communique-html-content",
                            colSpan: 3,
                            editorType: "dxHtmlEditor",
                            editorOptions: {
                                height: 500,
                                value: comm.Message,
                                readOnly: true,
                                toolbar: {
                                    items: [
                                        {
                                            name: "undo",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandUndo")
                                            }
                                        },
                                        {
                                            name: "redo",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandRedo")
                                            }
                                        },
                                        "separator",
                                        {
                                            name: "size",
                                            acceptedValues: ["8pt", "10pt", "12pt", "14pt", "18pt", "24pt", "36pt"],
                                            options: {
                                                placeholder: window.parent.Globalize.formatMessage('dxHtmlEditor-commandFontSize'),
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-commandFontSize"),
                                                displayExpr: function (item) {
                                                    return window.parent.Globalize.formatMessage('dxHtmlEditor-commandFontSize')
                                                },
                                                itemTemplate: function (data, index, element) {
                                                    element.text(data)
                                                }
                                            }
                                        },
                                        {
                                            name: "font",
                                            acceptedValues: ["Arial", "Courier New", "Georgia", "Impact", "Lucida Console", "Tahoma", "Times New Roman", "Verdana"],
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-commandFontName"),
                                                placeholder: window.parent.Globalize.formatMessage('dxHtmlEditor-commandFontName'),
                                                displayExpr: function (item) {
                                                    return window.parent.Globalize.formatMessage('dxHtmlEditor-commandFontName')
                                                },
                                                itemTemplate: function (data, index, element) {
                                                    element.text(data)
                                                }
                                            }
                                        },
                                        "separator", {
                                            name: "bold",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandBold")
                                            }
                                        }, {
                                            name: "italic",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandItalic")
                                            }
                                        }, {
                                            name: "strike",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandStrike")
                                            }
                                        }, {
                                            name: "underline",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandUnderline")
                                            }
                                        }, "separator",
                                        {
                                            name: "alignLeft",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandAlignLeft")
                                            }
                                        }, {
                                            name: "alignCenter",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandAlignCenter")
                                            }
                                        }, {
                                            name: "alignRight",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandAlignRight")
                                            }
                                        }, {
                                            name: "alignJustify",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxDiagram-commandAlignJustify")
                                            }
                                        }, "separator",
                                        {
                                            name: "orderedList",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-orderedList")
                                            }
                                        }, {
                                            name: "bulletList",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-bulletList")
                                            }
                                        }, "separator",
                                        {
                                            name: "header",
                                            acceptedValues: [false, 1, 2, 3, 4, 5],
                                            options: {
                                                placeholder: window.parent.Globalize.formatMessage('dxHtmlEditor-heading'),
                                                displayExpr: function (item) {
                                                    return window.parent.Globalize.formatMessage('dxHtmlEditor-heading')
                                                },
                                                itemTemplate: function (data, index, element) {
                                                    if (index === 0) {
                                                        element.text(window.parent.Globalize.formatMessage("dxHtmlEditor-normalText"))
                                                    }
                                                    else {
                                                        element.text(window.parent.Globalize.formatMessage("dxHtmlEditor-heading" + data))
                                                    }
                                                },
                                            }
                                        }, "separator",
                                        {
                                            name: "color",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-color")
                                            }
                                        }, {
                                            name: "background",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-background")
                                            }
                                        }, "separator",
                                        {
                                            name: "link",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-link")
                                            }
                                        },
                                        {
                                            name: "image",
                                            widget: "dxButton",
                                            options: {
                                                text: window.parent.Globalize.formatMessage("dxDiagram-commandInsertShapeImage"),
                                                stylingMode: "text",
                                                onClick: function () {
                                                    var popup = $("#addImagePopup").dxPopup("instance");
                                                    popup.show();
                                                }
                                            }
                                        }, "separator",
                                        {
                                            name: "clear",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("Clear")
                                            }
                                        }, {
                                            name: "codeBlock",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-codeblock")
                                            }
                                        }, "separator",
                                        {
                                            name: "insertTable",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-insertTable")
                                            }
                                        }, {
                                            name: "deleteTable",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-deleteTable")
                                            }
                                        },
                                        {
                                            name: "insertRowAbove",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-insertRowAbove")
                                            }
                                        }, {
                                            name: "insertRowBelow",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-insertRowBelow")
                                            }
                                        }, {
                                            name: "deleteRow",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-deleteRow")
                                            }
                                        },
                                        {
                                            name: "insertColumnLeft",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-insertColumnLeft")
                                            }
                                        }, {
                                            name: "insertColumnRight",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-insertColumnRight")
                                            }
                                        }, {
                                            name: "deleteColumn",
                                            options: {
                                                hint: window.parent.Globalize.formatMessage("dxHtmlEditor-deleteColumn")
                                            }
                                        }]
                                },
                                onValueChanged: (e) => {
                                    comm.Message = e.value;

                                    setEditing(true);
                                    //buildConfig(container, comm, state);
                                },
                            },
                        }
                    ],
                },
            ],
        });
        document.querySelector(
            container
        ).parentElement.parentElement.style.display = "";
    };

    const buildStatistics = (container, comm, state) => {
        const Statistics = comm.Statistics;
        const wrapper = document.querySelector(container);
        wrapper.innerHTML = "";

        if (!Statistics) return;

        const pieData = [
            {
                type: LEIDOS,
                value: Statistics.reduce((acc, s) => (s.Read && ++acc) || acc, 0),
            },
            {
                type: PENDIENTES,
                value: Statistics.reduce((acc, s) => (!s.Read && ++acc) || acc, 0),
            },
        ];

        const chartData = comm.AllowedResponses.map((asw, i, arr) => ({
            answer: asw,
            value: Statistics.reduce(
                (acc, s) => (s.Answer === asw && ++acc) || acc,
                0
            ),
        }));

        const pieChart = document.createElement("div");
        const gridBtn = document.createElement("a");

        pieChart.classList.add("pieChartStatistics");
        gridBtn.classList.add("mainActionBtn");
        gridBtn.setAttribute("id", "commStatisticsGridBtn");
        gridBtn.setAttribute("href", "#");
        gridBtn.addEventListener(
            "click",
            () => {
                buildStatisticsGrid(Statistics);
            },
            false
        );
        gridBtn.innerText = LISTA_DE_RESULTADOS;

        wrapper.append(pieChart);

        $(pieChart).dxPieChart({
            palette: "soft",
            dataSource: pieData,
            //title: { text: "Lecturas" },
            series: [
                {
                    argumentField: "type",
                    valueField: "value",
                    label: {
                        visible: true,
                        connector: {
                            visible: true,
                            width: 1,
                        },
                    },
                },
            ],
            size: {
                height: 350,
            },
        });

        if (chartData.length > 0) {
            const barChart = document.createElement("div");
            barChart.classList.add("barChartStatistics");
            wrapper.append(barChart);

            $(barChart).dxPieChart({
                palette: "softpastel",
                dataSource: chartData,
                series: [
                    {
                        argumentField: "answer",
                        valueField: "value",
                        label: {
                            visible: true,
                            connector: {
                                visible: true,
                                width: 1,
                            },
                        },
                    },
                ],
                size: {
                    height: 350,
                },
            });
        }

        wrapper.append(gridBtn);

        document.querySelector(
            container
        ).parentElement.parentElement.style.display = "";
    };

    const buildStatisticsGrid = async (Statistics) => {
        $fieldsEditor.style.display = "";
        $fieldsEditor.style.width = "auto";

        const buttonsTemplate = await getViewTemplate("editViewBtns");
        const grid = document.createElement("div");
        grid.classList.add("statisticsGrid");

        $fieldsEditor.appendChild(grid);
        $fieldsEditor.innerHTML += buttonsTemplate;

        $fieldsEditor.querySelector("#cancelEdition").parentElement.style.display =
            "none";
        $fieldsEditor
            .querySelector("#acceptEdition")
            .parentElement.addEventListener(
                "click",
                () => {
                    while ($fieldsEditor.lastChild) {
                        $fieldsEditor.removeChild($fieldsEditor.lastChild);
                    }
                    $fieldsEditor.style.display = "none";
                    $fieldsEditor.style.width = "";
                },
                false
            );

        $(".statisticsGrid").dxDataGrid({
            dataSource: Statistics,
            showBorders: true,
            rowAlternationEnabled: true,
            columnAutoWidth: true,
            headerFilter: {
                visible: true,
            },
            filterRow: {
                visible: true,
                applyFilter: "auto",
            },
            columns: [
                {
                    dataField: "EmployeeName",
                    caption: EMPLEADO,
                    dataType: "number",
                    width: "auto",
                },
                { dataField: "Read", caption: LEIDO, width: "auto" },
                { dataField: "Answered", caption: RESPONDIDO, width: "auto" },
                {
                    dataField: "Answer",
                    caption: RESPUESTA,
                    dataType: "string",
                    width: "auto",
                },
                {
                    dataField: "ReadTimeStamp",
                    caption: FECHA_LECTURA,
                    dataType: "date",
                    width: "auto",
                    calculateCellValue: (data) =>
                        data.ReadTimeStamp === "1970-01-01T00:00:00"
                            ? ""
                            : window.parent.moment(data.ReadTimeStamp).format("DD-MM-YYYY"),
                },
                {
                    dataField: "AnswerTimeStamp",
                    caption: FECHA_RESPUESTA,
                    dataType: "date",
                    width: "auto",
                    calculateCellValue: (data) =>
                        data.AnswerTimeStamp === "1970-01-01T00:00:00"
                            ? ""
                            : window.parent.moment(data.AnswerTimeStamp).format("DD-MM-YYYY"),
                },
            ],
            export: {
                enabled: true,
                fileName: `${state.communiques[state.selectedCommunique].Subject
                    }_CommuniqueResults`,
                texts: {
                    exportAll: EXPORTAR_DATOS_FILTRADOS,
                    exportTo: EXPORTAR_DATOS_FILTRADOS,
                },
                allowExportSelectedData: false,
            },
            groupPanel: {
                visible: true,
                allowColumnDragging: true,
                emptyPanelText: LISTA_RESULTADOS_COMUNICADO,
            },
            paging: {
                pageSize: 10,
            },
            onExporting: exportCommuniqueResults
        });
    };

    function exportCommuniqueResults(e) {
        var workbook = new ExcelJS.Workbook();
        var worksheet = workbook.addWorksheet('Main sheet');
        DevExpress.excelExporter.exportDataGrid({
            worksheet: worksheet,
            component: e.component,
            customizeCell: function (options) {
                options.excelCell.font = { name: 'Arial', size: 12 };
                options.excelCell.alignment = { horizontal: 'left' };
            }
        }).then(function () {
            workbook.xlsx.writeBuffer().then(function (buffer) {
                saveAs(new Blob([buffer], { type: 'application/octet-stream' }), 'estado.xlsx');
            });
        });
    }

    const buildMainButtons = async (container, comm) => {
        /* const buttonsTemplate = await getViewTemplate("switchMainViewTabs");
        const wrapper = document.querySelector(container);
        wrapper.innerHTML = buttonsTemplate; */

        const permission = await getPermisionOverCommuniques();

        const saveBtnOlds = [...document.querySelectorAll(".commSaveBtn")];
        const discartBtnOlds = [...document.querySelectorAll(".commDiscartBtn")];

        const sendBtnOld = document.querySelector("#commSendBtn");
        const removeBtnOld = document.querySelector("#commRemoveBtn");
        const createBtnOld = document.querySelector("#commCreateBtn");
        const archiveBtnOld = document.querySelector("#commArchiveBtn");
        const unarchiveBtnOld = document.querySelector("#commUnarchiveBtn");
        const shrinkBtnOld = document.querySelector("#commShrinkBtn");
        const expandBtnOld = document.querySelector("#commExpandBtn");
        const cancelBtnOld = document.querySelector("#commCancelBtn");
        const uncancelBtnOld = document.querySelector("#commUncancelBtn");
        const filterActiveBtnOld = document.querySelector("#filterActiveCommBtn");
        const filterArchivedBtnOld = document.querySelector(
            "#filterArchiveCommBtn"
        );

        const saveBtns = saveBtnOlds.map((btn, i) => btn.cloneNode(true));
        const discartBtns = discartBtnOlds.map((btn) => btn.cloneNode(true));

        const sendBtn = sendBtnOld.cloneNode(true);
        const removeBtn = removeBtnOld.cloneNode(true);
        const createBtn = createBtnOld.cloneNode(true);
        const archiveBtn = archiveBtnOld.cloneNode(true);
        const unarchiveBtn = unarchiveBtnOld.cloneNode(true);
        const shrinkBtn = shrinkBtnOld.cloneNode(true);
        const expandBtn = expandBtnOld.cloneNode(true);
        const cancelBtn = cancelBtnOld.cloneNode(true);
        const uncancelBtn = uncancelBtnOld.cloneNode(true);
        const filterActiveBtn = filterActiveBtnOld.cloneNode(true);
        const filterArchivedBtn = filterArchivedBtnOld.cloneNode(true);

        saveBtnOlds.map((btn) =>
            saveBtns.map((newBtn) => btn.parentNode.replaceChild(newBtn, btn))
        );
        discartBtnOlds.map((btn) =>
            discartBtns.map((newBtn) => btn.parentNode.replaceChild(newBtn, btn))
        );

        sendBtnOld.parentNode.replaceChild(sendBtn, sendBtnOld);
        removeBtnOld.parentNode.replaceChild(removeBtn, removeBtnOld);
        createBtnOld.parentNode.replaceChild(createBtn, createBtnOld);
        archiveBtnOld.parentNode.replaceChild(archiveBtn, archiveBtnOld);
        unarchiveBtnOld.parentNode.replaceChild(unarchiveBtn, unarchiveBtnOld);
        shrinkBtnOld.parentNode.replaceChild(shrinkBtn, shrinkBtnOld);
        expandBtnOld.parentNode.replaceChild(expandBtn, expandBtnOld);
        cancelBtnOld.parentNode.replaceChild(cancelBtn, cancelBtnOld);
        uncancelBtnOld.parentNode.replaceChild(uncancelBtn, uncancelBtnOld);
        filterActiveBtnOld.parentNode.replaceChild(
            filterActiveBtn,
            filterActiveBtnOld
        );
        filterArchivedBtnOld.parentNode.replaceChild(
            filterArchivedBtn,
            filterArchivedBtnOld
        );

        if (permission <= 3) {
            sendBtn.style.display = "none";
            cancelBtn.style.display = "none";
            archiveBtn.style.display = "none";
            unarchiveBtn.style.display = "none";
            removeBtn.style.display = "none";
            createBtn.style.display = "none";
        } else {
            //check state of comm to show buttons
            if (typeof comm !== "undefined") {
                if (comm.Status === 0) {
                    if (comm.Id != -1 && comm.Id != 0) sendBtn.style.display = "";
                    cancelBtn.style.display = "none";
                    archiveBtn.style.display = "none";
                    unarchiveBtn.style.display = "none";
                    if (comm.Id != -1 && comm.Id != 0) removeBtn.style.display = "";

                    removeBtn.addEventListener(
                        "click",
                        () => handleRemoveCommunique(comm),
                        false
                    );

                    //add listeners
                    saveBtns.map((btn) =>
                        btn.addEventListener(
                            "click",
                            async () => {
                                if (comm.Subject.length < 1) {
                                    DevExpress.ui.dialog.alert(
                                        PARA_GUARDAR_COMUNICADO_DEBE_CONTENER_ASUNTO,
                                        GUARDAR_COMUNICADO
                                    );
                                    return;
                                }

                                const response = await saveCommunique(comm);
                                if (!!response) {
                                    const commId = comm.Id > -1 ? comm.Id : null;
                                    reloadCardsList(commId);
                                } else {
                                    DevExpress.ui.dialog.alert(
                                        NO_SE_HA_PODIDO_GUARDAR_COMUNICADO,
                                        GUARDAR_COMUNICADO
                                    );
                                }
                            },
                            false
                        )
                    );

                    discartBtns.map((btn) =>
                        btn.addEventListener(
                            "click",
                            async () => {
                                const selectedCard = document.querySelector(
                                    ".communiqueCardClicked"
                                );

                                if (selectedCard) {
                                    const userConfims = await DevExpress.ui.dialog.confirm(
                                        QUIERE_SEGUIR_PERDER_CAMBIOS,
                                        DESCARTAR_CAMBIOS
                                    );

                                    if (userConfims) {
                                        setEditing(false);
                                        selectedCard.click();
                                    }
                                    /* } else if (comm.Id === -1) {
                                    handleNewCommunique(); */
                                } else {
                                    const communiqueCards = [
                                        ...document.querySelectorAll(".communiqueCard"),
                                    ];
                                    const firstCommuniqueCard = communiqueCards.find(
                                        (card) => card.style.display !== "none"
                                    );
                                    if (firstCommuniqueCard) {
                                        setEditing(false);
                                        firstCommuniqueCard.click();
                                    } else {
                                        handleNewCommunique();
                                    }
                                }
                            },
                            false
                        )
                    );

                    sendBtn.addEventListener(
                        "click",
                        () => handleSendCommunique(comm),
                        false
                    );
                } else if (comm.Status === 1) {
                    sendBtn.style.display = "none";
                    cancelBtn.style.display = "";
                    uncancelBtn.style.display = "none";
                    removeBtn.style.display = "none";

                    cancelBtn.addEventListener(
                        "click",
                        () => handleCancelCommunique(comm),
                        false
                    );

                    if (!comm.Archived) {
                        archiveBtn.style.display = "";
                        unarchiveBtn.style.display = "none";

                        archiveBtn.addEventListener(
                            "click",
                            async () => {
                                comm.Archived = true;
                                const response = await saveCommunique(comm);
                                if (!!response) {
                                    reloadCardsList();
                                    setEditing(false);
                                } else {
                                    DevExpress.ui.dialog.alert(
                                        NO_SE_HA_PODIDO_ARCHIVAR_COMUNICADO,
                                        ARCHIVAR_COMUNICADO
                                    );
                                }
                            },
                            false
                        );
                    } else {
                        archiveBtn.style.display = "none";
                        unarchiveBtn.style.display = "";
                        removeBtn.style.display = "none";

                        unarchiveBtn.addEventListener(
                            "click",
                            async () => {
                                comm.Archived = false;
                                const response = await saveCommunique(comm);
                                if (!!response) {
                                    reloadCardsList();
                                    setEditing(false);
                                } else {
                                    DevExpress.ui.dialog.alert(
                                        NO_SE_HA_PODIDO_DESARCHIVAR_COMUNICADO,
                                        DESARCHIVAR_COMUNICADO
                                    );
                                }
                            },
                            false
                        );
                    }
                } else if (comm.Status === 3) {
                    sendBtn.style.display = "none";
                    cancelBtn.style.display = "none";
                    uncancelBtn.style.display = "";
                    archiveBtn.style.display = "none";
                    unarchiveBtn.style.display = "none";
                    removeBtn.style.display = "none";
                    uncancelBtn.addEventListener(
                        "click",
                        () => handleUncancelCommunique(comm),
                        false
                    );
                } else {
                    //add listeners
                }
            } else {
                removeBtn.style.display = "none";
                sendBtn.style.display = "none";
            }

            if (typeof comm === "undefined" || (
                comm.Id !== -1 &&
                Object.entries(state.communiques).filter(
                    (c) => c[1].Subject === "" && c[1].Id !== 0
                ).length === 0)
            ) {
                createBtn.style.display = "";
                createBtn.addEventListener("click", handleNewCommunique, false);
            }
        }

        shrinkBtn.addEventListener(
            "click",
            () => {
                handleShrinkExpandCommTree(shrinkBtn, expandBtn, true);
            },
            false
        );
        expandBtn.addEventListener(
            "click",
            () => {
                handleShrinkExpandCommTree(shrinkBtn, expandBtn, false);
            },
            false
        );

        filterActiveBtn.addEventListener(
            "click",
            () => {
                filterActiveBtn.classList.add("activeTab");
                filterArchivedBtn.classList.remove("activeTab");
                filterCommuniquesBy("active");
            },
            false
        );
        filterArchivedBtn.addEventListener(
            "click",
            () => {
                filterActiveBtn.classList.remove("activeTab");
                filterArchivedBtn.classList.add("activeTab");
                filterCommuniquesBy("archived");
            },
            false
        );
    };

    function buildCardsPanelObserver(container) {
        const transparentLayer = document.createElement("div");
        const parent = container.parentNode;

        transparentLayer.classList.add("scrollPanelLayer");
        parent.appendChild(transparentLayer);
        parent.style.verticalAlign = "top";
        parent.style.position = "relative";

        return new IntersectionObserver(
            (entries) => {
                if (entries[0].isIntersecting && entries[0].intersectionRatio >= 0.5) {
                    transparentLayer.style.opacity = 0;
                } else {
                    transparentLayer.style.opacity = 1;
                }
            },
            { root: container, threshold: [0, 0.5, 1] }
        );
    }
})();

var cursorIndex, cursorLength = 0;
var currentFormat;

function addImageShown() {
    var editor = $("#messageEditor").dxHtmlEditor("instance");
    currentFormat = editor.getFormat();
    var cursor = editor.getSelection();
    cursorIndex = cursor ? cursor.index : 0;
    cursorLength = cursor ? cursor.length : 0;
    if (!!currentFormat.imageSrc) {
        $('#txtImageURL').dxTextBox('instance').option('value', currentFormat.imageSrc);
        $('#txtHeightImage').dxTextBox('instance').option('value', currentFormat.height);
        $('#txtWidthImage').dxTextBox('instance').option('value', currentFormat.width);
        $('#txtAltImage').dxTextBox('instance').option('value', currentFormat.alt);
    } else {
        $('#txtImageURL').dxTextBox('instance').option('value', null);
        $('#txtHeightImage').dxTextBox('instance').option('value', null);
        $('#txtWidthImage').dxTextBox('instance').option('value', null);
        $('#txtAltImage').dxTextBox('instance').option('value', null);
    }
}

function cancelImage() {
    var popup = $("#addImagePopup").dxPopup("instance");
    popup.hide();
}

function addImage() {
    var txtImageURL = $('#txtImageURL').dxTextBox('instance').option('value');
    var txtHeightImage = $('#txtHeightImage').dxTextBox('instance').option('value');
    var txtWidthImage = $('#txtWidthImage').dxTextBox('instance').option('value');
    var txtAltImage = $('#txtAltImage').dxTextBox('instance').option('value');

    if (txtImageURL == null || txtImageURL == "")
        DevExpress.ui.notify(window.parent.Globalize.formatMessage('roCommuniqueeEmptyImageURLError'), "error", 3000);
    else {
        if (isBase64(txtImageURL))
            if (checkOnlyDigitsOrEmpty(txtHeightImage) && checkOnlyDigitsOrEmpty(txtWidthImage)) {
                var editor = $("#messageEditor").dxHtmlEditor("instance");

                if (!!currentFormat.imageSrc) {
                    editor.delete(cursorIndex - 1, 1);
                }
                editor.insertEmbed(cursorIndex, "extendedImage", {
                    src: txtImageURL,
                    alt: txtAltImage,
                    width: txtWidthImage,
                    height: txtHeightImage
                });
                var popup = $("#addImagePopup").dxPopup("instance");
                popup.hide();
            }
            else
                DevExpress.ui.notify(window.parent.Globalize.formatMessage('roCommuniqueeInvalidMeasureError'), "error", 3000);
        else
            DevExpress.ui.notify(window.parent.Globalize.formatMessage('roCommuniqueeInvalidImageURLError'), "error", 3000);
    }
}

function isBase64(str) {
    if (str === '' || str.trim() === '') { return false; }
    try {
        return btoa(atob(str.split(',')[1])) == str.split(',')[1];
    } catch (err) {
        return false;
    }
}

function checkImage(url) {
    return (url.match(/\.(jpeg|jpg|gif|png)$/) != null);
}

function checkOnlyDigitsOrEmpty(_string) {
    if (_string == null || _string == '')
        return true;
    if (_string.match(/^[0-9]*$/) != null) {
        return true;
    }
    else {
        return false;
    }
}