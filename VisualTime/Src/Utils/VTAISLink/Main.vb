Imports System.Data.OleDb
Imports Robotics.Base.DTOs
Imports Robotics.Business.PlanningEngine
Imports Robotics.Base
Imports Microsoft.Office.Interop
Imports System.ComponentModel
Imports DevExpress.XtraEditors.Repository
Imports DevExpress.XtraGrid
Imports DevExpress.XtraEditors
Imports Robotics.VTBase
Imports System.Runtime.InteropServices.ComTypes

Public Class Main
    Sub New()

        InitializeComponent()
        ' This line of code is generated by Data Source Configuration Wizard
        ' Fill a JsonDataSource
        JsonDataSource1.Fill()
    End Sub

    Private _databaseName As String = String.Empty
    Private _databasePath As String
    Private _oConn As OleDbConnection
    Private _Request As roPlanningEngineRequest
    Private _Response As roPlanningEngineResponse
    Private _RequestFileName As String = String.Empty
    Private _ResponseFileName As String = String.Empty
    Private _ScenarioId As String = String.Empty

    Public ReadOnly Property DataSource As String
        Get
            Return _databasePath & "" & _databaseName
        End Get
    End Property

    Private Sub InitApp(sender As Object, e As EventArgs) Handles MyBase.Load
        cmbDataSource.SelectedIndex = 0
        _oConn = New OleDbConnection("Provider=Microsoft.ACE.OLEDB.12.0;Data Source=""" & DataSource & """")
        nudMaxEmployees.Value = MapModels.AvailablePersons(roTypes.Any2Time(dtFrom.Value).DateOnly, roTypes.Any2Time(dtTo.Value).DateOnly, _oConn)
    End Sub

    Private Sub Menu_OpenDevTools(sender As Object, e As EventArgs) Handles DevToolsToolStripMenuItem.Click
        Dim frmDevTools As New DevTools
        frmDevTools.Show()
    End Sub

    Private Sub OpenSelectedAcces(sender As Object, e As EventArgs) Handles btnOpenAccess.Click
        System.Diagnostics.Process.Start(DataSource)
    End Sub

    Private Sub SelectedDatabaseChanged(sender As Object, e As EventArgs) Handles cmbDataSource.SelectedIndexChanged
        _databaseName = cmbDataSource.SelectedItem
    End Sub

    Private Sub LoadRequest(sender As Object, e As EventArgs) Handles btnLoad.Click
        ResetScenario()

        LoadCalendar()

        _ScenarioId = Now.ToString("yyyyMMdd_HHmmss")

        Me.Cursor = Cursors.WaitCursor
        _Request = MapModels.PopulateScenario(roTypes.Any2Time(dtFrom.Value).DateOnly, roTypes.Any2Time(dtTo.Value).DateOnly, chkDiscardPreAssigned.Checked, _oConn, nudMaxEmployees.Value)
        If _Request.scenarioRequest IsNot Nothing AndAlso _Request.scenarioRequest.teams.Any Then
            _Request.scenarioRequest.criteria.maxExecutionTime = nudMaxCalcMinutes.Value
            PersistRequestOnFile()
            btnSendRequest.Enabled = True
            btnShowRequest.Enabled = True
            lblTotalDays.Text = roTypes.Any2Time(dtTo.Value).DateOnly.Subtract(roTypes.Any2Time(dtFrom.Value).DateOnly).Days + 1
            lblTotalLocations.Text = _Request.scenarioRequest.teams.Count.ToString
            lblTotalUsers.Text = _Request.scenarioRequest.people.Count.ToString
            Dim lTotalToCover As Integer = 0
            For Each oTeam As Team In _Request.scenarioRequest.teams
                For Each kvp As DictionaryEntry In oTeam.datePositions
                    lTotalToCover = lTotalToCover + CType(oTeam.datePositions.Item(kvp.Key), Array).Length
                Next
            Next

            lblTotalToCover.Text = lTotalToCover
            Me.Cursor = Cursors.Default
        Else
            Me.Cursor = Cursors.Default
            MsgBox("No hay ninguna planificación de equipo definida para el periodo seleccionado", MsgBoxStyle.Exclamation, "Sin equipos definida")
        End If
    End Sub

    Private Sub LoadCalendar()
        ' Cargo fechas

        Dim oledbCommand As OleDbCommand
        Dim oledbParameter1 As OleDbParameter
        Dim strSQL As String = String.Empty
        strSQL = "DELETE FROM Calendar"
        oledbCommand = New OleDbCommand(strSQL)
        oledbCommand.Connection = _oConn
        If _oConn.State <> ConnectionState.Open Then _oConn.Open()
        oledbCommand.ExecuteNonQuery()

        Dim dDate As Date
        For i = 0 To roTypes.Any2Time(dtTo.Value).DateOnly.Subtract(roTypes.Any2Time(dtFrom.Value).DateOnly).Days
            dDate = roTypes.Any2Time(dtFrom.Value).DateOnly.AddDays(i)
            strSQL = "INSERT INTO Calendar ([Date]) VALUES (@date)"
            oledbCommand = New OleDbCommand(strSQL)
            oledbCommand.Connection = _oConn
            If _oConn.State <> ConnectionState.Open Then _oConn.Open()
            oledbParameter1 = New OleDbParameter("@date", OleDbType.Date)
            oledbParameter1.Value = dDate
            oledbCommand.Parameters.Add(oledbParameter1)
            oledbCommand.ExecuteNonQuery()
        Next

    End Sub

    Private Sub ResetScenario()
        btnSendRequest.Enabled = False
        btnShowRequest.Enabled = False
        btnShowResponse.Enabled = False
        btnReport.Enabled = False
        lblTotalDays.Text = ""
        lblTotalLocations.Text = ""
        lblTotalUsers.Text = ""
        lblTotalToCover.Text = ""
        lblTotalCovered.Text = ""
        lblHard.Text = ""
        lblMedium.Text = ""
        lblSoft.Text = ""
        lblTotalSegs.Text = ""
        grdCalendar.DataSource = Nothing
        grdCalendar.RefreshDataSource()
        GridView1.PopulateColumns()
    End Sub

    Private Sub SendRequest(sender As Object, e As EventArgs) Handles btnSendRequest.Click
        Dim idRequest As Integer = 0

        Dim oEngineState As New roPlanningEngineState(-1)
        Dim oEngine As New roPlanningEngineManager(oEngineState)
        Dim scoreQueue As New Queue(Of Score)(3)
        oEngine.SolverURI = txtURL.Text
        Dim oStartResponse As roPlanningEngineResponse
        Me.Cursor = Cursors.WaitCursor
        Dim dStart As DateTime = Now
        oStartResponse = oEngine.SendRequest(_Request)
        If oEngineState.Result <> roPlanningEngineState.ResultEnum.NoError Then
            MsgBox("Oops: --- " & vbCrLf & oEngineState.ResultDetail)
        Else
            idRequest = oStartResponse.scenarioResponse.id
            _Response = Nothing
            While _Response Is Nothing OrElse (_Response.scenarioResponse.status <> "COMPLETED" AndAlso Not (scoreQueue.Count = 3 AndAlso (scoreQueue(0).hard = scoreQueue(1).hard AndAlso scoreQueue(0).hard = scoreQueue(2).hard) AndAlso (scoreQueue(0).medium = scoreQueue(1).medium AndAlso scoreQueue(0).medium = scoreQueue(2).medium) AndAlso (scoreQueue(0).soft = scoreQueue(1).soft AndAlso scoreQueue(0).soft = scoreQueue(2).soft)))
                _Response = oEngine.CheckRequest(idRequest).Result
                If scoreQueue.Count = 3 Then scoreQueue.Dequeue()
                scoreQueue.Enqueue(_Response.scenarioResponse.score)
                lblHard.Text = _Response.scenarioResponse.score.hard
                lblMedium.Text = _Response.scenarioResponse.score.medium
                lblSoft.Text = _Response.scenarioResponse.score.soft
                If _Response Is Nothing OrElse _Response.scenarioResponse.status <> "COMPLETED" Then
                    Threading.Thread.Sleep(250)
                End If
            End While

            lblTotalSegs.Text = Now.Subtract(dStart).TotalSeconds.ToString("0.00")

            btnShowResponse.Enabled = True
            'btnReport.Enabled = True

            PersistResponseOnFile()

            Dim strSQL As String = String.Empty
            Dim lTotalCovered As Integer
            Dim oledbCommand As OleDbCommand
            Dim oledbParameter1 As OleDbParameter
            Dim oledbParameter2 As OleDbParameter
            Dim oledbParameter3 As OleDbParameter

            strSQL = "DELETE FROM UsersAssignments"
            oledbCommand = New OleDbCommand(strSQL)
            oledbCommand.Connection = _oConn
            If _oConn.State <> ConnectionState.Open Then _oConn.Open()
            oledbCommand.ExecuteNonQuery()

            For Each team As KeyValuePair(Of String, AssignedTeam) In _Response.scenarioResponse.scenarioSolution.assignedTeams
                ' Nivel 0: Todos los equipos
                For Each datePositions As KeyValuePair(Of String, Dictionary(Of String, AssignedPosition)) In team.Value.dateAssignedPositionsList
                    ' Para un equipo: Nivel fecha con todas sus posiciones
                    For Each position As KeyValuePair(Of String, AssignedPosition) In datePositions.Value
                        ' Nivel posición, para un equipo y fecha
                        If position.Value.assignedPersonId <> "notAssigned" Then
                            lTotalCovered = lTotalCovered + 1

                            Dim idUser As Integer = position.Value.assignedPersonId.Split("-")(0)
                            Dim idSlot As Integer = position.Value.positionId.Split(".")(0)
                            Dim iPosition As Integer = position.Value.positionId.Split(".")(1)

                            ' Asigno la posición al usuario
                            strSQL = "INSERT INTO UsersAssignments (IdUser, IdSlot, [Position]) VALUES (@iduser,@idslot,@position)"
                            oledbCommand = New OleDbCommand(strSQL)
                            oledbCommand.Connection = _oConn
                            If _oConn.State <> ConnectionState.Open Then _oConn.Open()
                            oledbParameter1 = New OleDbParameter("@iduser", OleDbType.Integer)
                            oledbParameter1.Value = idUser
                            oledbParameter2 = New OleDbParameter("@idslot", OleDbType.Integer)
                            oledbParameter2.Value = idSlot
                            oledbParameter3 = New OleDbParameter("@position", OleDbType.Integer)
                            oledbParameter3.Value = iPosition
                            oledbCommand.Parameters.Add(oledbParameter1)
                            oledbCommand.Parameters.Add(oledbParameter2)
                            oledbCommand.Parameters.Add(oledbParameter3)
                            oledbCommand.ExecuteNonQuery()
                        End If
                    Next
                Next
            Next

            ShowCalendar()

            lblTotalCovered.Text = lTotalCovered
        End If
        Me.Cursor = Cursors.Default
    End Sub

    Private Sub PersistRequestOnFile()
        Dim sJsonRequest As String = roJSONHelper.SerializeNewtonSoft(_Request)
        Dim requestFile As System.IO.StreamWriter
        _RequestFileName = _databasePath & "request_" & _ScenarioId & ".json"
        requestFile = My.Computer.FileSystem.OpenTextFileWriter(_RequestFileName, True)
        requestFile.Write(sJsonRequest)
        requestFile.Close()
    End Sub

    Private Sub PersistResponseOnFile()
        Dim sJsonRequest As String = roJSONHelper.SerializeNewtonSoft(_Response)
        Dim requestFile As System.IO.StreamWriter
        _ResponseFileName = _databasePath & "response_" & _ScenarioId & ".json"
        requestFile = My.Computer.FileSystem.OpenTextFileWriter(_ResponseFileName, True)
        requestFile.Write(sJsonRequest)
        requestFile.Close()
    End Sub

    Private Sub ShowRequestFile(sender As Object, e As EventArgs) Handles btnShowRequest.Click
        System.Diagnostics.Process.Start(_RequestFileName)
    End Sub

    Private Sub ShowResponseFile(sender As Object, e As EventArgs) Handles btnShowResponse.Click
        System.Diagnostics.Process.Start(_ResponseFileName)
    End Sub

    Private Sub ReportScenario(sender As Object, e As EventArgs) Handles btnReport.Click
        'TODO: Empaqueta _RequestFileName y _ResponseFileName y abre correo con el attach para poder añadir explicación y elegir destinatario
    End Sub

    Private Sub Main_Closing(sender As Object, e As CancelEventArgs) Handles Me.Closing
        If _oConn IsNot Nothing AndAlso _oConn.State = ConnectionState.Open Then _oConn.Close()
    End Sub

    Private Sub ShowCalendar()
        Dim dTable As New System.Data.DataTable
        Dim dataColumn As DataColumn

        Dim strSQL As String = String.Empty
        Dim oledbCommand As OleDbCommand
        Dim oledbParameter1 As OleDbParameter
        Dim oledbParameter2 As OleDbParameter
        strSQL = "SELECT TeamsSchedule.*, Locations.*, Roles.*, Shifts.* " &
                 " FROM Shifts INNER JOIN (Roles INNER JOIN (Locations INNER JOIN TeamsSchedule ON Locations.Id = TeamsSchedule.IdTeam) ON Roles.Id = TeamsSchedule.IdRole) ON Shifts.Id = TeamsSchedule.IdShift" &
                 " WHERE TeamsSchedule.Date >= @beginDate And TeamsSchedule.Date <= @endDate ORDER BY TeamsSchedule.IdTeam, TeamsSchedule.Date"
        oledbCommand = New OleDbCommand(strSQL)
        oledbCommand.Connection = _oConn
        If _oConn.State <> ConnectionState.Open Then _oConn.Open()
        oledbParameter1 = New OleDbParameter("@beginDate", OleDbType.Date)
        oledbParameter1.Value = roTypes.Any2Time(dtFrom.Value).DateOnly
        oledbParameter2 = New OleDbParameter("@endDate", OleDbType.Date)
        oledbParameter2.Value = roTypes.Any2Time(dtTo.Value).DateOnly
        oledbCommand.Parameters.Add(oledbParameter1)
        oledbCommand.Parameters.Add(oledbParameter2)

        Dim dCalendar As New Dictionary(Of String, CalendarRow)

        If _oConn.State <> ConnectionState.Open Then _oConn.Open()
        Dim oDR As OleDbDataReader
        oDR = oledbCommand.ExecuteReader()

        Dim sColum0 As String
        Dim oCalendarRow As CalendarRow

        If oDR IsNot Nothing Then
            While oDR.Read
                sColum0 = oDR("LocationName") & "@" & oDR("Role") & "@" & oDR("ShiftName")
                If Not dCalendar.Keys.Contains(sColum0) Then
                    oCalendarRow = New CalendarRow
                    For i = 0 To roTypes.Any2Time(dtTo.Value).DateOnly.Subtract(roTypes.Any2Time(dtFrom.Value).DateOnly).Days
                        oCalendarRow.Cells.Add(New CalendarCell)
                    Next
                    dCalendar.Add(sColum0, oCalendarRow)
                End If
                Dim dDate As Date = oDR("Date")
                dCalendar.Item(sColum0).Cells(dDate.Subtract(roTypes.Any2Time(dtFrom.Value).DateOnly).Days).TotalRequired = oDR("Quantity")
                dCalendar.Item(sColum0).Cells(dDate.Subtract(roTypes.Any2Time(dtFrom.Value).DateOnly).Days).IdSlot = oDR("IdSlot")
            End While
        End If

        Dim dCalendarDate As Date = Date.MinValue
        Dim sKey As String = String.Empty
        For i As Integer = 0 To roTypes.Any2Time(dtTo.Value).DateOnly.Subtract(roTypes.Any2Time(dtFrom.Value).DateOnly).Days
            dCalendarDate = roTypes.Any2Time(dtFrom.Value).DateOnly.AddDays(i)

            strSQL = "SELECT Users.*, TeamsSchedule.*, Locations.*, Shifts.*, Roles.* " &
                     " FROM (Users INNER JOIN UsersAssignments ON Users.Id = UsersAssignments.IdUser) INNER JOIN (Roles INNER JOIN (Shifts INNER JOIN (Locations INNER JOIN TeamsSchedule ON Locations.Id = TeamsSchedule.IdTeam) ON Shifts.Id = TeamsSchedule.IdShift) ON Roles.Id = TeamsSchedule.IdRole) ON UsersAssignments.IdSlot = TeamsSchedule.IdSlot " &
                     " WHERE TeamsSchedule.Date = @date ORDER BY TeamsSchedule.Date, TeamsSchedule.IdSlot"
            oledbCommand = New OleDbCommand(strSQL)
            oledbCommand.Connection = _oConn
            oledbParameter1 = New OleDbParameter("@beginDate", OleDbType.Date)
            oledbParameter1.Value = roTypes.Any2Time(dCalendarDate).DateOnly
            oledbCommand.Parameters.Add(oledbParameter1)
            If _oConn.State <> ConnectionState.Open Then _oConn.Open()
            oDR = oledbCommand.ExecuteReader()
            If oDR IsNot Nothing Then
                While oDR.Read
                    sKey = oDR("LocationName") & "@" & oDR("Role") & "@" & oDR("ShiftName")
                    If dCalendar.Keys.Contains(sKey) Then
                        dCalendar.Item(sKey).Cells(i).Detail = dCalendar.Item(sKey).Cells(i).Detail & oDR("UserName") & vbCrLf
                        dCalendar.Item(sKey).Cells(i).IdSlot = oDR("IdSlot")
                        dCalendar.Item(sKey).Cells(i).Total = dCalendar.Item(sKey).Cells(i).Total + 1
                        dCalendar.Item(sKey).Cells(i).TotalRequired = oDR("Quantity")
                    End If
                End While
            End If
        Next

        ' Creamos tabla para DataSource
        ' Cabecera
        dataColumn = New DataColumn(" ", GetType(String))
        dTable.Columns.Add(dataColumn)
        dataColumn = New DataColumn("  ", GetType(String))
        dTable.Columns.Add(dataColumn)
        For i As Integer = 0 To roTypes.Any2Time(dtTo.Value).DateOnly.Subtract(roTypes.Any2Time(dtFrom.Value).DateOnly).Days
            dCalendarDate = roTypes.Any2Time(dtFrom.Value).DateOnly.AddDays(i)
            dataColumn = New DataColumn(dCalendarDate.ToString("dd/MM"), GetType(String))
            dTable.Columns.Add(dataColumn)
        Next

        ' Filas
        Dim oRow As DataRow
        Dim icol As Integer = 1
        For Each cRow As KeyValuePair(Of String, CalendarRow) In dCalendar
            oRow = dTable.NewRow
            oRow(0) = cRow.Key.Split("@")(0)
            oRow(1) = cRow.Key.Split("@")(1) & vbCrLf & cRow.Key.Split("@")(2)

            icol = 2
            For Each oCel As CalendarCell In cRow.Value.Cells
                oRow(icol) = oCel.Detail
                For j = 0 To (oCel.TotalRequired - oCel.Total - 1)
                    oRow(icol) = oRow(icol) & "--??--" & vbCrLf
                Next
                icol = icol + 1
            Next
            dTable.Rows.Add(oRow)
        Next

        ' Finalmente añado a los no asignados en una última fila
        Dim sFree As String = String.Empty
        oRow = dTable.NewRow
        oRow(0) = "ZZZ -- Sin equipo -- ZZZ"
        oRow(1) = "-- Libre --"
        For i As Integer = 0 To roTypes.Any2Time(dtTo.Value).DateOnly.Subtract(roTypes.Any2Time(dtFrom.Value).DateOnly).Days
            sFree = String.Empty
            dCalendarDate = roTypes.Any2Time(dtFrom.Value).DateOnly.AddDays(i)
            strSQL = "SELECT * FROM Libres WHERE TodosDisponibles.[Date] = @date ORDER BY TodosDisponibles.UserName ASC "
            oledbCommand = New OleDbCommand(strSQL)
            oledbCommand.Connection = _oConn
            If _oConn.State <> ConnectionState.Open Then _oConn.Open()
            oledbParameter1 = New OleDbParameter("@date", OleDbType.Date)
            oledbParameter1.Value = roTypes.Any2Time(dCalendarDate).DateOnly
            oledbCommand.Parameters.Add(oledbParameter1)
            oDR = oledbCommand.ExecuteReader()
            If oDR IsNot Nothing Then
                While oDR.Read
                    sFree = $"{sFree}{oDR("TodosDisponibles.UserName")}{vbCrLf}"
                End While
                oRow(i + 2) = sFree
            End If
        Next
        dTable.Rows.Add(oRow)


        grdCalendar.DataSource = dTable
        grdCalendar.RefreshDataSource()

        Dim noteMemo As RepositoryItemMemoEdit = New RepositoryItemMemoEdit
        grdCalendar.RepositoryItems.Add(noteMemo)
        'For Each col As Columns.GridColumn In GridView1.Columns
        '    col.ColumnEdit = noteMemo
        'Next

        GridView1.Columns(0).GroupIndex = 1
        GridView1.ExpandAllGroups()

        Dim gridFormatRule As GridFormatRule
        Dim formatConditionRuleExpression As FormatConditionRuleExpression
        Dim sColName As String
        For Each ogc As Columns.GridColumn In GridView1.Columns
            ogc.ColumnEdit = noteMemo
            gridFormatRule = New GridFormatRule
            formatConditionRuleExpression = New FormatConditionRuleExpression
            sColName = ogc.FieldName
            gridFormatRule.Column = ogc
            gridFormatRule.ApplyToRow = False
            formatConditionRuleExpression.PredefinedName = "Red Fill, Red Text"
            formatConditionRuleExpression.Expression = "Contains([" & sColName & "],'??')"
            gridFormatRule.Rule = formatConditionRuleExpression
            GridView1.FormatRules.Add(gridFormatRule)
        Next

        GridView1.ExportToXlsx(_databasePath & "calendarResult_" & _ScenarioId & ".xlsx")
        oledbCommand.Dispose()
    End Sub

    Private Sub PeriodChange(sender As Object, e As EventArgs) Handles dtFrom.ValueChanged, dtTo.ValueChanged
        ResetScenario()
    End Sub

    Private Sub Label4_Click(sender As Object, e As EventArgs) Handles Label4.Click

    End Sub
End Class

Public Class CalendarRow
    Public Property Cells As List(Of CalendarCell)

    Public Sub New()
        Cells = New List(Of CalendarCell)
    End Sub
End Class

Public Class CalendarCell
    Public Property IdSlot As Integer
    Public Property Total As Integer
    Public Property TotalRequired As Integer
    Public Property Detail As String
    Public Sub New()
        Total = 0
        TotalRequired = 0
        Detail = String.Empty
    End Sub
End Class

Public Class MapModels

    Public Shared Function PopulateScenario(startDate As Date, endDate As Date, bDiscardPreassigned As Boolean, _oConn As OleDbConnection, maxUsers As Integer) As roPlanningEngineRequest
        Dim oRequest As New roPlanningEngineRequest
        Try
            Dim oScenario As New ScenarioRequest
            ' 0.- Identificador
            oScenario.algorithm = "cegid_VTAI_v0"
            oScenario.id = "300"

            ' 0.1.- Criterios generales
            Dim oScenarioCriteria As New Criteria
            oScenario.criteria = oScenarioCriteria
            oScenario.criteria.startHorizonDate = startDate
            oScenario.criteria.endHorizonDate = endDate

            ' 1.- Personas
            Dim strSQL As String = $"   SELECT TOP {maxUsers} [Users].id AS iduser, [Users].*, [Agreements].*, [Roles].*, [Roles2].*, [Roles3].*, [Places].*, [Places2].*, [Places3].*
                                        FROM ((((((([Users]
                                        INNER JOIN [Agreements] ON [Agreements].id = [Users].labagree)
                                        LEFT JOIN [Roles] ON [Roles].Id = [Users].Role1)
                                        LEFT JOIN [Roles] AS [Roles2] ON [Roles2].Id = [Users].Role2)
                                        LEFT JOIN [Roles] AS [Roles3] ON [Roles3].Id = [Users].Role3)
                                        LEFT JOIN [Places] ON [Places].Id = [Users].Place1)
                                        LEFT JOIN [Places] AS [Places2] ON [Places2].Id = [Users].Place2)
                                        LEFT JOIN [Places] AS [Places3] ON [Places3].Id = [Users].Place3)
                                        WHERE users.begincontract <= @endDate And (users.endcontract >= @beginDate Or users.endcontract Is null) 
                                        ORDER BY RND([Users].id)"
            Dim oledbCommand As New OleDbCommand(strSQL)
            oledbCommand.Connection = _oConn
            If _oConn.State <> ConnectionState.Open Then _oConn.Open()
            Dim oledbParameter1 As New OleDbParameter("@beginDate", OleDbType.Date)
            oledbParameter1.Value = roTypes.Any2Time(startDate).DateOnly
            Dim oledbParameter2 As New OleDbParameter("@endDate", OleDbType.Date)
            oledbParameter2.Value = roTypes.Any2Time(endDate).DateOnly
            oledbCommand.Parameters.Add(oledbParameter1)
            oledbCommand.Parameters.Add(oledbParameter2)
            Dim oDR As OleDbDataReader
            oDR = oledbCommand.ExecuteReader()

            Dim oPerson As Person
            Dim lPerson As New List(Of Person)
            Dim bUserWorksOnFestive As Boolean = False
            Dim bUserWorksOnNonLaborable As Boolean = False
            If oDR IsNot Nothing Then
                While oDR.Read
                    ' 0.- General
                    oPerson = New Person
                    oPerson.id = oDR("iduser") & "-" & oDR("UserName")
                    bUserWorksOnNonLaborable = oDR("WorkOnNonLabour")
                    bUserWorksOnFestive = oDR("WorkOnFestive")
                    Select Case oDR("ContractType").ToString.ToUpper
                        Case "FIJO"
                            oPerson.typeContract = Enums.UserContractType.FIX.ToString.ToUpper '"FIX"
                        Case "PARCIAL"
                            oPerson.typeContract = Enums.UserContractType.PARTIAL.ToString.ToUpper '"PARTIAL"
                        Case "DISCONTINUO"
                            oPerson.typeContract = Enums.UserContractType.DISCONTINUOUS.ToString.ToUpper '"DISCONTINUOUS"
                    End Select

                    ' 1.- Roles
                    Dim oRoleList As New List(Of String)
                    If oDR("Role1") IsNot DBNull.Value Then oRoleList.Add(oDR("Roles.Role"))
                    If oDR("Role2") IsNot DBNull.Value Then oRoleList.Add(oDR("Roles2.Role"))
                    If oDR("Role3") IsNot DBNull.Value Then oRoleList.Add(oDR("Roles3.Role"))
                    oPerson.roles = oRoleList.ToArray

                    ' 2.- Ubicaciones
                    Dim oLocationsList As New List(Of String)
                    If oDR("Place1") IsNot DBNull.Value Then oLocationsList.Add(oDR("Places.Place"))
                    If oDR("Place2") IsNot DBNull.Value Then oLocationsList.Add(oDR("Places2.Place"))
                    If oDR("Place3") IsNot DBNull.Value Then oLocationsList.Add(oDR("Places3.Place"))
                    oPerson.locations = oLocationsList.ToArray

                    ' 2.- Calendario
                    Dim oPersonCalendarDate As CalendarDate
                    Dim lPersonCalendar As New List(Of CalendarDate)
                    Dim dCalendarDate As Date
                    Dim dStartAvailability As DateTime
                    Dim dEndAvailability As DateTime


                    For i As Integer = 0 To endDate.Subtract(startDate).Days
                        oPersonCalendarDate = New CalendarDate
                        dCalendarDate = startDate.AddDays(i)
                        oPersonCalendarDate.date = New [Date](dCalendarDate.Year, dCalendarDate.Month, dCalendarDate.Day)
                        ' ¿Es festivo?
                        strSQL = "SELECT count(*) as total FROM PublicHolidays WHERE DATEPART('d',Date) = @day AND DATEPART('m',Date) = @month AND (Year = ""Todos"" OR Year = @year) AND Id = @postalcode"
                        oledbCommand = New OleDbCommand(strSQL)
                        oledbCommand.Connection = _oConn
                        If _oConn.State <> ConnectionState.Open Then _oConn.Open()
                        oledbParameter1 = New OleDbParameter("@day", OleDbType.Integer)
                        oledbParameter1.Value = dCalendarDate.Day
                        oledbParameter2 = New OleDbParameter("@month", OleDbType.Integer)
                        oledbParameter2.Value = dCalendarDate.Month
                        Dim oledbParameter3 As New OleDbParameter("@year", OleDbType.VarChar)
                        oledbParameter3.Value = dCalendarDate.Year
                        Dim oledbParameter4 As New OleDbParameter("@postalcode", OleDbType.VarChar)
                        oledbParameter4.Value = oDR("PostalCode")
                        oledbCommand.Parameters.Add(oledbParameter1)
                        oledbCommand.Parameters.Add(oledbParameter2)
                        oledbCommand.Parameters.Add(oledbParameter3)
                        oledbCommand.Parameters.Add(oledbParameter4)
                        oPersonCalendarDate.type = Enums.DayType.NONLABORABLE.ToString.ToUpper ' "NONLABORABLE"
                        If oledbCommand.ExecuteScalar > 0 Then
                            oPersonCalendarDate.type = Enums.DayType.FESTIVE.ToString.ToUpper '"FESTIVE"
                        End If

                        ' ¿Está preasignado?
                        ' Si es necesario descarto planificaciones previas
                        If bDiscardPreassigned Then
                            strSQL = "DELETE FROM UsersAssignments"
                            oledbCommand = New OleDbCommand(strSQL)
                            oledbCommand.Connection = _oConn
                            If _oConn.State <> ConnectionState.Open Then _oConn.Open()
                            oledbCommand.ExecuteNonQuery()
                        End If

                        strSQL = "SELECT * FROM UsersAssignments INNER JOIN TeamsSchedule ON UsersAssignments.IdSlot = TeamsSchedule.IdSlot WHERE Date = @date AND UsersAssignments.IdUser = @iduser"
                        oledbCommand = New OleDbCommand(strSQL)
                        oledbCommand.Connection = _oConn
                        If _oConn.State <> ConnectionState.Open Then _oConn.Open()
                        oledbParameter1 = New OleDbParameter("@date", OleDbType.Date)
                        oledbParameter1.Value = roTypes.Any2Time(dCalendarDate).DateOnly
                        oledbParameter2 = New OleDbParameter("@iduser", OleDbType.Integer)
                        oledbParameter2.Value = oDR("iduser")
                        oledbCommand.Parameters.Add(oledbParameter1)
                        oledbCommand.Parameters.Add(oledbParameter2)

                        Dim oDRAssigned As OleDbDataReader
                        oDRAssigned = oledbCommand.ExecuteReader()
                        Dim oPreassigned As PreAssignedPosition
                        Dim lPreassigned As New List(Of PreAssignedPosition)
                        If oDRAssigned IsNot Nothing Then
                            While oDRAssigned.Read
                                oPreassigned = New PreAssignedPosition
                                oPreassigned.idPosition = oDRAssigned("UsersAssignments.IdSlot") & "." & oDRAssigned("Position")
                                oPreassigned.idTeam = oDRAssigned("IdTeam")
                                oPreassigned.isModifiable = Not oDRAssigned("Bloqued")
                                oPreassigned.modifiable = oPreassigned.isModifiable
                                lPreassigned.Add(oPreassigned)
                            End While
                            oPersonCalendarDate.preAssignedPositions = lPreassigned.ToArray
                        End If
                        oDRAssigned.Close()

                        Select Case dCalendarDate.DayOfWeek
                            Case DayOfWeek.Monday
                                dStartAvailability = oDR("MondayAvailabilityStart")
                                dEndAvailability = oDR("MondayAvailabilityEnd")
                                If oDR("MondayIsLabour") AndAlso oPersonCalendarDate.type <> "FESTIVE" Then oPersonCalendarDate.type = Enums.DayType.LABORABLE.ToString.ToUpper '"LABORABLE"
                            Case DayOfWeek.Tuesday
                                dStartAvailability = oDR("TuesdayAvailabilityStart")
                                dEndAvailability = oDR("TuesdayAvailabilityEnd")
                                If oDR("TuesdayIsLabour") AndAlso oPersonCalendarDate.type <> "FESTIVE" Then oPersonCalendarDate.type = Enums.DayType.LABORABLE.ToString.ToUpper '"LABORABLE"
                            Case DayOfWeek.Wednesday
                                dStartAvailability = oDR("WednesdayAvailabilityStart")
                                dEndAvailability = oDR("WednesdayAvailabilityEnd")
                                If oDR("WednesdayIsLabour") AndAlso oPersonCalendarDate.type <> "FESTIVE" Then oPersonCalendarDate.type = Enums.DayType.LABORABLE.ToString.ToUpper '"LABORABLE"
                            Case DayOfWeek.Thursday
                                dStartAvailability = oDR("ThursdayAvailabilityStart")
                                dEndAvailability = oDR("ThursdayAvailabilityEnd")
                                If oDR("ThursdayIsLabour") AndAlso oPersonCalendarDate.type <> "FESTIVE" Then oPersonCalendarDate.type = Enums.DayType.LABORABLE.ToString.ToUpper '"LABORABLE"
                            Case DayOfWeek.Friday
                                dStartAvailability = oDR("FridayAvailabilityStart")
                                dEndAvailability = oDR("FridayAvailabilityEnd")
                                If oDR("FridayIsLabour") AndAlso oPersonCalendarDate.type <> "FESTIVE" Then oPersonCalendarDate.type = Enums.DayType.LABORABLE.ToString.ToUpper '"LABORABLE"
                            Case DayOfWeek.Saturday
                                dStartAvailability = oDR("SaturdayAvailabilityStart")
                                dEndAvailability = oDR("SaturdayAvailabilityEnd")
                                If oDR("SaturdayIsLabour") AndAlso oPersonCalendarDate.type <> "FESTIVE" Then oPersonCalendarDate.type = Enums.DayType.LABORABLE.ToString.ToUpper '"LABORABLE"
                            Case DayOfWeek.Sunday
                                dStartAvailability = oDR("SundayAvailabilityStart")
                                dEndAvailability = oDR("SundayAvailabilityEnd")
                                If oDR("SundayIsLabour") AndAlso oPersonCalendarDate.type <> "FESTIVE" Then oPersonCalendarDate.type = Enums.DayType.LABORABLE.ToString.ToUpper '"LABORABLE"
                        End Select
                        DateTime.SpecifyKind(dStartAvailability, DateTimeKind.Local)
                        DateTime.SpecifyKind(dEndAvailability, DateTimeKind.Local)

                        ' ¿Está outofwork?
                        Dim bOutOfWork As Boolean = False
                        strSQL = "SELECT * FROM UsersDaysOut WHERE Date = @date AND IdUser = @iduser"
                        oledbCommand = New OleDbCommand(strSQL)
                        oledbCommand.Connection = _oConn
                        If _oConn.State <> ConnectionState.Open Then _oConn.Open()
                        oledbParameter1 = New OleDbParameter("@date", OleDbType.Date)
                        oledbParameter1.Value = roTypes.Any2Time(dCalendarDate).DateOnly
                        oledbParameter2 = New OleDbParameter("@iduser", OleDbType.Integer)
                        oledbParameter2.Value = oDR("iduser")
                        oledbCommand.Parameters.Add(oledbParameter1)
                        oledbCommand.Parameters.Add(oledbParameter2)

                        Dim oDRDaysOut As OleDbDataReader
                        oDRDaysOut = oledbCommand.ExecuteReader()
                        If oDRDaysOut IsNot Nothing Then
                            While oDRDaysOut.Read
                                bOutOfWork = True
                            End While
                        End If
                        oDRDaysOut.Close()

                        If bOutOfWork Then
                            oPersonCalendarDate.availabilities = {New Availability(New DateTime(dCalendarDate.Year, dCalendarDate.Month, dCalendarDate.Day, 0, 0, 0, DateTimeKind.Local), New DateTime(dCalendarDate.Year, dCalendarDate.Month, dCalendarDate.Day, 0, 0, 0, DateTimeKind.Local))}
                        Else
                            If (oPersonCalendarDate.type = Enums.DayType.FESTIVE.ToString.ToUpper AndAlso Not bUserWorksOnFestive) OrElse (oPersonCalendarDate.type = Enums.DayType.NONLABORABLE.ToString.ToUpper AndAlso Not bUserWorksOnNonLaborable) Then
                                oPersonCalendarDate.availabilities = {New Availability(New DateTime(dCalendarDate.Year, dCalendarDate.Month, dCalendarDate.Day, 0, 0, 0, DateTimeKind.Local), New DateTime(dCalendarDate.Year, dCalendarDate.Month, dCalendarDate.Day, 0, 0, 0, DateTimeKind.Local))}
                            Else
                                oPersonCalendarDate.availabilities = {New Availability(New DateTime(dCalendarDate.Year, dCalendarDate.Month, dCalendarDate.Day, dStartAvailability.Hour, dStartAvailability.Minute, 0, DateTimeKind.Local), New DateTime(dCalendarDate.Year, dCalendarDate.Month, dCalendarDate.Day, dEndAvailability.Hour, dEndAvailability.Minute, 0, DateTimeKind.Local))}
                            End If
                        End If

                        lPersonCalendar.Add(oPersonCalendarDate)
                        ' 1.2.- Constraints
                        Dim oPersonConstraints As New Constraints
                        oPersonConstraints.maxMinutesPerDateConstraint = New MaxMinutesPerDateConstraint(False, {oDR("MaxMondayHours"), oDR("MaxThursdayHours"), oDR("MaxWednesdayHours"), oDR("MaxTuesdayHours"), oDR("MaxFridayHours"), oDR("MaxSaturdayHours"), oDR("MaxSundayHours")})
                        oPersonConstraints.minMinutesPerDateConstraint = New MinMinutesPerDateConstraint(False, {oDR("MinMondayHours"), oDR("MinThursdayHours"), oDR("MinWednesdayHours"), oDR("MinTuesdayHours"), oDR("MinFridayHours"), oDR("MinSaturdayHours"), oDR("MinSundayHours")})
                        oPersonConstraints.minMinutesRestBetweenDatesConstraint = New MinMinutesRestBetweenDatesConstraint(True, 540)

                        oPerson.constraints = oPersonConstraints

                        ' 1.3.- Costes
                        oPerson.costs = New Costs(oDR("CostOnLaborable"), oDR("CostOnNoLaborable"), oDR("CostOnFestive"), oDR("ExtraHourPercentage"), oDR("CostOnLaborable"))
                    Next
                    oPerson.calendar = lPersonCalendar.ToArray
                    lPerson.Add(oPerson)
                End While
                oScenario.people = lPerson.ToArray
            End If
            oDR.Close()

            ' 2.- Equipos
            Dim oTeam As New Team
            Dim lTeams As New List(Of Team)
            Dim oPosition As Position
            Dim lPosition As New List(Of Position)
            Dim aDatePositions As New Hashtable

            strSQL = $" SELECT * FROM ((TeamsSchedule 
                        LEFT JOIN Shifts ON Shifts.Id = TeamsSchedule.IdShift) 
                        LEFT JOIN Places ON Places.Id = TeamsSchedule.IdPlace) 
                        LEFT JOIN Roles ON Roles.Id = TeamsSchedule.IdRole 
                        WHERE Date >= @beginDate AND Date <= @endDate ORDER BY IdTeam, Date"
            oledbCommand = New OleDbCommand(strSQL)
            oledbCommand.Connection = _oConn
            If _oConn.State <> ConnectionState.Open Then _oConn.Open()
            oledbParameter1 = New OleDbParameter("@beginDate", OleDbType.Date)
            oledbParameter1.Value = roTypes.Any2Time(startDate).DateOnly
            oledbParameter2 = New OleDbParameter("@endDate", OleDbType.Date)
            oledbParameter2.Value = roTypes.Any2Time(endDate).DateOnly
            oledbCommand.Parameters.Add(oledbParameter1)
            oledbCommand.Parameters.Add(oledbParameter2)

            Dim oDRTeamSchedule As OleDbDataReader
            oDRTeamSchedule = oledbCommand.ExecuteReader()
            Dim iCurrentTeamLocation As Integer = -1
            Dim dCurrentDate As Date = Date.MinValue
            Dim dStartShift As DateTime = DateTime.MinValue
            Dim dEndShift As DateTime = DateTime.MinValue
            If oDRTeamSchedule IsNot Nothing Then
                While oDRTeamSchedule.Read
                    If oDRTeamSchedule("IdTeam") <> iCurrentTeamLocation Then
                        ' Cambio de equipo
                        If iCurrentTeamLocation <> -1 Then
                            aDatePositions.Add(dCurrentDate.Year.ToString & "-" & dCurrentDate.Month.ToString & "-" & dCurrentDate.Day, lPosition.ToArray)
                            oTeam.datePositions = aDatePositions
                            lTeams.Add(oTeam)
                        End If
                        oTeam = New Team
                        oTeam.id = oDRTeamSchedule("IdTeam")
                        iCurrentTeamLocation = oTeam.id
                        aDatePositions = New Hashtable
                        lPosition = New List(Of Position)
                    Else
                        ' Si no, miro si cambio de fecha ...
                        If dCurrentDate <> oDRTeamSchedule("Date") Then
                            aDatePositions.Add(dCurrentDate.Year.ToString & "-" & dCurrentDate.Month.ToString & "-" & dCurrentDate.Day, lPosition.ToArray)
                            lPosition = New List(Of Position)
                        End If
                    End If
                    dCurrentDate = oDRTeamSchedule("Date")
                    dStartShift = oDRTeamSchedule("Start")
                    dEndShift = oDRTeamSchedule("End")
                    For count As Integer = 1 To oDRTeamSchedule("Quantity")
                        oPosition = New Position
                        oPosition.id = oDRTeamSchedule("IdSlot") & "." & count.ToString
                        oPosition.required = oDRTeamSchedule("Required")
                        oPosition.rol = oDRTeamSchedule("Role")
                        oPosition.slot = New Slot(oDRTeamSchedule("ShiftName"), oDRTeamSchedule("Category"), New DateTime(dCurrentDate.Year, dCurrentDate.Month, dCurrentDate.Day, dStartShift.Hour, dStartShift.Minute, 0, DateTimeKind.Local), New DateTime(dCurrentDate.Year, dCurrentDate.Month, dCurrentDate.Day, dEndShift.Hour, dEndShift.Minute, 0, DateTimeKind.Local), oDRTeamSchedule("ExpectedHours") * 60)
                        oPosition.notCoveredCost = oDRTeamSchedule("NonCoverCost")
                        Try
                            oPosition.location = oDRTeamSchedule("Place")
                        Catch ex As Exception
                            'Do nothing
                        End Try
                        lPosition.Add(oPosition)
                    Next
                End While
                If oTeam IsNot Nothing Then
                    aDatePositions.Add(dCurrentDate.Year.ToString & "-" & dCurrentDate.Month.ToString & "-" & dCurrentDate.Day, lPosition.ToArray)
                    oTeam.datePositions = aDatePositions
                    lTeams.Add(oTeam)
                End If
            End If
            oDRTeamSchedule.Close()

            oScenario.teams = lTeams.ToArray

            Dim str As String
            oRequest.scenarioRequest = oScenario
            str = roJSONHelper.SerializeNewtonSoft(oRequest)
            oledbCommand.Dispose()

        Catch ex As Exception
            MsgBox("Detalle del error: " & ex.Message & vbCrLf, MsgBoxStyle.Critical, "Oops")
        End Try

        Return oRequest
    End Function

    Public Shared Function AvailablePersons(startDate As Date, endDate As Date, _oConn As OleDbConnection) As Integer
        ' 1.- Personas
        Dim strSQL As String = $"   SELECT COUNT(*)
                                        FROM ((((((([Users]
                                        INNER JOIN [Agreements] ON [Agreements].id = [Users].labagree)
                                        LEFT JOIN [Roles] ON [Roles].Id = [Users].Role1)
                                        LEFT JOIN [Roles] AS [Roles2] ON [Roles2].Id = [Users].Role2)
                                        LEFT JOIN [Roles] AS [Roles3] ON [Roles3].Id = [Users].Role3)
                                        LEFT JOIN [Places] ON [Places].Id = [Users].Place1)
                                        LEFT JOIN [Places] AS [Places2] ON [Places2].Id = [Users].Place2)
                                        LEFT JOIN [Places] AS [Places3] ON [Places3].Id = [Users].Place3)
                                        WHERE users.begincontract <= @endDate And (users.endcontract >= @beginDate Or users.endcontract Is null) "
        Dim oledbCommand As New OleDbCommand(strSQL)
        oledbCommand.Connection = _oConn
        If _oConn.State <> ConnectionState.Open Then _oConn.Open()
        Dim oledbParameter1 As New OleDbParameter("@beginDate", OleDbType.Date)
        oledbParameter1.Value = roTypes.Any2Time(startDate).DateOnly
        Dim oledbParameter2 As New OleDbParameter("@endDate", OleDbType.Date)
        oledbParameter2.Value = roTypes.Any2Time(endDate).DateOnly
        oledbCommand.Parameters.Add(oledbParameter1)
        oledbCommand.Parameters.Add(oledbParameter2)
        Return oledbCommand.ExecuteScalar()
    End Function

End Class