@page "/access/status"

@inject IAccessStatusDataSource AccessStatusData
@inject AppUiMessagingService Messaging

<PageTitle>Access Status Monitor</PageTitle>

<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <div>
        <h1 class="h3 mb-0">Access Status Monitor</h1>
        <p class="text-muted mb-0">Reemplaza AccessStatusMonitor.aspx aplicando filtros obligatorios.</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" @onclick="ReloadAsync">
            <i class="bi bi-arrow-repeat"></i> Actualizar
        </button>
    </div>
</div>

<AppDataGrid TItem="AccessStatusListItem"
             Title="Eventos recientes"
             SubTitle="Basado en /access/status (monitor)"
             OnRead="LoadStatus"
             PageSize="12"
             EnableSearch="true"
             FilterDefinitions="@_filters">
    <HeaderTemplate Context="sort">
        <tr>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(AccessStatusListItem.GroupName))">
                    Grupo @SortIcon(sort, nameof(AccessStatusListItem.GroupName))
                </button>
            </th>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(AccessStatusListItem.ZoneName))">
                    Zona @SortIcon(sort, nameof(AccessStatusListItem.ZoneName))
                </button>
            </th>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(AccessStatusListItem.EmployeeName))">
                    Empleado @SortIcon(sort, nameof(AccessStatusListItem.EmployeeName))
                </button>
            </th>
            <th>Status</th>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(AccessStatusListItem.LastEvent))">
                    Último evento @SortIcon(sort, nameof(AccessStatusListItem.LastEvent))
                </button>
            </th>
            <th></th>
        </tr>
    </HeaderTemplate>
    <RowTemplate Context="row">
        <td>@row.GroupName</td>
        <td>@row.ZoneName</td>
        <td>@row.EmployeeName</td>
        <td>
            <span class="@SeverityBadge(row.Severity)">@row.StatusName</span>
            @if (row.RequiresAttention)
            {
                <span class="badge bg-warning-subtle text-warning ms-1">Atención</span>
            }
        </td>
        <td>@row.LastEvent.ToLocalTime().ToString("G")</td>
    </RowTemplate>
    <RowActionsTemplate Context="row">
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" @onclick="() => ShowDetails(row)">Detalle</button>
            <button class="btn btn-outline-danger" @onclick="() => BlockEmployee(row)">Bloquear</button>
        </div>
    </RowActionsTemplate>
</AppDataGrid>

@code {
    private readonly IReadOnlyList<DataGridFilterDefinition> _filters =
        new List<DataGridFilterDefinition>
        {
            new("group", "Grupo", "Ej.: HQ, Operaciones"),
            new("zone", "Zona", "Lobby, Dock, etc."),
            new("severity", "Severidad", "info/warning/error/critical"),
            new("attention", "Sólo atención", "si/no")
        };

    private async Task<DataGridResult<AccessStatusListItem>> LoadStatus(DataGridCriteria criteria)
    {
        var request = BuildRequest(criteria);
        var response = await AccessStatusData.GetAsync(request);
        return new DataGridResult<AccessStatusListItem>(response.Items, response.TotalCount);
    }

    private AccessStatusListRequest BuildRequest(DataGridCriteria criteria)
    {
        string? group = null;
        string? zone = null;
        string? severity = null;
        bool? attention = null;

        if (criteria.Filters is not null)
        {
            criteria.Filters.TryGetValue("group", out group);
            criteria.Filters.TryGetValue("zone", out zone);
            criteria.Filters.TryGetValue("severity", out severity);
            if (criteria.Filters.TryGetValue("attention", out var attentionValue) && !string.IsNullOrWhiteSpace(attentionValue))
            {
                var normalized = attentionValue.Trim().ToLowerInvariant();
                attention = normalized switch
                {
                    "si" or "true" or "1" => true,
                    "no" or "false" or "0" => false,
                    _ => null
                };
            }
        }

        return AccessStatusListRequest.FromCriteria(criteria, group, zone, severity, attention);
    }

    private async Task ReloadAsync() => await InvokeAsync(StateHasChanged);

    private void ShowDetails(AccessStatusListItem row)
    {
        Messaging.ShowToast(new AppToastOptions("Detalle", $"Estado {row.StatusName} para {row.EmployeeName}.", UiNotificationLevel.Info));
    }

    private async Task BlockEmployee(AccessStatusListItem row)
    {
        var confirm = await Messaging.ShowConfirmationAsync(
            "Bloquear empleado",
            $"Bloquear temporalmente a {row.EmployeeName}? (POST /access/status/{row.Id}:block)",
            "Si, bloquear",
            "Cancelar");

        if (confirm is true)
        {
            Messaging.ShowToast(new AppToastOptions("Bloqueado", $"{row.EmployeeName} bloqueado temporalmente.", UiNotificationLevel.Warning));
        }
    }

    private static string SeverityBadge(string severity) => severity.ToLowerInvariant() switch
    {
        "warning" => "badge bg-warning-subtle text-warning",
        "error" => "badge bg-danger-subtle text-danger",
        "critical" => "badge bg-danger",
        _ => "badge bg-success-subtle text-success"
    };

    private static MarkupString SortIcon(DataGridSortState sort, string field)
    {
        if (sort.Field != field)
        {
            return new MarkupString(string.Empty);
        }

        var icon = sort.Descending ? "bi-caret-down-fill" : "bi-caret-up-fill";
        return new MarkupString($"<i class=\"bi {icon} ms-1\"></i>");
    }
}
