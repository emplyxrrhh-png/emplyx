@page "/access/zones"

@inject IAccessZonesDataSource AccessZonesData
@inject AppUiMessagingService Messaging

<PageTitle>Access Zones</PageTitle>

<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <div>
        <h1 class="h3 mb-0">Access Zones</h1>
        <p class="text-muted mb-0">Reemplazo de Access/AccessZones.aspx con filtros y acciones.</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" @onclick="CreateZone">
            <i class="bi bi-plus-circle"></i> Nueva zona
        </button>
        <button class="btn btn-outline-secondary btn-sm" @onclick="ReloadAsync">
            <i class="bi bi-arrow-repeat"></i> Actualizar
        </button>
    </div>
</div>

<AppDataGrid TItem="AccessZoneListItem"
             Title="Zonas de acceso"
             SubTitle="Basado en /access/zones (srvAccessZones.ashx)"
             OnRead="LoadZones"
             PageSize="10"
             EnableSearch="true"
             FilterDefinitions="@_filters">
    <HeaderTemplate Context="sort">
        <tr>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(AccessZoneListItem.Name))">
                    Nombre @SortIcon(sort, nameof(AccessZoneListItem.Name))
                </button>
            </th>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(AccessZoneListItem.Type))">
                    Tipo @SortIcon(sort, nameof(AccessZoneListItem.Type))
                </button>
            </th>
            <th>Padre</th>
            <th>Sensores</th>
            <th>Puertas</th>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(AccessZoneListItem.UpdatedAt))">
                    Actualizado @SortIcon(sort, nameof(AccessZoneListItem.UpdatedAt))
                </button>
            </th>
            <th></th>
        </tr>
    </HeaderTemplate>
    <RowTemplate Context="row">
        <td>
            <div class="fw-semibold">@row.Name</div>
            <small class="text-muted">@row.Description</small>
        </td>
        <td>
            <span class="badge bg-secondary">@row.Type</span>
            @if (row.IsCritical)
            {
                <span class="badge bg-danger ms-1">Critica</span>
            }
        </td>
        <td>@row.ParentName</td>
        <td>@row.SensorsCount</td>
        <td>@row.DoorsCount</td>
        <td>@row.UpdatedAt.ToLocalTime().ToString("g")</td>
    </RowTemplate>
    <RowActionsTemplate Context="row">
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" @onclick="() => ViewZone(row)">Ver</button>
            <button class="btn btn-outline-danger" @onclick="() => DeleteZone(row)">Borrar</button>
        </div>
    </RowActionsTemplate>
</AppDataGrid>

@code {
    private readonly IReadOnlyList<DataGridFilterDefinition> _filters =
        new List<DataGridFilterDefinition>
        {
            new("type", "Tipo", "room/dock/area"),
            new("parent", "Padre", "Ej.: HQ, Operaciones"),
            new("critical", "Critica", "si/no")
        };

    private async Task<DataGridResult<AccessZoneListItem>> LoadZones(DataGridCriteria criteria)
    {
        var request = BuildRequest(criteria);
        var response = await AccessZonesData.GetAsync(request);
        return new DataGridResult<AccessZoneListItem>(response.Items, response.TotalCount);
    }

    private AccessZoneListRequest BuildRequest(DataGridCriteria criteria)
    {
        string? type = null;
        string? parent = null;
        bool? critical = null;

        if (criteria.Filters is not null)
        {
            criteria.Filters.TryGetValue("type", out type);
            criteria.Filters.TryGetValue("parent", out parent);
            if (criteria.Filters.TryGetValue("critical", out var criticalValue) && !string.IsNullOrWhiteSpace(criticalValue))
            {
                var normalized = criticalValue.Trim().ToLowerInvariant();
                critical = normalized switch
                {
                    "si" or "true" or "1" => true,
                    "no" or "false" or "0" => false,
                    _ => null
                };
            }
        }

        return AccessZoneListRequest.FromCriteria(criteria, type, parent, critical);
    }

    private async Task ReloadAsync() => await InvokeAsync(StateHasChanged);

    private void ViewZone(AccessZoneListItem zone) =>
        Messaging.ShowToast(new AppToastOptions("Detalle zona", $"Abrir tabs de {zone.Name}.", UiNotificationLevel.Info));

    private async Task DeleteZone(AccessZoneListItem zone)
    {
        var confirm = await Messaging.ShowConfirmationAsync(
            "Borrar zona",
            $"Eliminar zona {zone.Name}? (DELETE /access/zones/{zone.Id})",
            "Si, borrar",
            "Cancelar");

        if (confirm is true)
        {
            Messaging.ShowToast(new AppToastOptions("Eliminada", $"{zone.Name} marcada para borrado.", UiNotificationLevel.Warning));
        }
    }

    private void CreateZone() =>
        Messaging.ShowToast(new AppToastOptions("Nueva zona", "Abrir wizard AccessZones/New.", UiNotificationLevel.Success));

    private static MarkupString SortIcon(DataGridSortState sort, string field)
    {
        if (sort.Field != field)
        {
            return new MarkupString(string.Empty);
        }

        var icon = sort.Descending ? "bi-caret-down-fill" : "bi-caret-up-fill";
        return new MarkupString($"<i class=\"bi {icon} ms-1\"></i>");
    }
}
