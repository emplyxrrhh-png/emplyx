@page "/scheduler/coverage"

@inject ICoverageSummaryDataSource CoverageData

<PageTitle>Scheduler - Coverage</PageTitle>

<h1 class="h3 mb-3">Coverage Summary</h1>
<p class="text-muted">Replica CalendarV2 (rango fechas + status).</p>

<div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
        <AppDateRangePicker Label="Rango" From="@_fromDateTime" To="@_toDateTime" FromChanged="OnFromChanged" ToChanged="OnToChanged" />
    </div>
    <div class="col-12 col-md-4">
        <AppField Label="Unidad" @bind-Value="_unitFilter" />
    </div>
    <div class="col-12 col-md-4">
        <AppField Label="Status" @bind-Value="_statusFilter" />
    </div>
</div>

<div class="d-flex gap-2 mb-3">
    <button class="btn btn-primary btn-sm" @onclick="LoadAsync">Aplicar</button>
    <button class="btn btn-outline-secondary btn-sm" @onclick="ResetFilters">Limpiar</button>
</div>

@if (_items.Count == 0)
{
    <div class="alert alert-info">No hay datos para el rango seleccionado.</div>
}
else
{
    <div class="row g-3">
        @foreach (var item in _items)
        {
            <div class="col-12 col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">@item.UnitName</h5>
                            <span class="badge @(StatusBadge(item.Status))">@item.Status</span>
                        </div>
                        <p class="text-muted mb-2">@item.Day.ToString("yyyy-MM-dd")</p>
                        <ul class="list-unstyled mb-0">
                            <li><strong>Planned:</strong> @item.PlannedHours.ToString("N0") h</li>
                            <li><strong>Worked:</strong> @item.WorkedHours.ToString("N0") h</li>
                            <li><strong>Coverage:</strong> @item.CoveragePercent.ToString("N1")%</li>
                            <li><strong>Incidents:</strong> @item.Incidents</li>
                        </ul>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private DateOnly _from = DateOnly.FromDateTime(DateTime.Today);
    private DateOnly _to = DateOnly.FromDateTime(DateTime.Today);
    private DateTime? _fromDateTime => _from.ToDateTime(TimeOnly.MinValue);
    private DateTime? _toDateTime => _to.ToDateTime(TimeOnly.MinValue);
    private string? _unitFilter;
    private string? _statusFilter;
    private IReadOnlyList<CoverageSummaryItem> _items = Array.Empty<CoverageSummaryItem>();

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private Task OnFromChanged(DateTime? value)
    {
        if (value.HasValue)
        {
            _from = DateOnly.FromDateTime(value.Value);
        }
        return Task.CompletedTask;
    }

    private Task OnToChanged(DateTime? value)
    {
        if (value.HasValue)
        {
            _to = DateOnly.FromDateTime(value.Value);
        }
        return Task.CompletedTask;
    }

    private async Task LoadAsync()
    {
        _items = await CoverageData.GetAsync(new CoverageSummaryRequest(_from, _to, _unitFilter, _statusFilter));
    }

    private Task ResetFilters()
    {
        _from = DateOnly.FromDateTime(DateTime.Today);
        _to = DateOnly.FromDateTime(DateTime.Today);
        _unitFilter = null;
        _statusFilter = null;
        return LoadAsync();
    }

    private static string StatusBadge(string status) => status.ToLowerInvariant() switch
    {
        "normal" => "badge bg-success-subtle text-success",
        "atención" or "atencion" => "badge bg-warning-subtle text-warning",
        "crítico" or "critico" => "badge bg-danger",
        _ => "badge bg-secondary"
    };
}
