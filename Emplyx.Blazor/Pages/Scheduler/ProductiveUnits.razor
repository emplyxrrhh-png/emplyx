@page "/scheduler/units"

@inject IProductiveUnitsDataSource ProductiveUnitsData
@inject AppUiMessagingService Messaging

<PageTitle>Scheduler - Productive Units</PageTitle>

<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <div>
        <h1 class="h3 mb-0">Productive Units</h1>
        <p class="text-muted mb-0">Replica AIScheduler/ProductiveUnit.aspx con filtros.</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" @onclick="CreateUnit">
            <i class="bi bi-plus-circle"></i> Nueva unidad
        </button>
        <button class="btn btn-outline-secondary btn-sm" @onclick="ReloadAsync">
            <i class="bi bi-arrow-repeat"></i> Actualizar
        </button>
    </div>
</div>

<AppDataGrid TItem="ProductiveUnitListItem"
             Title="Unidades productivas"
             SubTitle="Datos mock basados en srvProductiveUnit.ashx"
             OnRead="LoadUnits"
             PageSize="10"
             EnableSearch="true"
             FilterDefinitions="@_filters">
    <HeaderTemplate Context="sort">
        <tr>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(ProductiveUnitListItem.Name))">
                    Unidad @SortIcon(sort, nameof(ProductiveUnitListItem.Name))
                </button>
            </th>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(ProductiveUnitListItem.Plant))">
                    Planta @SortIcon(sort, nameof(ProductiveUnitListItem.Plant))
                </button>
            </th>
            <th>Responsable</th>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(ProductiveUnitListItem.Status))">
                    Estado @SortIcon(sort, nameof(ProductiveUnitListItem.Status))
                </button>
            </th>
            <th>Budgets</th>
            <th>Empleados</th>
            <th></th>
        </tr>
    </HeaderTemplate>
    <RowTemplate Context="row">
        <td>@row.Name</td>
        <td>@row.Plant</td>
        <td>@row.Manager</td>
        <td>
            <span class="badge @(row.Status.Equals("Activo", StringComparison.OrdinalIgnoreCase) ? "bg-success-subtle text-success" : "bg-secondary")">@row.Status</span>
        </td>
        <td>@row.Budgets</td>
        <td>@row.Employees</td>
    </RowTemplate>
    <RowActionsTemplate Context="row">
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" @onclick="() => ViewUnit(row)">Ver</button>
            <button class="btn btn-outline-danger" @onclick="() => DeleteUnit(row)">Borrar</button>
        </div>
    </RowActionsTemplate>
</AppDataGrid>

@code {
    private readonly IReadOnlyList<DataGridFilterDefinition> _filters =
        new List<DataGridFilterDefinition>
        {
            new("plant", "Planta", "HQ / Operaciones Norte / ..."),
            new("status", "Estado", "Activo/Suspendido"),
            new("manager", "Responsable", "Nombre parcial")
        };

    private async Task<DataGridResult<ProductiveUnitListItem>> LoadUnits(DataGridCriteria criteria)
    {
        var request = BuildRequest(criteria);
        var response = await ProductiveUnitsData.GetAsync(request);
        return new DataGridResult<ProductiveUnitListItem>(response.Items, response.TotalCount);
    }

    private ProductiveUnitListRequest BuildRequest(DataGridCriteria criteria)
    {
        string? plant = null;
        string? status = null;
        string? manager = null;

        if (criteria.Filters is not null)
        {
            criteria.Filters.TryGetValue("plant", out plant);
            criteria.Filters.TryGetValue("status", out status);
            criteria.Filters.TryGetValue("manager", out manager);
        }

        return ProductiveUnitListRequest.FromCriteria(criteria, plant, status, manager);
    }

    private async Task ReloadAsync() => await InvokeAsync(StateHasChanged);

    private void ViewUnit(ProductiveUnitListItem unit) =>
        Messaging.ShowToast(new AppToastOptions("Detalle", $"Abrir tabs para {unit.Name}.", UiNotificationLevel.Info));

    private async Task DeleteUnit(ProductiveUnitListItem unit)
    {
        var confirm = await Messaging.ShowConfirmationAsync(
            "Borrar unidad",
            $"Eliminar {unit.Name}? (DELETE /scheduler/units/{unit.Id})",
            "Si, borrar",
            "Cancelar");

        if (confirm is true)
        {
            Messaging.ShowToast(new AppToastOptions("Eliminada", $"{unit.Name} marcada para borrado.", UiNotificationLevel.Warning));
        }
    }

    private void CreateUnit() =>
        Messaging.ShowToast(new AppToastOptions("Nueva unidad", "Abrir formulario AIScheduler/ProductiveUnit.", UiNotificationLevel.Success));

    private static MarkupString SortIcon(DataGridSortState sort, string field)
    {
        if (sort.Field != field)
        {
            return new MarkupString(string.Empty);
        }

        var icon = sort.Descending ? "bi-caret-down-fill" : "bi-caret-up-fill";
        return new MarkupString($"<i class=\"bi {icon} ms-1\"></i>");
    }
}
