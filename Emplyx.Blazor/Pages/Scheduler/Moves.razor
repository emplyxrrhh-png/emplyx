@page "/scheduler/moves"

@inject IMovesDataSource MovesData
@inject AppUiMessagingService Messaging

<PageTitle>Scheduler - Moves</PageTitle>

<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <div>
        <h1 class="h3 mb-0">Daily Moves</h1>
        <p class="text-muted mb-0">Replica Scheduler/MovesDetail.aspx (srvMoves.ashx).</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" @onclick="ReloadAsync">
            <i class="bi bi-arrow-repeat"></i> Actualizar
        </button>
    </div>
</div>

<AppDataGrid TItem="DailyMoveListItem"
             Title="Movimientos recientes"
             SubTitle="Basado en srvMoves.ashx:getDailyScheduleStatus"
             OnRead="LoadMoves"
             PageSize="12"
             EnableSearch="true"
             FilterDefinitions="@_filters">
    <HeaderTemplate Context="sort">
        <tr>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(DailyMoveListItem.EmployeeName))">
                    Empleado @SortIcon(sort, nameof(DailyMoveListItem.EmployeeName))
                </button>
            </th>
            <th>Terminal</th>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(DailyMoveListItem.Time))">
                    Hora @SortIcon(sort, nameof(DailyMoveListItem.Time))
                </button>
            </th>
            <th>Tipo</th>
            <th>Fuente</th>
            <th>Status</th>
            <th></th>
        </tr>
    </HeaderTemplate>
    <RowTemplate Context="row">
        <td>@row.EmployeeName</td>
        <td>@row.Terminal</td>
        <td>@row.Time.ToLocalTime().ToString("HH:mm")</td>
        <td>@row.Type</td>
        <td>@row.Source</td>
        <td>
            <span class="badge @(row.Status.Equals("Confirmado", StringComparison.OrdinalIgnoreCase) ? "bg-success-subtle text-success" : "bg-warning-subtle text-warning")">@row.Status</span>
            @if (row.RequiresAttention)
            {
                <span class="badge bg-danger ms-1">Atenci√≥n</span>
            }
        </td>
    </RowTemplate>
    <RowActionsTemplate Context="row">
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" @onclick="() => ShowDetails(row)">Detalle</button>
            <button class="btn btn-outline-danger" @onclick="() => DeleteMove(row)">Borrar</button>
        </div>
    </RowActionsTemplate>
</AppDataGrid>

@code {
    private readonly IReadOnlyList<DataGridFilterDefinition> _filters =
        new List<DataGridFilterDefinition>
        {
            new("employee", "Empleado", "Nombre parcial"),
            new("terminal", "Terminal", "HQ, Dock, ..."),
            new("type", "Tipo", "Entrada/Salida/Break"),
            new("status", "Status", "Confirmado/Pendiente/Rechazado")
        };

    private async Task<DataGridResult<DailyMoveListItem>> LoadMoves(DataGridCriteria criteria)
    {
        var request = BuildRequest(criteria);
        var response = await MovesData.GetAsync(request);
        return new DataGridResult<DailyMoveListItem>(response.Items, response.TotalCount);
    }

    private DailyMoveListRequest BuildRequest(DataGridCriteria criteria)
    {
        string? employee = null;
        string? terminal = null;
        string? type = null;
        string? status = null;

        if (criteria.Filters is not null)
        {
            criteria.Filters.TryGetValue("employee", out employee);
            criteria.Filters.TryGetValue("terminal", out terminal);
            criteria.Filters.TryGetValue("type", out type);
            criteria.Filters.TryGetValue("status", out status);
        }

        return DailyMoveListRequest.FromCriteria(criteria, employee, terminal, type, status, null);
    }

    private async Task ReloadAsync() => await InvokeAsync(StateHasChanged);

    private void ShowDetails(DailyMoveListItem move) =>
        Messaging.ShowToast(new AppToastOptions("Detalle movimiento", $"{move.EmployeeName} @ {move.Time.ToLocalTime():HH:mm}.", UiNotificationLevel.Info));

    private async Task DeleteMove(DailyMoveListItem move)
    {
        var confirm = await Messaging.ShowConfirmationAsync(
            "Borrar movimiento",
            $"Borrar movimiento {move.Id}? (DELETE /scheduler/moves/{move.Id})",
            "Si, borrar",
            "Cancelar");

        if (confirm is true)
        {
            Messaging.ShowToast(new AppToastOptions("Eliminado", $"Movimiento {move.Id} eliminado.", UiNotificationLevel.Warning));
        }
    }

    private static MarkupString SortIcon(DataGridSortState sort, string field)
    {
        if (sort.Field != field)
        {
            return new MarkupString(string.Empty);
        }

        var icon = sort.Descending ? "bi-caret-down-fill" : "bi-caret-up-fill";
        return new MarkupString($"<i class=\"bi {icon} ms-1\"></i>");
    }
}
