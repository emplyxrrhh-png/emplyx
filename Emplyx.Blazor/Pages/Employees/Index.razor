@attribute [Emplyx.Blazor.Services.Security.RequirePermission("employees.view")]
@page "/employees"
@using Emplyx.Blazor.Services.Employees
@using Emplyx.Blazor.Services
@using Emplyx.Blazor.Components.Employees
@using Emplyx.Shared.Employees
@using Emplyx.Shared.UI.DataGrid
@using Emplyx.Shared.UI.Selectors
@using Emplyx.Shared.UI.Tasks
@using Emplyx.Shared.UI.Telemetry
@inject Microsoft.Extensions.Localization.IStringLocalizer<Emplyx.Blazor.Resources.SharedResources> L
@inject IEmployeesDataSource EmployeesData
@inject SampleTasksQueueService TasksQueueService
@inject AppUiMessagingService MessagingService
@inject UiTelemetry Telemetry
@inject Emplyx.Blazor.Services.Security.IPermissionService Permissions

<PageTitle>@L["Employees.Title"]</PageTitle>

<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <div>
        <h1 class="h3 mb-0">@L["Employees.Title"]</h1>
        <p class="text-muted mb-0">@L["Employees.Grid.Description"]</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" @onclick="ToggleCreate">
            <i class="bi bi-plus-circle"></i> @L["Employees.New"]
        </button>
        <button class="btn btn-outline-secondary btn-sm" @onclick="ReloadAsync">
            <i class="bi bi-arrow-repeat"></i> @L["Employees.Refresh"]
        </button>
        @if (Permissions.Has("employees.export"))
        {
            <AppDownloadButton Endpoint="employees/export/mock" Label="@L["Employees.Export"]" OnCompleted="OnExportCompleted" />
        }
    </div>
</div>

@if (_showCreate)
{
    <div class="card mb-4">
        <div class="card-body">
            <h2 class="h5 mb-3">@L["Employees.Form.Title"]</h2>
            <EmployeeForm OnSaved="OnEmployeeSaved" OnCancelled="OnEmployeeCancelled" />
        </div>
    </div>
}

<AppDataGrid TItem="EmployeeListItem"
             Title='@L["Employees.Grid.Title"]'
             SubTitle='@L["Employees.Grid.SubTitle"]'
             OnRead="LoadEmployees"
             PageSize="10"
             EnableSearch="true"
             FilterDefinitions="@_filters">
    <HeaderTemplate Context="sort">
        <tr>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(EmployeeListItem.DisplayName))">
                    @L["Employees.Grid.Column.Name"] @SortIcon(sort, nameof(EmployeeListItem.DisplayName))
                </button>
            </th>
            <th>
                <button class="btn btn-link btn-sm p-0" @onclick="() => sort.SortAsync(nameof(EmployeeListItem.PrimaryRole))">
                    @L["Employees.Grid.Column.Role"] @SortIcon(sort, nameof(EmployeeListItem.PrimaryRole))
                </button>
            </th>
            <th>@L["Employees.Grid.Column.Status"]</th>
            <th>@L["Employees.Grid.Column.Code"]</th>
            <th></th>
        </tr>
    </HeaderTemplate>
    <RowTemplate Context="row">
        <td>
            <div class="fw-semibold">@row.DisplayName</div>
            <div class="text-muted small">
                @if (row.Groups.Count == 0)
                {
                    <span class="badge rounded-pill text-bg-light">@L["Employees.EmptyGroup"]</span>
                }
                else
                {
                    @foreach (var group in row.Groups)
                    {
                        <span class="badge rounded-pill text-bg-light me-1 mb-1">@group.Name</span>
                    }
                }
            </div>
        </td>
        <td>@row.PrimaryRole</td>
        <td>
            <span class="badge @(row.Enabled ? "bg-success-subtle text-success" : "bg-secondary")">@row.Status</span>
            @if (row.HasForgottenRight)
            {
                <span class="badge bg-warning-subtle text-warning ms-1">@L["Employees.Badge.Forgotten"]</span>
            }
        </td>
        <td>
            <strong>@row.Code</strong>
            <div class="text-muted text-uppercase small">@row.Language</div>
        </td>
    </RowTemplate>
    <RowActionsTemplate Context="row">
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" @onclick="() => ShowEmployeeToast(row)">@L["Employees.Action.View"]</button>
            <button class="btn btn-outline-danger" @onclick="() => AskDelete(row)">@L["Employees.Action.Delete"]</button>
        </div>
    </RowActionsTemplate>
</AppDataGrid>

<div class="mt-4 row g-3">
    <div class="col-12 col-lg-6">
        <AppSelector TValue="EmployeeLookupItem"
                     Label="@L["Employees.AssignGroup"]"
                     Placeholder="@L["Employees.SearchEmployee"]"
                     Provider="SearchEmployees"
                     LabelSelector="@(item => item.DisplayName)" />
    </div>
    <div class="col-12 col-lg-6">
        <AppTasksQueue Title="@L["Employees.Tasks.Title"]"
                       SubTitle="@L["Employees.Tasks.SubTitle"]"
                       Items="@_tasks"
                       OnRetry="RetryTask" />
    </div>
</div>

@code {
    private List<DataGridFilterDefinition> _filters = new();
    private IReadOnlyList<TaskQueueItem> _tasks = Array.Empty<TaskQueueItem>();
    private string _viewCorrelationId = string.Empty;
    private bool _showCreate = false;

    protected override async Task OnInitializedAsync()
    {
        _viewCorrelationId = Telemetry.NewCorrelationId();
        Telemetry.TrackViewOpened("/employees", _viewCorrelationId);
        _tasks = await TasksQueueService.GetQueueAsync();
        _filters = new List<DataGridFilterDefinition>
        {
            new("module", L["Employees.Filter.Module"], "Ej.: Scheduler, Access"),
            new("status", L["Employees.Filter.Status"], "Activo, Inactivo, Suspendido"),
            new("group", L["Employees.Filter.Group"], "GRP-HQ, Operaciones..."),
            new("forgotten", L["Employees.Filter.Forgotten"], "si/no")
        };
    }

    private async Task<DataGridResult<EmployeeListItem>> LoadEmployees(DataGridCriteria criteria)
    {
        var loadCorrelation = Telemetry.NewCorrelationId();
        Telemetry.TrackDataLoadStarted("employees", "/employees", loadCorrelation);
        var sw = System.Diagnostics.Stopwatch.StartNew();
        try
        {
            var request = BuildRequest(criteria);
            var response = await EmployeesData.GetAsync(request);
            sw.Stop();
            Telemetry.TrackDataLoadCompleted("employees", "/employees", true, sw.ElapsedMilliseconds, loadCorrelation);
            return new DataGridResult<EmployeeListItem>(response.Items, response.TotalCount);
        }
        catch (Exception ex)
        {
            sw.Stop();
            Telemetry.TrackDataLoadCompleted("employees", "/employees", false, sw.ElapsedMilliseconds, loadCorrelation, ex.GetType().Name);
            throw;
        }
    }

    private Task<IReadOnlyList<EmployeeLookupItem>> SearchEmployees(string? term, CancellationToken token) =>
        EmployeesData.SearchAsync(term, token);

    private EmployeeListRequest BuildRequest(DataGridCriteria criteria)
    {
        string? status = null;
        string? module = null;
        string? group = null;
        bool? hasForgotten = null;

        if (criteria.Filters is not null)
        {
            criteria.Filters.TryGetValue("status", out status);
            criteria.Filters.TryGetValue("module", out module);
            criteria.Filters.TryGetValue("group", out group);
            if (criteria.Filters.TryGetValue("forgotten", out var forgotten) && !string.IsNullOrWhiteSpace(forgotten))
            {
                var normalized = forgotten.Trim().ToLowerInvariant();
                hasForgotten = normalized switch
                {
                    "si" or "true" or "1" => true,
                    "no" or "false" or "0" => false,
                    _ => null
                };
            }
        }

        return EmployeeListRequest.FromCriteria(criteria, status, group, module, hasForgotten);
    }

    private async Task ReloadAsync() => await InvokeAsync(StateHasChanged);

    private void ShowEmployeeToast(EmployeeListItem row)
    {
        MessagingService.ShowToast(new AppToastOptions(
            L["Employees.Detail.Title"],
            string.Format(L["Employees.Detail.Message"], row.DisplayName, row.Code),
            UiNotificationLevel.Info));
        Telemetry.TrackActionClicked("view.details", "/employees", _viewCorrelationId);
    }

    private async Task AskDelete(EmployeeListItem row)
    {
        var confirmed = await MessagingService.ShowConfirmationAsync(
            L["Employees.Delete.Confirm.Title"],
            string.Format(L["Employees.Delete.Confirm.Message"], row.DisplayName, row.Id),
            L["Employees.Delete.Confirm.Accept"],
            L["Employees.Delete.Confirm.Cancel"]);

        if (confirmed is true)
        {
            MessagingService.ShowToast(new AppToastOptions(
                L["Employees.Delete.Done.Title"],
                string.Format(L["Employees.Delete.Done.Message"], row.DisplayName),
                UiNotificationLevel.Warning));
            Telemetry.TrackDeleteConfirmed("employee", row.Id.ToString(), "/employees", _viewCorrelationId);
        }
        else
        {
            Telemetry.TrackActionClicked("delete.cancelled", "/employees", _viewCorrelationId, ok: true);
        }
    }

    private async Task RetryTask(TaskQueueItem item)
    {
        MessagingService.ShowToast(new AppToastOptions(
            L["Employees.Tasks.Retry"],
            string.Format(L["Employees.Tasks.Retry.Message"], item.Id),
            UiNotificationLevel.Info));
        Telemetry.TrackActionClicked("task.retry", "/employees", _viewCorrelationId);
        await Task.CompletedTask;
    }

    private void ToggleCreate()
    {
        _showCreate = !_showCreate;
        if (_showCreate)
        {
            Telemetry.TrackActionClicked("employee.create.show", "/employees", _viewCorrelationId);
        }
        else
        {
            Telemetry.TrackActionClicked("employee.create.cancel", "/employees", _viewCorrelationId, ok: true);
        }
    }

    private void OnEmployeeCancelled()
    {
        _showCreate = false;
        Telemetry.TrackActionClicked("employee.create.cancel", "/employees", _viewCorrelationId, ok: true);
    }

    private async Task OnEmployeeSaved(EmployeeEditModel model)
    {
        await EmployeesData.CreateAsync(model);
        MessagingService.ShowToast(new AppToastOptions(
            L["Employees.Save.Done.Title"],
            L["Employees.Save.Done.Message"],
            UiNotificationLevel.Success));
        Telemetry.TrackActionClicked("employee.created", "/employees", _viewCorrelationId);
        _showCreate = false;
        await ReloadAsync();
    }

    private void ShowCreateToast()
    {
        MessagingService.ShowToast(new AppToastOptions(
            L["Employees.Create.Title"],
            L["Employees.Create.Message"],
            UiNotificationLevel.Success));
        Telemetry.TrackActionClicked("employee.create.new", "/employees", _viewCorrelationId);
    }

    private async Task OnExportCompleted(DownloadClient.DownloadResult result)
    {
        Telemetry.TrackDownloadCompleted("employees_export", "mock", "/employees", result.Ok, null, result.CorrelationId, result.ErrorCode);
        if (result.Ok)
        {
            MessagingService.ShowToast(new AppToastOptions(
                L["Employees.Export.Done.Title"],
                L["Employees.Export.Done.Message"],
                UiNotificationLevel.Success));
        }
        else
        {
            MessagingService.ShowToast(new AppToastOptions(
                L["Employees.Export.Error.Title"],
                string.Format(L["Employees.Export.Error.Message"], result.ErrorCode),
                UiNotificationLevel.Danger));
        }
    }

    private static MarkupString SortIcon(DataGridSortState sort, string field)
    {
        if (sort.Field != field)
        {
            return new MarkupString(string.Empty);
        }

        var icon = sort.Descending ? "bi-caret-down-fill" : "bi-caret-up-fill";
        return new MarkupString($"<i class=\"bi {icon} ms-1\"></i>");
    }
}
