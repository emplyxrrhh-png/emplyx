@using Emplyx.Shared.UI.DataGrid
@typeparam TItem

<div class="app-datagrid">
    <div class="app-datagrid__header">
        <div>
            @if (!string.IsNullOrWhiteSpace(Title))
            {
                <h3>@Title</h3>
            }
            @if (!string.IsNullOrWhiteSpace(SubTitle))
            {
                <p class="subtitle">@SubTitle</p>
            }
        </div>
        <div class="app-datagrid__actions">
            @if (FilterDefinitions?.Any() == true)
            {
                <button class="btn btn-outline-secondary btn-sm" @onclick="ToggleFilters">
                    <i class="bi bi-funnel"></i> Filtros
                </button>
            }
            @if (EnableSearch && IsServerMode)
            {
                <input class="form-control form-control-sm"
                       placeholder="Buscar..."
                       value="@_searchText"
                       @onchange="OnSearchChanged" />
            }
            <button class="btn btn-sm btn-outline-secondary" @onclick="ReloadAsync" disabled="@_isLoading">
                <i class="bi bi-arrow-repeat"></i> Actualizar
            </button>
        </div>
    </div>

    @if (_showFilters && FilterDefinitions?.Any() == true)
    {
        <div class="app-datagrid__filters">
            @foreach (var filter in FilterDefinitions)
            {
                <div>
                    <label class="form-label">@filter.Label</label>
                    <input class="form-control form-control-sm"
                           placeholder="@filter.Placeholder"
                           value="@GetFilterValue(filter.Field)"
                           @onchange="args => OnFilterChanged(filter.Field, args.Value?.ToString())" />
                </div>
            }
            <div class="d-flex align-items-end">
                <button class="btn btn-sm btn-primary" @onclick="ApplyFiltersAsync">Aplicar</button>
            </div>
        </div>
    }

    <div class="app-datagrid__toolbar">
        @Toolbar
    </div>

    <div class="table-responsive position-relative">
        <table class="table table-hover align-middle">
            <thead>
                @if (HeaderTemplate is not null)
                {
                    @HeaderTemplate(SortState)
                }
            </thead>
            <tbody>
                @if (_isLoading)
                {
                    <tr>
                        <td colspan="99">
                            <div class="app-datagrid__loading">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span>Cargando...</span>
                            </div>
                        </td>
                    </tr>
                }
                else if (_items.Count == 0)
                {
                    <tr>
                        <td colspan="99" class="text-center text-muted">@EmptyText</td>
                    </tr>
                }
                else
                {
                    @foreach (var item in _items)
                    {
                        <tr>
                            @RowTemplate!(item)
                            @if (RowActionsTemplate is not null)
                            {
                                <td class="text-end">
                                    @RowActionsTemplate(item)
                                </td>
                            }
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (IsServerMode && _totalCount > PageSize)
    {
        <div class="app-datagrid__pager">
            <div class="text-muted">
                Mostrando @(_criteria.PageIndex * PageSize + 1)
                -
                @(Math.Min((_criteria.PageIndex + 1) * PageSize, _totalCount))
                de @_totalCount
            </div>
            <div class="btn-group">
                <button class="btn btn-outline-secondary btn-sm"
                        disabled="@(_criteria.PageIndex == 0 || _isLoading)"
                        @onclick="PreviousPage">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm"
                        disabled="@(_criteria.PageIndex >= _maxPage || _isLoading)"
                        @onclick="NextPage">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    }
</div>

@code {
    private IReadOnlyList<TItem> _items = Array.Empty<TItem>();
    private IReadOnlyList<TItem> _sourceItems = Array.Empty<TItem>();
    private bool _isLoading;
    private int _totalCount;
    private string? _searchText;
    private int _maxPage;
    private DataGridCriteria _criteria = new(0, 10);
    private readonly Dictionary<string, string?> _filterValues = new(StringComparer.OrdinalIgnoreCase);
    private bool _showFilters;

    [Parameter] public string? Title { get; set; }
    [Parameter] public string? SubTitle { get; set; }
    [Parameter] public RenderFragment? Toolbar { get; set; }
    [Parameter] public RenderFragment<DataGridSortState>? HeaderTemplate { get; set; }
    [Parameter] public RenderFragment<TItem>? RowTemplate { get; set; }
    [Parameter] public RenderFragment<TItem>? RowActionsTemplate { get; set; }
    [Parameter] public IEnumerable<TItem>? Items { get; set; }
    [Parameter] public Func<DataGridCriteria, Task<DataGridResult<TItem>>>? OnRead { get; set; }
    [Parameter] public int PageSize { get; set; } = 10;
    [Parameter] public bool AutoLoad { get; set; } = true;
    [Parameter] public string EmptyText { get; set; } = "Sin registros";
    [Parameter] public bool EnableSearch { get; set; } = true;
    [Parameter] public IReadOnlyList<DataGridFilterDefinition>? FilterDefinitions { get; set; }

    private bool IsServerMode => OnRead is not null;

    protected override async Task OnInitializedAsync()
    {
        _criteria = _criteria with { PageSize = PageSize };
        if (IsServerMode && AutoLoad)
        {
            await ReloadAsync();
        }
        else
        {
            LoadFromParameters();
        }
    }

    protected override void OnParametersSet()
    {
        if (FilterDefinitions is not null)
        {
            foreach (var def in FilterDefinitions)
            {
                if (!_filterValues.ContainsKey(def.Field))
                {
                    _filterValues[def.Field] = null;
                }
            }
        }

        if (!IsServerMode)
        {
            LoadFromParameters();
        }
    }

    private void LoadFromParameters()
    {
        _sourceItems = Items?.ToList() ?? (IReadOnlyList<TItem>)Array.Empty<TItem>();
        _items = ApplyLocalTransformations(_sourceItems);
    }

    public async Task ReloadAsync()
    {
        if (!IsServerMode || OnRead is null)
        {
            return;
        }

        _isLoading = true;
        StateHasChanged();

        try
        {
            var result = await OnRead.Invoke(_criteria);
            _items = result.Items;
            _totalCount = result.TotalCount;
            _maxPage = Math.Max(0, (int)Math.Ceiling(_totalCount / (double)PageSize) - 1);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnSearchChanged(ChangeEventArgs args)
    {
        _searchText = args.Value?.ToString();
        _criteria = _criteria with { PageIndex = 0, Search = _searchText };

        if (IsServerMode)
        {
            await ReloadAsync();
        }
        else
        {
            _items = ApplyLocalTransformations(_sourceItems);
            StateHasChanged();
        }
    }

    private async Task NextPage()
    {
        if (_criteria.PageIndex >= _maxPage)
        {
            return;
        }

        _criteria = _criteria with { PageIndex = _criteria.PageIndex + 1 };
        await ReloadAsync();
    }

    private async Task PreviousPage()
    {
        if (_criteria.PageIndex == 0)
        {
            return;
        }

        _criteria = _criteria with { PageIndex = _criteria.PageIndex - 1 };
        await ReloadAsync();
    }

    private DataGridSortState SortState => new(_criteria.SortField, _criteria.SortDescending, SortByAsync);

    private async Task SortByAsync(string field)
    {
        var descending = _criteria.SortField == field ? !_criteria.SortDescending : false;
        _criteria = _criteria with { SortField = field, SortDescending = descending, PageIndex = 0 };

        if (IsServerMode)
        {
            await ReloadAsync();
        }
        else
        {
            _items = ApplyLocalTransformations(_sourceItems);
            StateHasChanged();
        }
    }

    private IReadOnlyList<TItem> ApplyLocalTransformations(IEnumerable<TItem> source)
    {
        var query = source;
        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            query = query.Where(item => item?.ToString()?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false);
        }

        var filtered = query.ToList();
        _totalCount = filtered.Count;

        if (!string.IsNullOrWhiteSpace(_criteria.SortField))
        {
            filtered = SortEnumerable(filtered, _criteria.SortField!, _criteria.SortDescending).ToList();
        }

        if (_criteria.Filters is not null && _criteria.Filters.Count > 0)
        {
            foreach (var filter in _criteria.Filters)
            {
                if (string.IsNullOrWhiteSpace(filter.Value))
                {
                    continue;
                }

                var prop = typeof(TItem).GetProperty(filter.Key);
                if (prop is null)
                {
                    continue;
                }

                filtered = filtered.Where(item =>
                {
                    var val = prop.GetValue(item)?.ToString();
                    return val?.Contains(filter.Value, StringComparison.OrdinalIgnoreCase) ?? false;
                }).ToList();
            }
        }

        return filtered
            .Skip(_criteria.PageIndex * PageSize)
            .Take(PageSize)
            .ToList();
    }

    private IEnumerable<TItem> SortEnumerable(IEnumerable<TItem> source, string field, bool descending)
    {
        var prop = typeof(TItem).GetProperty(field);
        if (prop is null)
        {
            return source;
        }

        return descending
            ? source.OrderByDescending(x => prop.GetValue(x, null))
            : source.OrderBy(x => prop.GetValue(x, null));
    }

    private void ToggleFilters() => _showFilters = !_showFilters;

    private string? GetFilterValue(string field) =>
        _filterValues.TryGetValue(field, out var value) ? value : null;

    private void OnFilterChanged(string field, string? value)
    {
        _filterValues[field] = value;
    }

    private async Task ApplyFiltersAsync()
    {
        var filters = _filterValues
            .Where(kv => !string.IsNullOrWhiteSpace(kv.Value))
            .ToDictionary(kv => kv.Key, kv => kv.Value, StringComparer.OrdinalIgnoreCase);

        _criteria = _criteria with
        {
            PageIndex = 0,
            Filters = filters.Count == 0 ? null : filters
        };

        if (IsServerMode)
        {
            await ReloadAsync();
        }
        else
        {
            _items = ApplyLocalTransformations(_sourceItems);
            StateHasChanged();
        }
    }
}
